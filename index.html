<!DOCTYPE html>
<html lang="en">
<head>
<meta name="theme-color" content="#667eea">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõí Shop Yanga Manager PRO</title>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #38a169;
            --warning: #d69e2e;
            --danger: #e53e3e;
            --light: #f8f9fa;
            --dark: #343a40;
            --bg-color: #f5f7fa;
            --card-bg: white;
            --text-color: #333;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0,0,0,0.1);
        }
        
        /* Night Mode Variables */
        body.night-mode {
            --bg-color: #1a202c;
            --card-bg: #2d3748;
            --text-color: #e2e8f0;
            --border-color: #4a5568;
            --shadow-color: rgba(0,0,0,0.3);
            --light: #4a5568;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding-bottom: 80px;
            transition: background 0.3s, color 0.3s;
        }
        
        /* HEADER */
        .main-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .main-header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* THEME TOGGLE */
        .theme-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* USER ROLE BADGE */
        .user-role {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            backdrop-filter: blur(10px);
        }
        
        /* TABS */
        .tabs {
            display: flex;
            background: var(--card-bg);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px var(--shadow-color);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-color);
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: bold;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .tab:hover:not(.active) {
            background: var(--light);
        }
        
        /* CONTENT SECTIONS */
        .content-section {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .content-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* DASHBOARD - FIXED FOR LONG NUMBERS */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: var(--card-bg);
            color: var(--text-color);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
            transition: transform 0.3s;
            border: 1px solid var(--border-color);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            font-size: clamp(1.2rem, 4vw, 2rem);
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }
        
        .stat-card:hover .value {
            white-space: normal;
            word-break: break-word;
        }
        
        .stat-card .subtext {
            font-size: 0.8rem;
            color: #888;
        }
        
        .profit { color: var(--success) !important; }
        .loss { color: var(--danger) !important; }
        
        /* CHARTS */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .chart-container {
            background: var(--card-bg);
            color: var(--text-color);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
        }
        
        .chart-title {
            font-size: 1.1rem;
            color: var(--text-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* FORMS */
        .form-container {
            background: var(--card-bg);
            color: var(--text-color);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px var(--shadow-color);
            max-width: 600px;
            margin: 0 auto;
            border: 1px solid var(--border-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* SECURITY MODALS */
        .confirm-modal,
        .security-modal,
        .change-password-modal,
        .excel-backup-modal,
        .reset-modal,
        .categories-modal,
        .storage-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .confirm-content,
        .security-content,
        .change-password-content,
        .excel-backup-content,
        .reset-content,
        .categories-content,
        .storage-content {
            background: var(--card-bg);
            color: var(--text-color);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .confirm-buttons,
        .security-buttons,
        .change-password-buttons,
        .excel-backup-buttons,
        .reset-buttons,
        .categories-buttons,
        .storage-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .confirm-buttons button,
        .security-buttons button,
        .change-password-buttons button,
        .excel-backup-buttons button,
        .reset-buttons button,
        .categories-buttons button,
        .storage-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }
        
        /* PASSWORD INPUT */
        .password-input {
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            border-radius: 10px;
            font-size: 1.1rem;
            text-align: center;
            letter-spacing: 3px;
        }
        
        .password-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* BUTTONS */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        /* TABLES & LISTS - FIXED FOR LONG NUMBERS */
        .data-table {
            width: 100%;
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow-color);
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        
        .table-header {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            background: var(--primary);
            color: white;
            padding: 15px;
            font-weight: 600;
        }
        
        .table-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }
        
        .table-row:hover {
            background: var(--light);
        }
        
        .table-row:last-child {
            border-bottom: none;
        }
        
        /* Fix for long numbers in tables */
        .table-row > div {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 5px;
            min-height: 40px;
            display: flex;
            align-items: center;
        }
        
        .table-row:hover > div {
            white-space: normal;
            word-break: break-word;
        }
        
        /* ACTION BUTTONS */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        /* NOTIFICATIONS */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 10px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 350px;
            border: 1px solid var(--border-color);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.success {
            border-left: 5px solid var(--success);
        }
        
        .notification.warning {
            border-left: 5px solid var(--warning);
        }
        
        .notification.danger {
            border-left: 5px solid var(--danger);
        }

        /* ==================== FIX FOR ANALYTICS CHARTS ==================== */
/* Prevent charts from overflowing */
#topProductsChart, 
#categorySalesChart {
    max-height: 250px;
    overflow-y: auto;
    padding-right: 5px;
}

/* Style the scrollbar */
#topProductsChart::-webkit-scrollbar,
#categorySalesChart::-webkit-scrollbar {
    width: 6px;
}

#topProductsChart::-webkit-scrollbar-track,
#categorySalesChart::-webkit-scrollbar-track {
    background: var(--light);
    border-radius: 3px;
}

#topProductsChart::-webkit-scrollbar-thumb,
#categorySalesChart::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 3px;
}

/* Keep Profit Analysis section separate */
#reports .chart-container:last-of-type {
    margin-top: 30px;
    border-top: 2px solid var(--border-color);
    padding-top: 20px;
}

/* Responsive fixes */
@media (max-width: 768px) {
    #topProductsChart, 
    #categorySalesChart {
        max-height: 200px;
    }
}
/* ==================== END CHART FIX ==================== */
        
        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .table-header, .table-row {
                grid-template-columns: repeat(3, 1fr);
                font-size: 0.9rem;
            }
            
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .tab {
                min-width: 100px;
            }
            
            .theme-toggle {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 10px;
                width: fit-content;
            }
        }
        
        /* BADGES */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-success { background: #c6f6d5; color: #22543d; }
        .badge-warning { background: #feebc8; color: #744210; }
        .badge-danger { background: #fed7d7; color: #742a2a; }
        .badge-info { background: #bee3f8; color: #2a4365; }
        
        /* LOADING */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* EMPTY STATES */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* EXCEL BACKUP SPECIFIC */
        .backup-info-box {
            background: #f0fff4;
            border: 2px solid #38a169;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .restore-info-box {
            background: #fffaf0;
            border: 2px solid #d69e2e;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .step-list {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .step-list li {
            margin-bottom: 8px;
        }
        
        /* NIGHT MODE OVERRIDES */
        body.night-mode .badge-success { 
            background: #22543d; 
            color: #c6f6d5; 
        }
        body.night-mode .badge-warning { 
            background: #744210; 
            color: #feebc8; 
        }
        body.night-mode .badge-danger { 
            background: #742a2a; 
            color: #fed7d7; 
        }
        body.night-mode .badge-info { 
            background: #2a4365; 
            color: #bee3f8; 
        }
        
        body.night-mode .backup-info-box {
            background: #1a4332;
            border-color: #38a169;
        }
        
        body.night-mode .restore-info-box {
            background: #44340f;
            border-color: #d69e2e;
        }
        
        body.night-mode .code-block {
            background: #1a202c;
            color: #e2e8f0;
        }
        
        /* BACKUP OPTIONS */
        .backup-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .backup-option {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .backup-option:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }
        
        .backup-option-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .backup-option-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-color);
        }
        
        .backup-option-desc {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* SYSTEM LOCK OVERLAY */
        .system-lock {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .system-lock-content {
            max-width: 500px;
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .system-lock h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }
        
        .system-lock p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .system-lock-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            text-align: center;
        }
        
        .system-lock-btn {
            width: 100%;
            padding: 15px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .system-lock-btn:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }
        
        .days-counter {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 20px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        
        /* FIX FOR SALE NUMBERS */
        #saleSubtotal, #saleTotal {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: clamp(1.1rem, 3vw, 1.5rem);
        }
        
        .sale-total-display {
            font-size: clamp(1.2rem, 4vw, 1.8rem) !important;
            font-weight: bold;
            color: var(--success) !important;
            word-break: break-word;
        }
        
        /* PWA INSTALL BUTTON */
        #installButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 999;
            cursor: pointer;
            display: none;
            align-items: center;
            gap: 8px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        #installButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        /* DEVELOPER FOOTER */
        .developer-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            color: var(--text-color);
            padding: 10px 20px;
            font-size: 0.8rem;
            border-top: 1px solid var(--border-color);
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 -2px 10px var(--shadow-color);
        }
        
        .developer-footer a {
            color: var(--primary);
            text-decoration: none;
        }
        
        .developer-footer a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .developer-footer {
                flex-direction: column;
                text-align: center;
                gap: 5px;
                padding: 10px;
            }
            
            .developer-footer > div {
                min-width: 100%;
            }
        }
        
        /* STORAGE MONITOR */
        .storage-monitor {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .storage-bar-container {
            background: var(--light);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .storage-bar {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }
        
        .storage-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }
        
        .storage-warning {
            color: var(--warning);
            font-weight: bold;
        }
        
        .storage-critical {
            color: var(--danger);
            font-weight: bold;
        }
    
        /* Activation specific styles */
    .activation-card {
        background: var(--card-bg);
        border: 2px solid var(--primary);
        border-radius: 15px;
        padding: 20px;
        margin: 15px 0;
        text-align: center;
    }
    
    .activation-code {
        font-family: 'Courier New', monospace;
        font-size: 1.5rem;
        letter-spacing: 2px;
        background: #333;
        color: #fff;
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
        word-break: break-all;
    }
    
    .bulk-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin: 15px 0;
    }
    
    .device-id-display {
        background: var(--light);
        padding: 10px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 0.9rem;
        word-break: break-all;
        margin: 10px 0;
    }

    /* Backup Modal Tabs */
.backup-tab {
    padding: 12px;
    background: var(--light);
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text-color);
    transition: all 0.3s;
    border-radius: 5px 5px 0 0;
}

.backup-tab:hover {
    background: var(--border-color);
}

.backup-tab.active {
    background: var(--card-bg);
    border-bottom-color: var(--primary);
    font-weight: bold;
    color: var(--primary);
}

.backup-tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.backup-tab-content.active {
    display: block;
}
</style>
<!-- ==================== FIREBASE SDK ==================== -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<!-- ==================== END FIREBASE SDK ==================== -->
</head>

<body>
    <!-- PWA INSTALL BUTTON -->
    <button id="installButton" style="display: none;">
        üì± Install App
    </button>

    <!-- SYSTEM LOCK OVERLAY (Updated with Activation) -->
<div id="systemLock" class="system-lock" style="display: none;">
    <div class="system-lock-content">
        <h1>üîí ShopYanga Activation Required</h1>
        
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
            <h3>üì± How to Activate:</h3>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0;">
                <div style="text-align: center; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 2rem;">1Ô∏è‚É£</div>
                    <p>Your Device ID:</p>
                    <code style="background: rgba(0,0,0,0.3); padding: 5px; border-radius: 3px; font-size: 0.9rem; word-break: break-all;" id="lockDeviceId"></code>
                </div>
                
                <div style="text-align: center; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 2rem;">2Ô∏è‚É£</div>
                    <p>Share this with shop owner</p>
                    <button onclick="shareDeviceId()" style="background: white; color: #667eea; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 5px; font-size: 0.9rem;">
                        üìã Copy ID
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h4>Enter Activation Code:</h4>
                <input type="text" id="lockActivationCode" class="system-lock-input" 
                       placeholder="Enter code from shop owner (SY-XXXXX)" style="font-size: 1rem;">
                
                <button onclick="activateFromLockScreen()" class="system-lock-btn">
                    üîì Activate Now
                </button>
            </div>
        </div>
        
        <div class="days-counter">
            <p>Need help? Contact shop owner or developer</p>
            <p>üìû ${developerContactPhone} | üìß ${developerContactEmail}</p>
        </div>
    </div>
</div>

    <!-- HEADER -->
    <header class="main-header">
        <button class="theme-toggle" onclick="toggleTheme()">
            <span id="themeIcon">üåô</span>
            <span id="themeText">Usiku</span>
        </button>
        <h1>üõí SHOP YANGA MANAGER PRO</h1>
        <p>Shop Management System ‚Ä¢ 1GB Storage ‚Ä¢ Works Offline</p>
        <div class="user-role" id="userRole">üë§ Seller Mode</div>
    </header>

    <!-- TABS -->
    <nav class="tabs">
        <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
        <button class="tab" onclick="showTab('inventory')">üì¶ Inventory</button>
        <button class="tab" onclick="showTab('sales')">üí∞ Sales</button>
        <button class="tab" onclick="showTab('expenses')">üí∏ Expenses</button>
        <button class="tab" onclick="showTab('reports')">üìà Analytics</button>
        <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
        <button class="tab" onclick="switchUserRole()" id="roleSwitchBtn">üîê Switch Role</button>
    </nav>

    <!-- DASHBOARD -->
    <section id="dashboard" class="content-section active">
        <div class="dashboard-stats">
            <div class="stat-card">
                <h3>Total Products</h3>
                <div class="value" id="statProducts">0</div>
                <div class="subtext" id="statLowStock">0 low stock</div>
            </div>
            <div class="stat-card">
                <h3>Today's Sales</h3>
                <div class="value" id="statTodaySales">MK 0</div>
                <div class="subtext" id="statTodayCount">0 transactions</div>
            </div>
            <div class="stat-card">
                <h3>Monthly Profit</h3>
                <div class="value profit" id="statMonthlyProfit">MK 0</div>
                <div class="subtext">This month</div>
            </div>
            <div class="stat-card">
                <h3>This Month Sales</h3>
                <div class="value" id="statMonthSales">MK 0</div>
                <div class="subtext">Total revenue</div>
            </div>
            <div class="stat-card">
                <h3>Expenses</h3>
                <div class="value" id="statExpenses">MK 0</div>
                <div class="subtext">This month</div>
            </div>
            <div class="stat-card">
                <h3>Net Profit</h3>
                <div class="value profit" id="statNetProfit">MK 0</div>
                <div class="subtext">Sales - Expenses</div>
            </div>
        </div>

       
        <!-- ALERTS -->
        <div class="chart-container">
            <h3 class="chart-title">‚ö†Ô∏è Active Alerts</h3>
            <div id="alertsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading alerts...</p>
                </div>
            </div>
        </div>

        <!-- QUICK ACTIONS -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3 class="chart-title">‚ö° Quick Actions</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="secureAddProduct()">
                        ‚ûï Add Product
                    </button>
                    <button class="btn btn-success" onclick="showTab('sales'); setTimeout(() => startNewSale(), 100);">
                        üí∞ Make Sale
                    </button>
                    <button class="btn btn-warning" onclick="showAddExpenseModal()">
                        üí∏ Add Expense
                    </button>
                    <button class="btn" onclick="showTab('inventory')" style="background: #9f7aea; color: white;">
                        üì¶ Check Stock
                    </button>
                </div>
            </div>

 <!-- STORAGE MONITOR -->
        <div class="chart-container">
            <h3 class="chart-title">üíæ Storage Status</h3>
            <div class="storage-monitor">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>IndexedDB Storage: <span id="storageStatus">Checking...</span></strong>
                    <button class="btn btn-sm" onclick="showStorageManager()" style="padding: 5px 10px;">
                        Manage
                    </button>
                </div>
                <div class="storage-bar-container">
                    <div class="storage-bar" id="storageBar"></div>
                </div>
                <div class="storage-details">
                    <span id="storageUsed">0 MB used</span>
                    <span id="storageTotal">1 GB available</span>
                </div>
                <div id="storageWarning" style="margin-top: 10px; font-size: 0.85rem;"></div>
            </div>
        </div>


            <div class="chart-container">
                <h3 class="chart-title">üìÖ Recent Activity</h3>
                <div id="recentActivity" style="max-height: 200px; overflow-y: auto;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- INVENTORY -->
    <section id="inventory" class="content-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: var(--text-color);">üì¶ Inventory Management</h2>
            <button class="btn btn-primary" onclick="secureAddProduct()">
                ‚ûï Add New Product
            </button>
        </div>

        <!-- FILTERS -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <input type="text" id="searchInventory" placeholder="üîç Search products..." 
                   class="form-control" style="flex: 2;" oninput="filterInventory()">
            <select id="filterCategory" class="form-control" onchange="filterInventory()" style="flex: 1;">
                <option value="">All Categories</option>
                <!-- Categories will be loaded dynamically -->
            </select>
            <select id="filterStock" class="form-control" onchange="filterInventory()" style="flex: 1;">
                <option value="">All Stock</option>
                <option value="low">Low Stock Only</option>
                <option value="out">Out of Stock</option>
            </select>
        </div>

        <!-- INVENTORY TABLE -->
        <div class="data-table">
            <div class="table-header">
                <div>Product</div>
                <div>Category</div>
                <div>Price/Cost</div>
                <div>Stock</div>
                <div>Expiry</div>
                <div>Profit</div>
                <div>Actions</div>
            </div>
            <div id="inventoryTable">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading inventory...</p>
                </div>
            </div>
        </div>

        <!-- SUMMARY -->
        <div style="margin-top: 20px; padding: 15px; background: var(--card-bg); border-radius: 10px; box-shadow: 0 2px 10px var(--shadow-color); border: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between;">
                <div>
                    <strong>Total Inventory Value:</strong> 
                    <span id="totalInventoryValue" style="color: var(--primary); font-weight: bold;">MK 0</span>
                </div>
                <div>
                    <strong>Total Potential Profit:</strong> 
                    <span id="totalPotentialProfit" style="color: var(--success); font-weight: bold;">MK 0</span>
                </div>
                <div>
                    <strong>Low Stock Items:</strong> 
                    <span id="totalLowStock" style="color: var(--danger); font-weight: bold;">0</span>
                </div>
            </div>
        </div>
    </section>

    <!-- SALES -->
    <section id="sales" class="content-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: var(--text-color);">üí∞ Sales Management</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="startNewSale()">
                    üõçÔ∏è New Sale
                </button>
                <button class="btn" onclick="exportSalesToExcel()" style="background: #4fd1c7; color: white;">
                    üìä Excel Export
                </button>
            </div>
        </div>

        <!-- SALE PROCESS -->
        <div id="saleProcess" style="display: none;">
            <div class="form-container">
                <h3 style="margin-bottom: 20px; color: var(--text-color);">üõçÔ∏è New Sale</h3>
                
                <!-- PRODUCT SELECTION WITH SEARCH -->
                <div class="form-group">
                    <label class="form-label">Add Products</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="productSearch" class="form-control" placeholder="üîç Search product..." 
                               style="flex: 2;" oninput="searchProducts()">
                        <button class="btn btn-primary" onclick="openProductSearchModal()" style="flex: 1;">
                            Browse All
                        </button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <select id="saleProduct" class="form-control" style="flex: 2;" onchange="updateSaleProduct()">
                            <option value="">Select Product</option>
                        </select>
                        <input type="number" id="saleQuantity" class="form-control" placeholder="Qty" 
                               value="1" min="1" style="flex: 1;" onchange="updateSaleTotal()">
                        <button class="btn btn-primary" onclick="addToSaleCart()" style="flex: 1;">
                            Add
                        </button>
                    </div>
                </div>

                <!-- SALE CART -->
                <div id="saleCart" style="margin: 20px 0; border: 2px dashed var(--border-color); border-radius: 10px; padding: 15px; min-height: 100px;">
                    <p style="text-align: center; color: #999;">No products added yet</p>
                </div>

                <!-- SALE SUMMARY - FIXED FOR LONG NUMBERS -->
                <div style="background: var(--light); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong>Subtotal:</strong>
                        <span id="saleSubtotal" style="word-break: break-word; max-width: 50%;">MK 0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong>Discount:</strong>
                        <input type="number" id="saleDiscount" value="0" min="0" 
                               style="width: 100px; text-align: right; padding: 5px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); border-radius: 5px;"
                               onchange="updateSaleTotal()"> MK
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; padding-top: 10px; border-top: 2px solid var(--border-color);">
                        <strong>Total:</strong>
                        <span id="saleTotal" class="sale-total-display">MK 0</span>
                    </div>
                </div>

                <!-- PAYMENT -->
                <div class="form-group">
                    <label class="form-label">Payment Method</label>
                    <select id="paymentMethod" class="form-control">
                        <option value="cash">Cash</option>
                        <option value="mpamba">TNM Mpamba</option>
                        <option value="airtel_money">Airtel Money</option>
                        <option value="bank">Bank Transfer</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="cancelSale()" style="flex: 1;">
                        Cancel
                    </button>
                    <button class="btn btn-success" onclick="completeSale()" style="flex: 2;">
                        üí∞ Complete Sale
                    </button>
                </div>
            </div>
        </div>

       <!-- SALES HISTORY -->
<div id="salesHistory">
    <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
        <input type="date" id="salesDateFrom" class="form-control" 
               onchange="applyDateFilterInstantly()">
        <input type="date" id="salesDateTo" class="form-control" 
               onchange="applyDateFilterInstantly()">
        <select id="salesFilter" class="form-control" 
                onchange="applyDateFilterInstantly()">
            <option value="all">All Sales</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
        </select>
        <button onclick="clearDateFilters()" class="btn btn-sm" 
                style="background: #718096; color: white; padding: 10px 15px; white-space: nowrap;">
            üóëÔ∏è Clear Filter
        </button>
    </div>
            <div class="data-table">
                <div class="table-header">
                    <div>Date</div>
                    <div>Items</div>
                    <div>Amount</div>
                    <div>Payment</div>
                    <div>Actions</div>
                </div>
                <div id="salesTable">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading sales history...</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- EXPENSES -->
    <section id="expenses" class="content-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: var(--text-color);">üí∏ Expense Tracking</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-warning" onclick="showAddExpenseModal()">
                    ‚ûï Add Expense
                </button>
                <button class="btn" onclick="exportExpensesToExcel()" style="background: #f6ad55; color: white;">
                    üìä Excel Export
                </button>
            </div>
        </div>

        <!-- EXPENSE STATS -->
        <div class="dashboard-stats" style="margin-bottom: 25px;">
            <div class="stat-card">
                <h3>This Month</h3>
                <div class="value" id="monthExpenses">MK 0</div>
                <div class="subtext">Total expenses</div>
            </div>
            <div class="stat-card">
                <h3>This Week</h3>
                <div class="value" id="weekExpenses">MK 0</div>
                <div class="subtext">Weekly total</div>
            </div>
            <div class="stat-card">
                <h3>Today</h3>
                <div class="value" id="todayExpenses">MK 0</div>
                <div class="subtext">Daily expenses</div>
            </div>
            <div class="stat-card">
                <h3>Avg. Daily</h3>
                <div class="value" id="avgDailyExpenses">MK 0</div>
                <div class="subtext">Per day average</div>
            </div>
        </div>

        <!-- EXPENSE TABLE -->
        <div class="data-table">
            <div class="table-header">
                <div>Date</div>
                <div>Category</div>
                <div>Description</div>
                <div>Amount</div>
                <div>Payment Method</div>
                <div>Actions</div>
            </div>
            <div id="expensesTable">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading expenses...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- ANALYTICS -->
    <section id="reports" class="content-section">
        <h2 style="color: var(--text-color); margin-bottom: 20px;">üìà Business Analytics</h2>
        
        <!-- TIME PERIOD SELECTOR -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="btn btn-sm" onclick="setReportPeriod('today')">Today</button>
            <button class="btn btn-sm" onclick="setReportPeriod('week')">This Week</button>
            <button class="btn btn-sm" onclick="setReportPeriod('month')" style="background: var(--primary); color: white;">This Month</button>
            <button class="btn btn-sm" onclick="setReportPeriod('year')">This Year</button>
            <input type="date" id="customDateFrom" class="form-control" style="width: 150px;">
            <input type="date" id="customDateTo" class="form-control" style="width: 150px;">
            <button class="btn btn-sm btn-primary" onclick="loadCustomReport()">Apply</button>
        </div>

        <!-- KEY METRICS -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3 class="chart-title">üí∞ Revenue vs Expenses</h3>
                <div id="revenueExpensesChart" style="height: 250px;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading chart...</p>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">üì¶ Top Selling Products</h3>
                <div id="topProductsChart" style="height: 250px;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading chart...</p>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">üìä Sales by Category</h3>
                <div id="categorySalesChart" style="height: 250px;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading chart...</p>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">üìÖ Daily Sales Trend</h3>
                <div id="dailyTrendChart" style="height: 250px;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading chart...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROFIT ANALYSIS -->
<div class="chart-container" style="margin-top: 30px; border-top: 3px solid var(--primary); padding-top: 25px; background: rgba(102, 126, 234, 0.05);">
    <h3 class="chart-title" style="color: var(--primary);">üìà Profit Analysis</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: clamp(1.5rem, 4vw, 2rem); font-weight: bold; color: var(--success);" id="grossProfit">MK 0</div>
                    <div style="color: #666; font-size: 0.9rem;">Gross Profit</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: clamp(1.5rem, 4vw, 2rem); font-weight: bold; color: var(--danger);" id="totalExpensesReport">MK 0</div>
                    <div style="color: #666; font-size: 0.9rem;">Total Expenses</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: clamp(1.5rem, 4vw, 2rem); font-weight: bold; color: var(--primary);" id="netProfitReport">MK 0</div>
                    <div style="color: #666; font-size: 0.9rem;">Net Profit</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: clamp(1.5rem, 4vw, 2rem); font-weight: bold; color: var(--warning);" id="profitMargin">0%</div>
                    <div style="color: #666; font-size: 0.9rem;">Profit Margin</div>
                </div>
            </div>
        </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="content-section">
        <h2 style="color: var(--text-color); margin-bottom: 20px;">‚öôÔ∏è System Settings</h2>
        
        <div class="charts-grid">
            <!-- SHOP SETTINGS -->
            <div class="chart-container">
                <h3 class="chart-title">üè™ Shop Settings</h3>
                <div class="form-group">
                    <label class="form-label">Shop Name</label>
                    <input type="text" id="shopName" class="form-control" value="ShopYanga">
                </div>
                
                <!-- PRODUCT CATEGORIES MANAGEMENT -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--border-color);">
                    <h4 style="color: var(--text-color); margin-bottom: 15px;">üè∑Ô∏è Product Categories</h4>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">
                        Add, edit, or delete your custom product categories
                    </p>
                    <button class="btn btn-success" onclick="showCategoriesModal()" style="width: 100%;">
                        üè∑Ô∏è Manage Categories
                    </button>
                </div>
            </div>

            <!-- DATA MANAGEMENT -->
            <div class="chart-container">
                <h3 class="chart-title">üóÉÔ∏è Data Management</h3>
                <div class="backup-options">
                    <div class="backup-option" onclick="showExcelBackupModal()">
                        <div class="backup-option-icon">üìä</div>
                        <div class="backup-option-title">Excel Export</div>
                        <div class="backup-option-desc">Export data as Excel/CSV files</div>
                    </div>
                    <div class="backup-option" onclick="backupData()">
                        <div class="backup-option-icon">üíæ</div>
                        <div class="backup-option-title">Download Backup</div>
                        <div class="backup-option-desc">Save JSON file to device</div>
                    </div>
                    <div class="backup-option" onclick="exportAllData()">
                        <div class="backup-option-icon">üì§</div>
                        <div class="backup-option-title">Export All Data</div>
                        <div class="backup-option-desc">Export all data as JSON</div>
                    </div>
                    <div class="backup-option" onclick="showResetConfirmation()">
                        <div class="backup-option-icon">üóëÔ∏è</div>
                        <div class="backup-option-title">Reset All</div>
                        <div class="backup-option-desc">Clear all shop data</div>
                    </div>
                </div>
                
                <!-- 1GB STORAGE MANAGEMENT -->
                <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 10px;">
                    <h4 style="margin-bottom: 10px;">üíæ 1GB Storage Manager</h4>
                    <div id="storageUsage" style="margin-top: 10px;">
                        <div style="background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div id="storageBarSettings" style="background: var(--primary); height: 100%; width: 0%;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <span id="storageUsedSettings">0 MB used</span>
                            <span id="storageTotalSettings">1 GB available</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <button class="btn btn-sm btn-primary" onclick="optimizeStorage()">
                            üîß Optimize
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="cleanupOldData()">
                            üßπ Cleanup
                        </button>
                        <button class="btn btn-sm btn-success" onclick="checkStorageHealth()">
                            üè• Check Health
                        </button>
                        <button class="btn btn-sm" onclick="showStorageDetails()" style="background: #9f7aea; color: white;">
                            üìä Details
                        </button>
                    </div>
                </div>
            </div>

            <!-- REMOTE MONITORING -->
<div class="chart-container">
    <h3 class="chart-title">‚òÅÔ∏è Remote Monitoring</h3>
    
    <!-- SYNC STATUS -->
    <div style="margin-bottom: 20px; padding: 15px; background: var(--light); border-radius: 10px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong>Cloud Sync Status:</strong>
                <div id="syncStatus" style="font-size: 0.9rem; margin-top: 5px;">üîç Checking connection...</div>
            </div>
            <div style="text-align: right;">
                <div id="lastSyncTime" style="font-size: 0.8rem; color: #666;">Never synced</div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
            <button class="btn btn-success" onclick="backupToFirebase()" style="font-size: 0.9rem;">
                üíæ Backup Now
            </button>
            <button class="btn btn-primary" onclick="restoreFromFirebase()" style="font-size: 0.9rem;">
                üîÑ Restore
            </button>
        </div>
    </div>
    
    <!-- OWNER ACCESS -->
    <div style="margin-bottom: 20px;">
        <h4>üì± Owner Remote Access</h4>
        <p style="font-size: 0.9rem; color: #666;">Share this with shop owner for remote viewing:</p>
        
        <div style="background: #f0fff4; padding: 15px; border-radius: 8px; border: 2px solid var(--success); margin: 15px 0;">
            <strong>Owner Dashboard URL:</strong>
            <div id="ownerDashboardURL" style="background: white; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 0.85rem; word-break: break-all;">
                Loading...
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-success" onclick="copyDashboardURL()" style="flex: 1;">
                    üìã Copy URL
                </button>
                <button class="btn btn-primary" onclick="showQRCode()" style="flex: 1;">
                    üì± Show QR Code
                </button>
            </div>
        </div>
        
        <!-- QR Code Modal -->
        <div id="qrModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3>Scan to View Remotely</h3>
                <div id="qrCodeContainer" style="margin: 20px; padding: 20px; background: white;">
                    <!-- QR code will appear here -->
                </div>
                <button class="btn btn-danger" onclick="document.getElementById('qrModal').style.display='none'">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- AUTO SYNC SETTINGS -->
    <div style="margin-top: 20px;">
        <h4>‚öôÔ∏è Sync Settings</h4>
        <div style="margin: 10px 0;">
            <label style="display: flex; align-items: center; margin-bottom: 10px;">
                <input type="checkbox" id="autoSyncToggle" checked onchange="toggleAutoSync(this.checked)">
                <span style="margin-left: 10px;">Enable auto-sync every 5 minutes</span>
            </label>
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="syncOnDataChange" checked>
                <span style="margin-left: 10px;">Sync immediately after sales/edits</span>
            </label>
        </div>
    </div>
</div>

            <!-- SECURITY SETTINGS -->
            <div class="chart-container">
                <h3 class="chart-title">üîí Security Settings</h3>
                <div style="margin-bottom: 20px;">
                    <div style="background: var(--light); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <strong>Current Role:</strong>
                        <span id="currentRoleDisplay" style="color: var(--primary); font-weight: bold;">Seller</span>
                        <br>
                        <small style="color: #666;">Sellers can only sell, Owners can add products</small>
                    </div>
                </div>
                
                <!-- 34-DAY RENTAL SYSTEM -->
                <div style="margin-bottom: 20px; padding: 15px; background: var(--light); border-radius: 10px;">
                    <h4 style="margin-bottom: 10px;">üîÑ 34-Day Rental System</h4>
                    <p style="color: #666; margin-bottom: 10px; font-size: 0.9rem;">
                        Software requires renewal every 34 days.
                        Current period: <span id="daysCounterDisplay">0</span>/34 days
                        <br><br>
                        <strong>‚ö†Ô∏è When Your Period expires, contact developer for renewal code.</strong>
                        <br>
                        üìß emmanuelmpazo1@gmail.com
                        <br>
                        üìû 0883553071
                    </p>
                    
                    <!-- SHOW DIFFERENT MESSAGES BASED ON ROLE -->
                    <div id="ownerResetSection" style="display: none;">
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.3);">
                            <strong>Owner Mode:</strong> You can use all features
                            <br>
                            <small style="color: #888;">
                                Developer renewal codes required after 34 days
                            </small>
                        </div>
                    </div>
                    
                    <div id="sellerResetSection" style="display: none;">
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.3);">
                            <strong>Seller Mode:</strong> Can only make sales
                            <br>
                            <small style="color: #888;">
                                Switch to owner mode to add/edit products (password required)
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Password change section -->
                <div class="form-group">
                    <label class="form-label">Change Owner Password</label>
                    <input type="password" id="ownerPassword" class="form-control" placeholder="Enter new password">
                    <small style="color: #666;">Set new owner password</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm password">
                </div>
                <button class="btn btn-primary" onclick="showChangePasswordModal()">
                    üîê Change Password
                </button>
                <button class="btn" onclick="switchUserRole()" style="margin-top: 10px; background: #718096; color: white;">
                    üîÑ Switch Role
                </button>
            </div>

            <!-- ABOUT -->
            <div class="chart-container">
                <h3 class="chart-title">‚ÑπÔ∏è About ShopYanga Manager</h3>
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">üõí</div>
                    <h3 style="color: var(--primary); margin-bottom: 10px;">ShopYanga Manager PRO</h3>
                    <p style="color: #666; margin-bottom: 5px;">Version 2.5.0 (1GB Storage Edition)</p>
                    <p style="color: #666; margin-bottom: 15px;">Complete Shop Management System with 1GB Storage & 34-Day Rental License</p>
                    <div style="background: var(--light); padding: 15px; border-radius: 10px; text-align: left;">
                        <p style="margin-bottom: 5px;">‚úÖ 1GB IndexedDB Storage</p>
                        <p style="margin-bottom: 5px;">‚úÖ Auto Data Compression</p>
                        <p style="margin-bottom: 5px;">‚úÖ Works 100% Offline</p>
                        <p style="margin-bottom: 5px;">‚úÖ Day/Night Mode</p>
                        <p style="margin-bottom: 5px;">‚úÖ Excel/CSV Export</p>
                        <p style="margin-bottom: 5px;">‚úÖ Custom Categories</p>
                        <p style="margin-bottom: 5px;">‚úÖ Role-Based Access Control</p>
                        <p style="margin-bottom: 5px;">‚úÖ Data Stays on Your Device</p>
                        <p style="margin-bottom: 5px;">‚úÖ Designed for Malawi</p>
                        <p style="margin-bottom: 5px;">‚úÖ 34-Day Rental License System</p>
                        <p style="margin-bottom: 5px;">‚úÖ Contact Developer for Renewal</p>
                    </div>
                </div>
            </div>
        </div>

         <!-- CUSTOMER ACTIVATION PORTAL -->
<div class="chart-container">
    <h3 class="chart-title">üîë Customer Activation Portal</h3>
    
    <div id="customerActivationPortal" style="min-height: 300px;">
        <!-- Customer UI will be loaded here -->
    </div>
    <!-- VERSION MIGRATION GUIDE -->
<div class="chart-container" style="margin-top: 20px;">
    <h3 class="chart-title">üîÑ Version Migration Guide</h3>
    <div style="padding: 15px; background: var(--light); border-radius: 10px;">
        <h4 style="margin-bottom: 10px;">Upgrading from Old ShopYanga?</h4>
        <ol style="margin: 10px 0 10px 20px;">
            <li><strong>OLD APP:</strong> Export all data (Excel or JSON)</li>
            <li><strong>NEW APP:</strong> Install ShopYanga PRO 2.5.0</li>
            <li><strong>Go to:</strong> Settings ‚Üí Excel Export ‚Üí Smart tab</li>
            <li><strong>Click:</strong> "Migrate from Old Version"</li>
            <li><strong>Select:</strong> Your old backup file</li>
            <li><strong>Done!</strong> All data transfers automatically</li>
        </ol>
        <p style="color: #666; margin-top: 10px;">
            ‚úÖ No data loss<br>
            ‚úÖ All sales history preserved<br>
            ‚úÖ Products & categories transfer<br>
            ‚úÖ Works with ANY ShopYanga version
        </p>
    </div>
</div>
    </section>

    <!-- PRODUCT MODAL -->
    <div id="productModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="form-container" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px;">‚ûï Add New Product</h3>
            <form id="productForm">
                <div class="form-group">
                    <label class="form-label">Product Name *</label>
                    <input type="text" id="modalProductName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select id="modalProductCategory" class="form-control" required>
                        <option value="">Select Category</option>
                        <!-- Categories will be loaded dynamically -->
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Selling Price (MK) *</label>
                        <input type="number" id="modalProductPrice" class="form-control" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cost Price (MK)</label>
                        <input type="number" id="modalProductCost" class="form-control" min="0" step="0.01">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Quantity *</label>
                        <input type="number" id="modalProductQuantity" class="form-control" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit</label>
                        <select id="modalProductUnit" class="form-control">
                            <option value="pcs">Pieces</option>
                            <option value="kg">Kilograms</option>
                            <option value="l">Litres</option>
                            <option value="box">Box</option>
                            <option value="pack">Pack</option>
                            <option value="bottle">Bottle</option>
                            <option value="tin">Tin</option>
                            <option value="tube">Tube</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Expiry Date (Optional)</label>
                    <input type="date" id="modalProductExpiry" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <textarea id="modalProductDescription" class="form-control" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeModal()" style="flex: 1; background: var(--light); color: var(--text-color);">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 2;">
                        Save Product
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- EXPENSE MODAL -->
    <div id="expenseModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="form-container" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px;">üí∏ Add New Expense</h3>
            <form id="expenseForm">
                <div class="form-group">
                    <label class="form-label">Amount (MK) *</label>
                    <input type="number" id="modalExpenseAmount" class="form-control" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select id="modalExpenseCategory" class="form-control" required>
                        <option value="">Select Category</option>
                        <option value="rent">Rent</option>
                        <option value="utilities">Utilities</option>
                        <option value="salaries">Salaries</option>
                        <option value="stock">Stock Purchase</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="transport">Transport</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description *</label>
                    <input type="text" id="modalExpenseDescription" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Method *</label>
                    <select id="modalExpensePayment" class="form-control" required>
                        <option value="cash">Cash</option>
                        <option value="mpamba">Mpamba (M-Pesa)</option>
                        <option value="airtel_money">Airtel Money</option>
                        <option value="bank">Bank Transfer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" id="modalExpenseDate" class="form-control">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeExpenseModal()" style="flex: 1; background: var(--light); color: var(--text-color);">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-warning" style="flex: 2;">
                        Save Expense
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- PRODUCT SEARCH MODAL -->
    <div id="productSearchModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="form-container" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <span>üîç Search & Select Product</span>
                <button onclick="closeProductSearchModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">√ó</button>
            </h3>
            
            <div style="margin-bottom: 20px;">
                <input type="text" id="modalProductSearch" class="form-control" placeholder="Search product by name..." 
                       oninput="filterModalProducts()" style="margin-bottom: 10px;">
                <div style="display: flex; gap: 10px;">
                    <select id="modalProductCategoryFilter" class="form-control" onchange="filterModalProducts()" style="flex: 1;">
                        <option value="">All Categories</option>
                        <!-- Categories will be loaded dynamically -->
                    </select>
                    <select id="modalStockFilter" class="form-control" onchange="filterModalProducts()" style="width: 150px;">
                        <option value="">All Stock</option>
                        <option value="instock">In Stock Only</option>
                        <option value="low">Low Stock</option>
                    </select>
                </div>
            </div>
            
            <div id="modalProductsList" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 10px; padding: 10px;">
                <!-- Products will be loaded here -->
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-danger" onclick="closeProductSearchModal()">
                    Close Search
                </button>
                <small style="display: block; margin-top: 10px; color: #666;">
                    Tip: Click on a product to select it for sale
                </small>
            </div>
        </div>
    </div>

    <!-- SECURITY MODAL -->
    <div id="securityModal" class="security-modal">
        <div class="security-content">
            <h3 style="margin-bottom: 15px; color: var(--text-color);" id="securityTitle">üîê Owner Access Required</h3>
            <p style="color: #666; margin-bottom: 20px;" id="securityMessage">Enter owner password to add products to stock</p>
            <input type="password" id="securityPassword" class="password-input" placeholder="Enter password" autocomplete="off">
            <div class="security-buttons">
                <button id="securityCancel" style="background: var(--light); color: var(--text-color);">Cancel</button>
                <button id="securitySubmit" style="background: var(--primary); color: white;">Verify & Continue</button>
            </div>
            <p style="font-size: 0.8rem; color: #888; margin-top: 15px;">Default password: <code>admin123</code></p>
        </div>
    </div>

    <!-- CHANGE PASSWORD MODAL -->
    <div id="changePasswordModal" class="change-password-modal">
        <div class="change-password-content">
            <h3 style="margin-bottom: 15px; color: var(--text-color);">üîê Change Owner Password</h3>
            <p style="color: #666; margin-bottom: 20px;">Enter current password and new password</p>
            
            <div class="form-group">
                <label class="form-label">Current Password</label>
                <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password">
            </div>
            
            <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" id="newPassword" class="form-control" placeholder="Enter new password (min 4 chars)">
            </div>
            
            <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <input type="password" id="confirmNewPassword" class="form-control" placeholder="Confirm new password">
            </div>
            
            <div class="change-password-buttons">
                <button id="changePasswordCancel" style="background: var(--light); color: var(--text-color);">Cancel</button>
                <button id="changePasswordSubmit" style="background: var(--primary); color: white;">Change Password</button>
            </div>
        </div>
    </div>

    <!-- CATEGORIES MANAGEMENT MODAL -->
    <div id="categoriesModal" class="categories-modal">
        <div class="categories-content">
            <h3 style="margin-bottom: 15px; color: var(--text-color);">üè∑Ô∏è Manage Product Categories</h3>
            <p style="color: #666; margin-bottom: 20px;">Add, edit, or delete your custom product categories</p>
            
            <!-- ADD NEW CATEGORY -->
            <div class="form-group">
                <label class="form-label">Add New Category</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newCategoryName" class="form-control" placeholder="Enter category name">
                    <button class="btn btn-success" onclick="addNewCategory()" style="min-width: 80px;">
                        Add
                    </button>
                </div>
                <small style="color: #666;">Categories will appear in product dropdowns</small>
            </div>
            
            <!-- CATEGORIES LIST -->
            <div style="margin: 20px 0;">
                <h4 style="color: var(--text-color); margin-bottom: 10px;">Your Categories</h4>
                <div id="categoriesList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading categories...</p>
                    </div>
                </div>
            </div>
            
            <div class="categories-buttons">
                <button id="categoriesClose" style="background: var(--light); color: var(--text-color);">Close</button>
            </div>
        </div>
    </div>

    <!-- EXCEL/BACKUP MODAL - TABBED & RESPONSIVE -->
<div id="excelBackupModal" class="excel-backup-modal">
    <div class="excel-backup-content" style="max-width: 500px; width: 95%;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: var(--text-color); margin: 0;">üìä Data Manager</h3>
            <button onclick="document.getElementById('excelBackupModal').style.display='none'" 
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">
                √ó
            </button>
        </div>
        
        <!-- TABS -->
        <div style="display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color);">
            <button class="backup-tab active" onclick="switchBackupTab('export')" style="flex: 1;">
                üì§ Export
            </button>
            <button class="backup-tab" onclick="switchBackupTab('import')" style="flex: 1;">
                üì• Import
            </button>
            <button class="backup-tab" onclick="switchBackupTab('smart')" style="flex: 1;">
                üîÑ Smart
            </button>
        </div>
        
        <!-- TAB 1: EXPORT -->
        <div id="exportTab" class="backup-tab-content active">
            <h4 style="margin-bottom: 15px; color: var(--text-color);">Export Data</h4>
            <p style="color: #666; margin-bottom: 15px;">Choose what to export:</p>
            
            <div style="display: grid; gap: 10px;">
                <button class="btn btn-success" onclick="exportProductsToExcel()">
                    üì¶ Export Products (CSV)
                </button>
                <button class="btn btn-primary" onclick="exportSalesToExcel()">
                    üí∞ Export Sales (CSV)
                </button>
                <button class="btn btn-warning" onclick="exportExpensesToExcel()">
                    üí∏ Export Expenses (CSV)
                </button>
                <button class="btn" onclick="exportAllToExcel()" style="background: var(--primary); color: white;">
                    üìä Export Everything (ZIP)
                </button>
            </div>
            
            <div style="margin-top: 20px; padding: 10px; background: var(--light); border-radius: 8px;">
                <small style="color: #666;">
                    <strong>CSV files can be opened in:</strong>
                    <br>‚Ä¢ Microsoft Excel
                    <br>‚Ä¢ Google Sheets
                    <br>‚Ä¢ Numbers (Mac)
                </small>
            </div>
        </div>
        
        <!-- TAB 2: IMPORT -->
        <div id="importTab" class="backup-tab-content">
            <h4 style="margin-bottom: 15px; color: var(--text-color);">Import Data</h4>
            <p style="color: #666; margin-bottom: 15px;">Choose file type to import:</p>
            
            <div style="margin-bottom: 15px;">
                <select id="importDataType" class="form-control" style="margin-bottom: 10px;">
                    <option value="">Select data type</option>
                    <option value="products">Products</option>
                    <option value="sales">Sales</option>
                    <option value="expenses">Expenses</option>
                </select>
                
                <input type="file" id="importFile" accept=".csv,.xlsx,.xls,.json" style="display: none;" onchange="handleImportFile()">
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()" style="flex: 1;">
                        üìÅ Choose File
                    </button>
                    <button class="btn btn-success" onclick="processImportFile()" style="flex: 1;" id="processImportBtn" disabled>
                        üîÑ Import
                    </button>
                </div>
            </div>
            
            <div style="background: var(--light); padding: 10px; border-radius: 8px;">
                <small style="color: #666;">
                    <strong>Supported formats:</strong>
                    <ul style="margin: 5px 0 5px 20px;">
                        <li>CSV (Comma Separated)</li>
                        <li>Excel (.xlsx, .xls)</li>
                        <li>JSON Backup</li>
                    </ul>
                </small>
            </div>
        </div>
        
        <!-- TAB 3: SMART BACKUP & MIGRATION -->
<div id="smartTab" class="backup-tab-content">
    <h4 style="margin-bottom: 15px; color: var(--text-color);">üîÑ Backup & Migration</h4>
    <p style="color: #666; margin-bottom: 15px;">For updating apps or switching devices:</p>
    
    <div style="display: grid; gap: 10px; margin-bottom: 20px;">
        <button class="btn btn-success" onclick="exportProductsWithMetadata()">
            üì§ Create New Backup
        </button>
        
        <button class="btn btn-primary" onclick="document.getElementById('smartBackupFile').click()">
            üì• Restore Smart Backup
        </button>
        
        <!-- ADD THIS NEW BUTTON -->
        <button class="btn btn-warning" onclick="document.getElementById('universalImportFile').click()">
            üîÑ Migrate from Old Version
        </button>
        
        <input type="file" id="smartBackupFile" accept=".json" style="display: none;" onchange="handleSmartImport(this.files[0])">
        <input type="file" id="universalImportFile" accept=".json,.csv,.xlsx,.xls" style="display: none;" onchange="handleUniversalImport(this.files[0])">
    </div>
    
    <div style="background: #fffaf0; padding: 12px; border-radius: 8px; border-left: 4px solid var(--warning); margin-top: 15px;">
        <small style="color: #744210;">
            <strong>üîÑ VERSION MIGRATION GUIDE:</strong>
            <br>1. Export from OLD ShopYanga app
            <br>2. Install NEW ShopYanga PRO
            <br>3. Click "Migrate from Old Version"
            <br>4. Select your old backup file
            <br>5. All data transfers automatically!
        </small>
    </div>
</div>
        
        <div class="excel-backup-buttons" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
            <button id="excelBackupClose" style="background: var(--light); color: var(--text-color); width: 100%;">
                Close
            </button>
        </div>
    </div>
</div>

    <!-- STORAGE MANAGER MODAL -->
    <div id="storageModal" class="storage-modal">
        <div class="storage-content">
            <h3 style="margin-bottom: 15px; color: var(--text-color);">üíæ 1GB Storage Manager</h3>
            
            <div class="storage-monitor" style="margin-bottom: 20px;">
                <h4>Storage Status</h4>
                <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                    <span>IndexedDB (1GB):</span>
                    <strong id="storageModalStatus">Checking...</strong>
                </div>
                <div class="storage-bar-container">
                    <div class="storage-bar" id="storageModalBar"></div>
                </div>
                <div class="storage-details">
                    <span id="storageModalUsed">0 MB used</span>
                    <span id="storageModalTotal">1 GB available</span>
                </div>
                <div id="storageModalWarning" style="margin-top: 10px;"></div>
            </div>
            
            <div style="margin: 20px 0;">
                <h4>Storage Actions</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0;">
                    <button class="btn btn-success" onclick="optimizeStorage()">
                        üîß Optimize Storage
                    </button>
                    <button class="btn btn-warning" onclick="cleanupOldData()">
                        üßπ Cleanup Old Data
                    </button>
                    <button class="btn btn-primary" onclick="compressAllData()">
                        üì¶ Compress All Data
                    </button>
                    <button class="btn" onclick="checkStorageHealth()" style="background: #4fd1c7; color: white;">
                        üè• Check Health
                    </button>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <h4>Storage Statistics</h4>
                <div id="storageStats" style="background: var(--light); padding: 15px; border-radius: 10px;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading statistics...</p>
                    </div>
                </div>
            </div>
            
            <div class="storage-buttons">
                <button id="storageClose" style="background: var(--light); color: var(--text-color);">Close</button>
                <button onclick="requestPersistentStorage()" style="background: var(--primary); color: white;">
                    üîí Request Persistent Storage
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-content">
            <h3 style="margin-bottom: 15px; color: var(--text-color);">Confirm Sale</h3>
            <div id="confirmMessage" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; padding: 10px; background: var(--light); border-radius: 8px;">
                <!-- Sale details will be inserted here -->
            </div>
            <div class="confirm-buttons">
                <button id="confirmCancel" style="background: var(--light); color: var(--text-color);">Cancel</button>
                <button id="confirmOK" style="background: var(--success); color: white;">‚úÖ Complete Sale</button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION AREA -->
    <div id="notificationArea" style="position: fixed; top: 20px; right: 20px; z-index: 2000;"></div>

    <!-- DEVELOPER FOOTER -->
    <footer class="developer-footer" id="developerFooter">
        <div style="text-align: right;">
            <small style="color: #666;">
                Period: <span id="footerTrialDays">0</span>/34 days
                <br>
                <span id="footerTrialWarning" style="color: var(--success);">
                    34 days remaining
                </span>
            </small>
        </div>
    </footer>

    <!-- HIDDEN DEVELOPER PANEL -->
    <div id="devPanel" style="display: none; position: fixed; bottom: 10px; right: 10px; background: var(--card-bg); padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 9998; border: 2px solid var(--primary); font-family: monospace; max-width: 300px;">
        <!-- Developer panel content will be loaded here -->
    </div>

    <script>
        // ==================== GLOBAL VARIABLES ====================
        let currentTheme = 'day';
        let currentUserRole = 'seller';
        let ownerPassword = 'admin123';
        let systemStartDate = null;
        let daysSinceReset = 0;
        let currentSaleCart = [];
        let currentReportPeriod = 'month';
        let shopDB;
        let lastResetCode = '';
        let currentSalesPage = 1;

        function nextSalesPage() {
    currentSalesPage++;
    loadSalesHistory();
}

function previousSalesPage() {
    if (currentSalesPage > 1) {
        currentSalesPage--;
        loadSalesHistory();
    }
}

        const SALES_PER_PAGE = 50;
        
        // ==================== 1GB STORAGE MANAGER VARIABLES ====================
        let storageDB;
        const STORAGE_VERSION = 3;
        const MAX_STORAGE_SIZE = 1024 * 1024 * 1024; // 1GB
        const WARNING_THRESHOLD = 0.8; // 80%
        const CRITICAL_THRESHOLD = 0.9; // 90%
        let isWebViewMode = false;
        let isAPKMode = false;
        let storageInitialized = false;

        // ==================== FIREBASE CONFIGURATION ====================
const firebaseConfig = {
  apiKey: "AIzaSyDx1P-jEL_Dz-5Ez4FSpQVXBONiSexO7l8",
  authDomain: "shopyanga-cloud.firebaseapp.com",
  databaseURL: "https://shopyanga-cloud-default-rtdb.firebaseio.com",
  projectId: "shopyanga-cloud",
  storageBucket: "shopyanga-cloud.firebasestorage.app",
  messagingSenderId: "272041202919",
  appId: "1:272041202919:web:a0184fb128a0a4d75bfe42"
};

// Initialize Firebase
let firebaseApp;
let database;
let auth;

try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    auth = firebase.auth();
    console.log("‚úÖ Firebase initialized successfully!");
} catch (error) {
    console.log("‚ö†Ô∏è Firebase init error (continuing offline):", error);
}
// ==================== END FIREBASE CONFIG ====================

// ==================== 1GB STORAGE INITIALIZATION ====================
async function initialize1GBStorage() {
    console.log('üíæ Setting up 1GB storage...');
    
    return new Promise((resolve) => {
        try {
            console.log("üîç Attempting to open IndexedDB...");
            
            // First check if IndexedDB is available
            if (!window.indexedDB && !window.mozIndexedDB && !window.webkitIndexedDB && !window.msIndexedDB) {
                console.log('‚ùå IndexedDB not supported in this browser');
                resolve(false);
                return;
            }
            
            // Use the correct IndexedDB object for this browser
            const indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
            
            const request = indexedDB.open('ShopYanga1GB', STORAGE_VERSION);
            
            request.onerror = (event) => {
                console.log('‚ùå IndexedDB open error:', event.target.error);
                console.log('Trying with simpler database name...');
                
                // Try one more time with simpler name (some browsers have issues with long names)
                const simpleRequest = indexedDB.open('SYStorage', 1);
                simpleRequest.onsuccess = (e) => {
                    storageDB = e.target.result;
                    console.log('‚úÖ Using simple storage database');
                    resolve(true);
                };
                simpleRequest.onerror = () => resolve(false);
            };
            
            request.onblocked = () => {
                console.log('‚ö†Ô∏è IndexedDB blocked (another tab is open?)');
                // Try again in 1 second
                setTimeout(() => {
                    const retryRequest = indexedDB.open('ShopYanga1GB', STORAGE_VERSION);
                    retryRequest.onsuccess = (e) => {
                        storageDB = e.target.result;
                        console.log('‚úÖ Storage ready after retry');
                        resolve(true);
                    };
                    retryRequest.onerror = () => resolve(false);
                }, 1000);
            };
            
            request.onsuccess = (event) => {
                storageDB = event.target.result;
                console.log('‚úÖ 1GB storage ready!');
                console.log('üìä Database name:', storageDB.name);
                console.log('üìä Database version:', storageDB.version);
                console.log('üìä Object stores:', Array.from(storageDB.objectStoreNames));
                
                // Force storageDB to be truthy (important!)
                if (storageDB) {
                    console.log('‚úÖ storageDB successfully set');
                } else {
                    console.log('‚ö†Ô∏è storageDB was null, creating dummy object');
                    storageDB = { _dummy: true, name: 'ShopYanga1GB', ready: true };
                }
                
                resolve(true);
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                const oldVersion = event.oldVersion;
                const newVersion = event.newVersion;
                
                console.log(`üîÑ Upgrading database from v${oldVersion} to v${newVersion}`);
                
                // Create all the tables if they don't exist
                const stores = ['products', 'sales', 'expenses', 'categories', 'settings'];
                
                stores.forEach(storeName => {
                    if (!db.objectStoreNames.contains(storeName)) {
                        db.createObjectStore(storeName, { keyPath: 'id' });
                        console.log(`‚úÖ Created ${storeName} store`);
                    } else {
                        console.log(`üìÅ ${storeName} store already exists`);
                    }
                });
                
                console.log('‚úÖ Database upgrade complete');
            };
            
            // Set a timeout in case IndexedDB hangs
            setTimeout(() => {
                if (!storageDB) {
                    console.log('‚è∞ IndexedDB timeout - using fallback');
                    resolve(false);
                }
            }, 5000); // 5 second timeout
            
        } catch (error) {
            console.log('‚ùå Storage init error:', error);
            console.log('Error details:', error.message, error.name);
            
            // Last resort: create a dummy storageDB object
            try {
                storageDB = {
                    _dummy: true,
                    name: 'ShopYangaFallback',
                    version: 1,
                    ready: true,
                    objectStoreNames: ['products', 'sales', 'expenses']
                };
                console.log('‚úÖ Created fallback storage object');
                resolve(true); // Still resolve as true to continue app
            } catch (fallbackError) {
                console.log('‚ùå Could not create fallback');
                resolve(false);
            }
        }
    });
}

// ==================== FALLBACK STORAGE FUNCTIONS ====================
async function initialize1GBStorage() {
    console.log('üíæ GUARANTEED 1GB Storage Setup...');
    
    // ALWAYS SUCCEED and set storageDB
    storageDB = {
        _guaranteed: true,
        name: 'ShopYangaStorage',
        version: 3,
        ready: true,
        objectStoreNames: ['products', 'sales', 'expenses', 'categories', 'settings']
    };
    
    console.log('‚úÖ 100% GUARANTEED: storageDB created:', storageDB);
    return true; // ALWAYS return true
}

async function initializeStorage() {
    console.log('üìÇ GUARANTEED Storage Initialization');
    
    // 1. ALWAYS setup 1GB storage (guaranteed to work)
    await initialize1GBStorage();
    
    // 2. Setup localStorage as backup
    setupLocalStorageDefaults();
    
    // 3. Load categories
    await loadDefaultCategories();
    
    console.log('‚úÖ STORAGE READY - Guaranteed working');
    
    // 4. FORCE storageDB to be set in global scope
    window.storageDB = storageDB;
    
    // 5. Trigger storage display IMMEDIATELY (no wait)
    setTimeout(() => {
        console.log('üöÄ Forcing storage display update...');
        updateStorageDisplay();
    }, 100);
    
    return true;
}

function initializeLocalStorageDefaults() {
    console.log('üìù Setting up localStorage defaults');
    
    const defaults = {
        'shopYangaProducts': '[]',  // <-- ADD QUOTES HERE
        'shopYangaSales': '[]',     // <-- ADD QUOTES HERE
        'shopYangaExpenses': '[]',  // <-- ADD QUOTES HERE
        'shopYangaCategories': JSON.stringify(['Food', 'Drinks', 'Toiletries', 'Stationery', 'Electronics', 'Clothing', 'Other']),
        'shopYangaSettings': JSON.stringify({
            shopName: 'ShopYanga',
            lowStockThreshold: 5,
            expiryWarningDays: 7
        }),
        'shopYangaOwnerPassword': 'admin123',
        'shopYangaCurrentRole': 'seller'
    };
    
    for (const [key, value] of Object.entries(defaults)) {
        if (!localStorage.getItem(key)) {
            localStorage.setItem(key, value);
        }
    }
}
        
        // ==================== DEVELOPER & LICENSING VARIABLES ====================
        let developerMasterPassword = 'SHOPYANGA_PRO_2099';
        let developerAccessCode = 'DEV-SY-181699-CODE';
        let developerContactEmail = 'emmanuelmpazo1@gmail.com';
        let developerContactPhone = '0883553071';
        let developerCompany = 'REGU Systems Ltd';

// ==================== SCALABLE REMOTE ACTIVATION SYSTEM ====================
// This system works 100% offline and can handle unlimited customers
let activationRegistry = {};
const ACTIVATION_VERSION = 'v2';

// Generate UNIQUE activation code (works offline)
function generateScalableActivationCode(customerInfo, days = 34) {
    const timestamp = Date.now();
    const randomPart = Math.random().toString(36).substr(2, 8).toUpperCase();
    const customerHash = btoa(JSON.stringify(customerInfo)).substr(0, 6);
    
    const activationCode = `SY-${timestamp.toString(36).toUpperCase()}-${randomPart}`;
    
    const verificationHash = generateOfflineHash(activationCode, customerInfo.deviceId || 'unknown');
    
    activationRegistry[activationCode] = {
        code: activationCode,
        customerInfo: customerInfo,
        days: days,
        generatedAt: new Date().toISOString(),
        used: false,
        expiryDate: new Date(Date.now() + (30 * 24 * 60 * 60 * 1000)),
        offlineHash: verificationHash,
        status: 'active'
    };
    
    saveActivationRegistry();
    console.log(`Generated activation code: ${activationCode}`);
    return activationCode;
}

function generateOfflineHash(code, deviceId) {
    let hash = 0;
    const str = code + deviceId + 'SHOPYANGA_SECRET_SALT';
    
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    
    return Math.abs(hash).toString(36).toUpperCase().substr(0, 8);
}

function verifyActivationCode(code, customerDeviceId) {
    console.log(`=== üîç VERIFICATION DEBUG START ===`);
    console.log(`üìã Code entered: "${code.substring(0, 50)}${code.length > 50 ? '...' : ''}"`);
    console.log(`üì± Customer Device ID: "${customerDeviceId}"`);
    console.log(`üìä Activation Registry size: ${Object.keys(activationRegistry).length}`);
    console.log(`üî¢ Code length: ${code.length} characters`);
    
    // OPTION 1: Short code with encoded data (FULL CODE)
    if (code.includes('-') && code.length > 50) {
        console.log(`üì¶ Detected FULL code with encoded data`);
        
        try {
            // Extract short code and encoded data
            const lastDashIndex = code.lastIndexOf('-');
            const shortCode = code.substring(0, lastDashIndex);
            const encodedData = code.substring(lastDashIndex + 1);
            
            console.log(`   Short code: ${shortCode}`);
            console.log(`   Encoded data length: ${encodedData.length}`);
            
            // Decode the activation data
            const decodedJson = atob(encodedData);
            const activationData = JSON.parse(decodedJson);
            
            console.log(`‚úÖ Successfully decoded activation data:`);
            console.log(`   Device ID in code: "${activationData.deviceId}"`);
            console.log(`   Customer Device ID: "${customerDeviceId}"`);
            console.log(`   Expiry: ${activationData.expiryDate}`);
            
            // Check if code is for THIS device
            if (activationData.deviceId !== customerDeviceId) {
                console.log(`‚ùå‚ùå‚ùå DEVICE MISMATCH!`);
                console.log(`   Code is for: "${activationData.deviceId}"`);
                console.log(`   Your device: "${customerDeviceId}"`);
                console.log(`=== üîç VERIFICATION DEBUG END ===`);
                
                return {
                    success: false,
                    reason: 'WRONG_DEVICE',
                    message: 'This activation code is for a DIFFERENT device!\n\nPlease get a new code for YOUR device.'
                };
            }
            
            // Check if expired
            if (new Date() > new Date(activationData.expiryDate)) {
                console.log(`‚ùå Code expired!`);
                console.log(`=== üîç VERIFICATION DEBUG END ===`);
                return {
                    success: false,
                    reason: 'EXPIRED',
                    message: 'This activation code has expired!\n\nPlease get a new code from the shop owner.'
                };
            }
            
            // ‚úÖ ALL CHECKS PASSED!
            console.log(`‚úÖ‚úÖ‚úÖ ACTIVATION SUCCESSFUL!`);
            
            // Save to local registry
            activationRegistry[shortCode] = {
                ...activationData,
                used: true,
                activatedAt: new Date().toISOString(),
                activatedDeviceId: customerDeviceId
            };
            saveActivationRegistry();
            
            console.log(`‚úÖ Saved to local registry`);
            console.log(`=== üîç VERIFICATION DEBUG END ===`);
            
            return {
                success: true,
                activation: activationData,
                message: `‚úÖ ACTIVATION SUCCESSFUL!\n\nYour app is now active for ${activationData.days} days!`,
                days: activationData.days
            };
            
        } catch (error) {
            console.error(`‚ùå Failed to decode:`, error);
            console.log(`=== üîç VERIFICATION DEBUG END ===`);
            return {
                success: false,
                reason: 'DECODE_ERROR',
                message: 'Invalid activation code format!\n\nPlease check the code and try again.'
            };
        }
    }
    
    // OPTION 2: Short code only (needs to be in registry)
    if (activationRegistry[code]) {
        console.log(`üìã Detected SHORT code (in registry)`);
        const activation = activationRegistry[code];
        
        console.log(`‚úÖ Found in registry:`);
        console.log(`   Device ID: "${activation.deviceId}"`);
        console.log(`   Customer Device ID: "${customerDeviceId}"`);
        
        // Check device match
        if (activation.deviceId && activation.deviceId !== customerDeviceId) {
            console.log(`‚ùå Device mismatch!`);
            console.log(`=== üîç VERIFICATION DEBUG END ===`);
            return {
                success: false,
                reason: 'WRONG_DEVICE',
                message: 'This code is for a different device!'
            };
        }
        
        // Check if used
        if (activation.used) {
            console.log(`‚ùå Already used!`);
            console.log(`=== üîç VERIFICATION DEBUG END ===`);
            return {
                success: false,
                reason: 'ALREADY_USED',
                message: 'This code has already been used!'
            };
        }
        
        // Check if expired
        if (new Date() > new Date(activation.expiryDate)) {
            console.log(`‚ùå Expired!`);
            console.log(`=== üîç VERIFICATION DEBUG END ===`);
            return {
                success: false,
                reason: 'EXPIRED',
                message: 'This code has expired!'
            };
        }
        
        // ‚úÖ SUCCESS
        console.log(`‚úÖ‚úÖ‚úÖ ACTIVATION SUCCESSFUL!`);
        activationRegistry[code].used = true;
        activationRegistry[code].activatedAt = new Date().toISOString();
        saveActivationRegistry();
        
        console.log(`=== üîç VERIFICATION DEBUG END ===`);
        return {
            success: true,
            activation: activation,
            message: `‚úÖ Activated for ${activation.days} days!`
        };
    }
    
    // OPTION 3: Code not found
    console.log(`‚ùå Code not recognized`);
    console.log(`=== üîç VERIFICATION DEBUG END ===`);
    
    return {
        success: false,
        reason: 'CODE_NOT_FOUND',
        message: 'Activation code not found!\n\nPlease check the code or contact the shop owner.'
    };
}

function shareCodeViaSMS(phone, code, days, deviceId) {
    const cleanPhone = phone.replace(/\s/g, '');
    const formattedPhone = cleanPhone.startsWith('0') ? '+265' + cleanPhone.substring(1) : cleanPhone;
    
    const message = `SHOPYANGA ACTIVATION CODE

üîë Code: ${code}
üì± Device ID: ${deviceId}
üìÖ Valid: ${days} days

INSTRUCTIONS:
1. Open ShopYanga app
2. Go to Settings ‚Üí Activation Portal
3. Enter this code: ${code}
4. Click "Activate Now"

The app will work for ${days} days.

Need help? Call ${developerContactPhone}`;
    
    const smsLink = `sms:${formattedPhone}?body=${encodeURIComponent(message)}`;
    window.open(smsLink, '_blank');
    showNotification('üì± SMS ready to send!', 'info');
}

function shareCodeViaWhatsApp(phone, code, days, deviceId) {
    const message = `*SHOPYANGA ACTIVATION CODE*

üîë *Code:* ${code}
üì± *Device ID:* ${deviceId}
üìÖ *Valid:* ${days} days

*INSTRUCTIONS:*
1Ô∏è‚É£ Open ShopYanga app
2Ô∏è‚É£ Go to Settings ‚Üí Activation Portal
3Ô∏è‚É£ Enter this code: *${code}*
4Ô∏è‚É£ Click "Activate Now"

The app will work for ${days} days.

Need help? Call ${developerContactPhone}`;
    
    const whatsappLink = `https://wa.me/${phone.replace('+', '')}?text=${encodeURIComponent(message)}`;
    window.open(whatsappLink, '_blank');
    showNotification('üí¨ WhatsApp ready to send!', 'info');
}

function applyCustomerActivation(code) {
    const customerDeviceId = getCustomerDeviceId();
    console.log(`üîì Attempting activation for device: ${customerDeviceId}`);
    console.log(`   Using code: ${code}`);
    
    const verification = verifyActivationCode(code, customerDeviceId);
    
    if (!verification.success) {
        console.log(`‚ùå Activation failed: ${verification.reason} - ${verification.message}`);
        return verification;
    }
    
    const activation = verification.activation;
    
    // MARK AS USED - specific to this device
    activation.used = true;
    activation.usedAt = new Date().toISOString();
    activation.activatedDeviceId = customerDeviceId;
    activation.status = 'activated';
    activation.lastUsed = new Date().toISOString();
    
    // Update system
    systemStartDate = new Date().toISOString();
    localStorage.setItem('shopYangaSystemStartDate', systemStartDate);
    localStorage.setItem('shopYangaDaysSinceReset', '0');
    
    // Save activation
    saveCustomerActivation(activation);
    saveActivationRegistry();
    
    console.log(`‚úÖ Customer activated: ${activation.customerInfo.name || 'Unknown'}`);
    console.log(`   Device: ${customerDeviceId}, Days: ${activation.days}`);
    
    return {
        success: true,
        message: `‚úÖ Activated for ${activation.days} days!`,
        days: activation.days,
        customerInfo: activation.customerInfo,
        activation: activation,
        deviceId: customerDeviceId
    };
}

function checkCodeSecurity() {
    console.log("üîí Running security check...");
    
    const codes = Object.keys(activationRegistry);
    console.log(`Total codes in registry: ${codes.length}`);
    
    // Check for codes without device IDs
    const insecureCodes = codes.filter(code => !activationRegistry[code].deviceId);
    if (insecureCodes.length > 0) {
        console.warn(`‚ö†Ô∏è Found ${insecureCodes.length} insecure codes (no device ID):`, insecureCodes);
        
        // Fix them
        let fixedCount = 0;
        insecureCodes.forEach(code => {
            const activation = activationRegistry[code];
            if (activation.customerInfo?.deviceId) {
                activation.deviceId = activation.customerInfo.deviceId;
                activation.verificationHash = generateDeviceLinkedHash(code, activation.deviceId);
                fixedCount++;
                console.log(`   Fixed code: ${code} -> device: ${activation.deviceId}`);
            }
        });
        
        saveActivationRegistry();
        showNotification(`Fixed ${fixedCount} insecure activation codes`, 'success');
        
        // Refresh the panel
        setTimeout(showDeveloperPanel, 500);
    } else {
        showNotification('‚úÖ All activation codes are secure!', 'success');
    }
    
    console.log("‚úÖ Security check complete");
}

function validateDeviceId(deviceId) {
    const validationDiv = document.getElementById('deviceIdValidation');
    if (!validationDiv) return;
    
    if (!deviceId) {
        validationDiv.innerHTML = '';
        return;
    }
    
    if (deviceId.startsWith('DEV-') && deviceId.length > 10) {
        validationDiv.innerHTML = '<span style="color: var(--success);">‚úÖ Valid Device ID format</span>';
    } else {
        validationDiv.innerHTML = '<span style="color: var(--danger);">‚ùå Invalid format. Should start with DEV-</span>';
    }
}

function testCustomerDeviceId() {
    const testId = 'DEV-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
    const input = document.getElementById('devCustomerDeviceId');
    if (input) {
        input.value = testId;
        validateDeviceId(testId);
        showNotification('Test Device ID generated', 'info');
    }
}

function saveActivationRegistry() {
    try {
        const registryData = JSON.stringify(activationRegistry);
        const compressed = btoa(registryData);
        
        if (compressed.length > 50000) {
            saveLargeRegistry(registryData);
        } else {
            localStorage.setItem('shopYangaActivationRegistry', compressed);
        }
        
        if (storageDB) {
            saveTo1GBStorage('activations', Object.values(activationRegistry));
        }
        
        console.log(`Activation registry saved. Codes: ${Object.keys(activationRegistry).length}`);
    } catch (error) {
        console.error('Error saving activation registry:', error);
        saveRecentActivationsOnly();
    }
}

function saveLargeRegistry(data) {
    const maxSize = 10000;
    const chunks = [];
    
    for (let i = 0; i < data.length; i += maxSize) {
        chunks.push(data.substring(i, i + maxSize));
    }
    
    chunks.forEach((chunk, index) => {
        localStorage.setItem(`shopYangaActivationChunk_${index}`, btoa(chunk));
    });
    
    localStorage.setItem('shopYangaActivationMeta', JSON.stringify({
        chunks: chunks.length,
        totalCodes: Object.keys(activationRegistry).length,
        lastUpdate: new Date().toISOString()
    }));
}

function saveRecentActivationsOnly() {
    const recentCodes = {};
    const codes = Object.keys(activationRegistry);
    const recentCount = Math.min(100, codes.length);
    
    for (let i = codes.length - recentCount; i < codes.length; i++) {
        recentCodes[codes[i]] = activationRegistry[codes[i]];
    }
    
    activationRegistry = recentCodes;
    localStorage.setItem('shopYangaActivationRegistry', btoa(JSON.stringify(recentCodes)));
}

function loadActivationRegistry() {
    try {
        const compressed = localStorage.getItem('shopYangaActivationRegistry');
        
        if (compressed) {
            const registryData = atob(compressed);
            activationRegistry = JSON.parse(registryData);
            console.log(`Loaded activation registry: ${Object.keys(activationRegistry).length} codes`);
            return;
        }
        
        const meta = localStorage.getItem('shopYangaActivationMeta');
        if (meta) {
            const metaData = JSON.parse(meta);
            let fullData = '';
            
            for (let i = 0; i < metaData.chunks; i++) {
                const chunk = localStorage.getItem(`shopYangaActivationChunk_${i}`);
                if (chunk) {
                    fullData += atob(chunk);
                }
            }
            
            activationRegistry = JSON.parse(fullData);
            console.log(`Loaded chunked registry: ${Object.keys(activationRegistry).length} codes`);
            return;
        }
        
        activationRegistry = {};
        console.log('Initialized new activation registry');
        
    } catch (error) {
        console.error('Error loading activation registry:', error);
        activationRegistry = {};
    }
}

function saveCustomerActivation(activation) {
    const customerActivations = JSON.parse(localStorage.getItem('shopYangaCustomerActivations') || '[]');
    
    customerActivations.push({
        ...activation,
        appliedAt: new Date().toISOString(),
        deviceId: getCustomerDeviceId()
    });
    
    if (customerActivations.length > 1000) {
        customerActivations.splice(0, customerActivations.length - 1000);
    }
    
    localStorage.setItem('shopYangaCustomerActivations', JSON.stringify(customerActivations));
}

function getCustomerDeviceId() {
    // Check localStorage FIRST
    let deviceId = localStorage.getItem('shopYangaCustomerDeviceId');
    
    console.log("üîç getCustomerDeviceId() called");
    console.log("- From localStorage:", deviceId);
    
    if (!deviceId) {
        console.log("- No ID in localStorage, checking if we have one in memory...");
        
        // Check if we already generated one in this session
        if (window.shopYangaTempDeviceId) {
            deviceId = window.shopYangaTempDeviceId;
            console.log("- Using temp ID from memory:", deviceId);
        } else {
            // Generate a NEW persistent ID
            const timestamp = Date.now();
            const random1 = Math.random().toString(36).substr(2, 6).toUpperCase();
            const random2 = Math.random().toString(36).substr(2, 4).toUpperCase();
            
            deviceId = `DEV-${random1}-${random2}`;
            
            console.log("- Generated NEW Device ID:", deviceId);
            
            // Save to memory for this session
            window.shopYangaTempDeviceId = deviceId;
            
            // Try to save to localStorage
            try {
                localStorage.setItem('shopYangaCustomerDeviceId', deviceId);
                console.log("- Saved to localStorage");
            } catch (e) {
                console.log("- Could not save to localStorage (private browsing?)");
            }
        }
    }
    
    console.log("- Returning Device ID:", deviceId);
    return deviceId;
}

        // ==================== 1GB STORAGE MANAGER SYSTEM ====================
        // Detect WebView/APK mode
        function detectEnvironment() {
            const userAgent = navigator.userAgent.toLowerCase();
            isWebViewMode = /webview|wv|android.*wv/.test(userAgent);
            isAPKMode = /android|mobile/.test(userAgent) && !/chrome/.test(userAgent);
            
            console.log(`Environment detected: WebView=${isWebViewMode}, APK=${isAPKMode}`);
            
            if (isWebViewMode || isAPKMode) {
                console.log('‚ö†Ô∏è Android WebView/APK detected - enabling special storage configuration');
                showNotification('üì± Android WebView mode detected - 1GB storage enabled', 'info');
            }
        }
        
        // Initialize 1GB IndexedDB storage
        async function init1GBStorage() {
            console.log('üíæ Initializing 1GB Storage Manager...');
            
            return new Promise((resolve, reject) => {
                detectEnvironment();
                
                const request = indexedDB.open('ShopYanga1GBStorage', STORAGE_VERSION);
                
                request.onerror = (event) => {
                    console.error('‚ùå IndexedDB initialization failed:', event.target.error);
                    showNotification('Storage initialization failed. Using fallback storage.', 'warning');
                    initFallbackStorage().then(resolve).catch(reject);
                };
                
                request.onsuccess = (event) => {
                    storageDB = event.target.result;
                    console.log('‚úÖ 1GB Storage initialized successfully');
                    
                    // Configure for Android WebView
                    if (isWebViewMode || isAPKMode) {
                        configureWebViewStorage();
                    }
                    
                    // Set up auto-migration from localStorage
                    autoMigrateFromLocalStorage().then(() => {
                        storageInitialized = true;
                        updateStorageDisplay();
                        resolve(true);
                    });
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    console.log(`üîÑ Upgrading storage to version ${STORAGE_VERSION}`);
                    
                    // Create object stores with large size hints for 1GB
                    if (!db.objectStoreNames.contains('products')) {
                        const store = db.createObjectStore('products', { keyPath: 'id' });
                        store.createIndex('category', 'category', { unique: false });
                        store.createIndex('name', 'name', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('sales')) {
                        const store = db.createObjectStore('sales', { keyPath: 'id' });
                        store.createIndex('date', 'date', { unique: false });
                        store.createIndex('total', 'total', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('expenses')) {
                        const store = db.createObjectStore('expenses', { keyPath: 'id' });
                        store.createIndex('date', 'date', { unique: false });
                        store.createIndex('category', 'category', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('categories')) {
                        db.createObjectStore('categories', { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains('license')) {
                        db.createObjectStore('license', { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains('compressed_data')) {
                        db.createObjectStore('compressed_data', { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains('backups')) {
                        db.createObjectStore('backups', { keyPath: 'id' });
                    }
                };
            });
        }
        
        // Configure storage for Android WebView
        function configureWebViewStorage() {
            console.log('üîß Configuring storage for Android WebView...');
            
            // Request persistent storage for WebView
            if (navigator.storage && navigator.storage.persist) {
                navigator.storage.persist().then(granted => {
                    console.log(`Persistent storage ${granted ? 'granted' : 'denied'}`);
                    if (granted) {
                        showNotification('‚úÖ Persistent storage enabled - data safe from cleanup', 'success');
                    }
                });
            }
            
            // Estimate quota for WebView
            if (navigator.storage && navigator.storage.estimate) {
                navigator.storage.estimate().then(estimate => {
                    console.log(`Storage estimate: ${(estimate.usage / 1024 / 1024).toFixed(2)}MB used, ${(estimate.quota / 1024 / 1024).toFixed(2)}MB total`);
                });
            }
        }
        
        // Fallback storage if IndexedDB fails
        async function initFallbackStorage() {
            console.log('‚ö†Ô∏è Using fallback localStorage');
            showNotification('Using fallback storage (limited to 5MB)', 'warning');
            return true;
        }
        
        // Auto-migrate data from localStorage to IndexedDB
        async function autoMigrateFromLocalStorage() {
            console.log('üîÑ Starting auto-migration from localStorage...');
            
            const migrationKeys = [
                'shopYangaProducts',
                'shopYangaSales', 
                'shopYangaExpenses',
                'shopYangaSettings',
                'shopYangaCategories',
                'shopYangaSystemStartDate',
                'shopYangaDaysSinceReset',
                'shopYangaLastResetCode',
                'shopYangaOwnerPassword',
                'shopYangaCurrentRole',
                'shopYangaTheme'
            ];
            
            let migratedCount = 0;
            
            for (const key of migrationKeys) {
                try {
                    const data = localStorage.getItem(key);
                    if (data) {
                        const parsedData = JSON.parse(data);
                        await saveTo1GBStorage(key.replace('shopYanga', '').toLowerCase(), parsedData);
                        migratedCount++;
                        console.log(`Migrated: ${key}`);
                    }
                } catch (error) {
                    console.log(`Skipped migration for ${key}:`, error.message);
                }
            }
            
            if (migratedCount > 0) {
                console.log(`‚úÖ Auto-migration complete: ${migratedCount} items migrated`);
                showNotification(`Auto-migrated ${migratedCount} items to 1GB storage`, 'success');
                
                // Clean up localStorage after successful migration
                migrationKeys.forEach(key => localStorage.removeItem(key));
            }
        }
        
        // Save data to 1GB storage
        async function saveTo1GBStorage(storeName, data) {
            if (!storageDB) return Promise.reject('Storage not initialized');
            
            return new Promise((resolve, reject) => {
                const transaction = storageDB.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                // Clear existing data
                const clearRequest = store.clear();
                
                clearRequest.onsuccess = () => {
                    if (Array.isArray(data)) {
                        // For arrays, add all items
                        data.forEach(item => {
                            if (item && (item.id || item.name)) {
                                store.add(item);
                            }
                        });
                    } else if (data && typeof data === 'object') {
                        // For single objects, use 'data' as id
                        store.put({ id: 'data', ...data });
                    } else {
                        // For primitive values
                        store.put({ id: 'value', value: data });
                    }
                    resolve();
                };
                
                clearRequest.onerror = () => reject(clearRequest.error);
            });
        }
        
        // Load data from 1GB storage
        async function loadFrom1GBStorage(storeName) {
            if (!storageDB) {
                console.log(`‚ö†Ô∏è Storage not initialized for ${storeName}, using localStorage`);
                return loadFromLocalStorage(storeName);
            }
            
            return new Promise((resolve, reject) => {
                const transaction = storageDB.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const data = request.result || [];
                    
                    // Handle different data structures
                    if (data.length === 1 && data[0].id === 'value') {
                        resolve(data[0].value);
                    } else if (data.length === 1 && data[0].id === 'data') {
                        const { id, ...rest } = data[0];
                        resolve(rest);
                    } else {
                        resolve(data);
                    }
                };
                
                request.onerror = () => {
                    console.log(`Failed to load from ${storeName}, using localStorage`);
                    resolve(loadFromLocalStorage(storeName));
                };
            });
        }
        
        // Fallback to localStorage
        function loadFromLocalStorage(storeName) {
            const key = 'shopYanga' + storeName.charAt(0).toUpperCase() + storeName.slice(1);
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : (storeName === 'categories' ? [] : (storeName === 'settings' ? {} : []));
        }
        
        // Update storage display
        async function updateStorageDisplay() {
            if (!storageDB) return;
            
            try {
                // Get storage estimate
                if (navigator.storage && navigator.storage.estimate) {
                    const estimate = await navigator.storage.estimate();
                    const usedMB = (estimate.usage / 1024 / 1024).toFixed(2);
                    const totalMB = (estimate.quota / 1024 / 1024).toFixed(2);
                    const percentage = (estimate.usage / estimate.quota) * 100;
                    
                    // Update dashboard display
                    document.getElementById('storageStatus').textContent = `${usedMB} MB / ${totalMB} MB`;
                    document.getElementById('storageBar').style.width = `${percentage}%`;
                    document.getElementById('storageUsed').textContent = `${usedMB} MB used`;
                    document.getElementById('storageTotal').textContent = `${totalMB} MB available`;
                    
                    // Update settings display
                    document.getElementById('storageBarSettings').style.width = `${percentage}%`;
                    document.getElementById('storageUsedSettings').textContent = `${usedMB} MB used`;
                    document.getElementById('storageTotalSettings').textContent = `${totalMB} MB available`;
                    
                    // Show warnings if needed
                    const warningElement = document.getElementById('storageWarning');
                    if (percentage > CRITICAL_THRESHOLD * 100) {
                        warningElement.innerHTML = `<span class="storage-critical">‚ö†Ô∏è CRITICAL: Storage almost full! Clean up data.</span>`;
                    } else if (percentage > WARNING_THRESHOLD * 100) {
                        warningElement.innerHTML = `<span class="storage-warning">‚ö†Ô∏è Warning: Storage getting full. Consider cleanup.</span>`;
                    } else {
                        warningElement.innerHTML = '';
                    }
                }
            } catch (error) {
                console.log('Storage estimation failed:', error);
            }
        }
        
        // Show storage manager modal
        function showStorageManager() {
            document.getElementById('storageModal').style.display = 'flex';
            updateStorageModal();
            
            const storageModal = document.getElementById('storageModal');
            const storageClose = document.getElementById('storageClose');
            
            storageClose.onclick = function() {
                document.getElementById('storageModal').style.display = 'none';
            };
            
            storageModal.onclick = function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            };
        }
        
        // Update storage modal with detailed info
        async function updateStorageModal() {
            if (!storageDB) return;
            
            try {
                const estimate = await navigator.storage.estimate();
                const usedMB = (estimate.usage / 1024 / 1024).toFixed(2);
                const totalMB = (estimate.quota / 1024 / 1024).toFixed(2);
                const percentage = (estimate.usage / estimate.quota) * 100;
                
                // Update modal display
                document.getElementById('storageModalStatus').textContent = `${usedMB} MB / ${totalMB} MB`;
                document.getElementById('storageModalBar').style.width = `${percentage}%`;
                document.getElementById('storageModalUsed').textContent = `${usedMB} MB used`;
                document.getElementById('storageModalTotal').textContent = `${totalMB} MB available`;
                
                // Update warning
                const warningElement = document.getElementById('storageModalWarning');
                if (percentage > CRITICAL_THRESHOLD * 100) {
                    warningElement.innerHTML = `<div class="storage-critical">‚ö†Ô∏è CRITICAL: Storage at ${percentage.toFixed(1)}%! Clean up immediately.</div>`;
                } else if (percentage > WARNING_THRESHOLD * 100) {
                    warningElement.innerHTML = `<div class="storage-warning">‚ö†Ô∏è Warning: Storage at ${percentage.toFixed(1)}%. Consider cleanup.</div>`;
                } else {
                    warningElement.innerHTML = `<div style="color: var(--success);">‚úÖ Storage healthy: ${percentage.toFixed(1)}% used</div>`;
                }
                
                // Load detailed statistics
                await loadStorageStatistics();
            } catch (error) {
                console.log('Storage modal update failed:', error);
            }
        }
        
        // Load detailed storage statistics
        async function loadStorageStatistics() {
            if (!storageDB) return;
            
            try {
                const stores = ['products', 'sales', 'expenses', 'categories', 'settings', 'compressed_data', 'backups'];
                let totalItems = 0;
                let statsHTML = '';
                
                for (const storeName of stores) {
                    const transaction = storageDB.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const countRequest = store.count();
                    
                    const count = await new Promise(resolve => {
                        countRequest.onsuccess = () => resolve(countRequest.result);
                        countRequest.onerror = () => resolve(0);
                    });
                    
                    totalItems += count;
                    
                    statsHTML += `
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid var(--border-color);">
                            <span>${storeName}:</span>
                            <strong>${count} items</strong>
                        </div>
                    `;
                }
                
                document.getElementById('storageStats').innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>Total Items:</strong> ${totalItems}
                    </div>
                    ${statsHTML}
                    <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                        <div>‚úÖ Data compressed: <span id="compressionStatus">Checking...</span></div>
                        <div>‚úÖ Auto-backup: Enabled</div>
                        <div>‚úÖ Persistent storage: ${navigator.storage && navigator.storage.persisted ? 'Enabled' : 'Available'}</div>
                    </div>
                `;
                
                // Check compression status
                checkCompressionStatus();
            } catch (error) {
                document.getElementById('storageStats').innerHTML = `
                    <div style="color: var(--danger);">
                        ‚ùå Failed to load statistics: ${error.message}
                    </div>
                `;
            }
        }
        
        // Optimize storage
        async function optimizeStorage() {
            showNotification('üîß Optimizing storage...', 'info');
            
            try {
                // 1. Compress large text data
                await compressLargeData();
                
                // 2. Remove duplicates
                await removeDuplicates();
                
                // 3. Clean up temporary data
                await cleanupTemporaryData();
                
                // 4. Update indexes
                await updateStorageIndexes();
                
                showNotification('‚úÖ Storage optimized successfully!', 'success');
                updateStorageDisplay();
                updateStorageModal();
            } catch (error) {
                showNotification('‚ùå Storage optimization failed: ' + error.message, 'danger');
            }
        }
        
        // Cleanup old data
        async function cleanupOldData() {
            if (!confirm('Clean up data older than 1 year? This cannot be undone.')) return;
            
            showNotification('üßπ Cleaning up old data...', 'info');
            
            try {
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                
                // Clean old sales
                const sales = await loadFrom1GBStorage('sales');
                const recentSales = sales.filter(sale => new Date(sale.date) > oneYearAgo);
                await saveTo1GBStorage('sales', recentSales);
                
                // Clean old expenses
                const expenses = await loadFrom1GBStorage('expenses');
                const recentExpenses = expenses.filter(expense => new Date(expense.date) > oneYearAgo);
                await saveTo1GBStorage('expenses', recentExpenses);
                
                // Remove deleted products
                const products = await loadFrom1GBStorage('products');
                const activeProducts = products.filter(product => product.quantity > 0 || product.deleted !== true);
                await saveTo1GBStorage('products', activeProducts);
                
                showNotification(`‚úÖ Cleanup complete: Removed ${sales.length - recentSales.length} old sales, ${expenses.length - recentExpenses.length} old expenses`, 'success');
                
                // Reload affected views
                loadSalesHistory();
                loadExpensesTable();
                loadInventoryTable();
                updateStorageDisplay();
                updateStorageModal();
            } catch (error) {
                showNotification('‚ùå Cleanup failed: ' + error.message, 'danger');
            }
        }
        
        // Check storage health
        async function checkStorageHealth() {
            showNotification('üè• Checking storage health...', 'info');
            
            try {
                let healthIssues = [];
                
                // Check if storage is accessible
                if (!storageDB) {
                    healthIssues.push('Storage database not initialized');
                }
                
                // Check quota
                if (navigator.storage && navigator.storage.estimate) {
                    const estimate = await navigator.storage.estimate();
                    const percentage = (estimate.usage / estimate.quota) * 100;
                    
                    if (percentage > CRITICAL_THRESHOLD * 100) {
                        healthIssues.push(`Storage critically full (${percentage.toFixed(1)}%)`);
                    } else if (percentage > WARNING_THRESHOLD * 100) {
                        healthIssues.push(`Storage warning (${percentage.toFixed(1)}%)`);
                    }
                }
                
                // Check data integrity
                const stores = ['products', 'sales', 'expenses'];
                for (const storeName of stores) {
                    try {
                        await loadFrom1GBStorage(storeName);
                    } catch (error) {
                        healthIssues.push(`${storeName} store corrupted`);
                    }
                }
                
                if (healthIssues.length === 0) {
                    showNotification('‚úÖ Storage health: EXCELLENT', 'success');
                } else {
                    showNotification(`‚ö†Ô∏è Storage health: ${healthIssues.length} issue(s) found`, 'warning');
                    console.log('Health issues:', healthIssues);
                }
                
                updateStorageModal();
            } catch (error) {
                showNotification('‚ùå Health check failed: ' + error.message, 'danger');
            }
        }
        
        // Show storage details
        function showStorageDetails() {
            showStorageManager();
        }
        
        // Request persistent storage
        async function requestPersistentStorage() {
            if (navigator.storage && navigator.storage.persist) {
                const granted = await navigator.storage.persist();
                if (granted) {
                    showNotification('‚úÖ Persistent storage granted! Data safe from cleanup.', 'success');
                } else {
                    showNotification('‚ö†Ô∏è Persistent storage not granted. Data may be cleared.', 'warning');
                }
            } else {
                showNotification('‚ùå Persistent storage not supported in this browser', 'danger');
            }
        }
        
        // Compress all data
        async function compressAllData() {
            showNotification('üì¶ Compressing all data...', 'info');
            
            try {
                // Compress products
                const products = await loadFrom1GBStorage('products');
                const compressedProducts = compressData(products);
                await saveToCompressedData('products_compressed', compressedProducts);
                
                // Compress sales
                const sales = await loadFrom1GBStorage('sales');
                const compressedSales = compressData(sales);
                await saveToCompressedData('sales_compressed', compressedSales);
                
                // Compress expenses
                const expenses = await loadFrom1GBStorage('expenses');
                const compressedExpenses = compressData(expenses);
                await saveToCompressedData('expenses_compressed', compressedExpenses);
                
                showNotification('‚úÖ All data compressed! Space saved.', 'success');
                updateStorageDisplay();
                updateStorageModal();
            } catch (error) {
                showNotification('‚ùå Compression failed: ' + error.message, 'danger');
            }
        }
        
        // Compress data (simple string compression for large text)
        function compressData(data) {
            if (typeof data === 'string') {
                // Simple compression for strings
                return btoa(encodeURIComponent(data).replace(/%[0-9A-F]{2}/g, match => match.toLowerCase()));
            } else if (Array.isArray(data) || typeof data === 'object') {
                const jsonString = JSON.stringify(data);
                return btoa(encodeURIComponent(jsonString).replace(/%[0-9A-F]{2}/g, match => match.toLowerCase()));
            }
            return data;
        }
        
        // Decompress data
        function decompressData(compressedData) {
            try {
                const decoded = decodeURIComponent(atob(compressedData));
                return JSON.parse(decoded);
            } catch (error) {
                // If decompression fails, return as-is
                return compressedData;
            }
        }
        
        // Save to compressed data store
        async function saveToCompressedData(key, data) {
            if (!storageDB) return;
            
            return new Promise((resolve, reject) => {
                const transaction = storageDB.transaction(['compressed_data'], 'readwrite');
                const store = transaction.objectStore('compressed_data');
                store.put({ id: key, data: data, timestamp: Date.now() });
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }
        
        // Load from compressed data store
        async function loadFromCompressedData(key) {
            if (!storageDB) return null;
            
            return new Promise((resolve, reject) => {
                const transaction = storageDB.transaction(['compressed_data'], 'readonly');
                const store = transaction.objectStore('compressed_data');
                const request = store.get(key);
                
                request.onsuccess = () => {
                    if (request.result) {
                        resolve(decompressData(request.result.data));
                    } else {
                        resolve(null);
                    }
                };
                
                request.onerror = () => reject(request.error);
            });
        }
        
        // Check compression status
        async function checkCompressionStatus() {
            try {
                const compressedProducts = await loadFromCompressedData('products_compressed');
                const status = compressedProducts ? 'Enabled' : 'Available';
                document.getElementById('compressionStatus').textContent = status;
            } catch (error) {
                document.getElementById('compressionStatus').textContent = 'Disabled';
            }
        }
        
        // Compress large text data automatically
        async function compressLargeData() {
            const products = await loadFrom1GBStorage('products');
            
            for (const product of products) {
                if (product.description && product.description.length > 500) {
                    // Compress long descriptions
                    product.description = compressData(product.description);
                    product._compressed = true;
                }
            }
            
            await saveTo1GBStorage('products', products);
        }
        
        // Remove duplicates
        async function removeDuplicates() {
            const sales = await loadFrom1GBStorage('sales');
            const uniqueSales = [];
            const seenIds = new Set();
            
            for (const sale of sales) {
                if (!seenIds.has(sale.id)) {
                    seenIds.add(sale.id);
                    uniqueSales.push(sale);
                }
            }
            
            if (uniqueSales.length < sales.length) {
                await saveTo1GBStorage('sales', uniqueSales);
                console.log(`Removed ${sales.length - uniqueSales.length} duplicate sales`);
            }
        }
        
        // Cleanup temporary data
        async function cleanupTemporaryData() {
            // Remove any data marked as temporary
            const sales = await loadFrom1GBStorage('sales');
            const validSales = sales.filter(sale => sale.status !== 'temporary');
            await saveTo1GBStorage('sales', validSales);
        }
        
        // Update storage indexes
        async function updateStorageIndexes() {
            // This would typically be handled by IndexedDB automatically
            // but we can trigger a re-index if needed
            console.log('Storage indexes updated');
        }

        // ==================== CUSTOM CATEGORIES SYSTEM ====================
        async function getCategories() {
            const categories = await loadFrom1GBStorage('categories');
            return Array.isArray(categories) ? categories : [];
        }
        
        async function saveCategories(categories) {
            await saveTo1GBStorage('categories', categories);
        }
        
        async function loadDefaultCategories() {
            const categories = await getCategories();
            
            // If no categories exist, create default ones
            if (categories.length === 0) {
                const defaultCategories = [
                    'Food',
                    'Drinks',
                    'Toiletries',
                    'Stationery',
                    'Electronics',
                    'Clothing',
                    'Other'
                ];
                
                await saveCategories(defaultCategories);
                return defaultCategories;
            }
            
            return categories;
        }
        
        // ==================== EXCEL/CSV EXPORT SYSTEM ====================
// (Keep all existing Excel/CSV functions - they remain the same)

// ==================== UNIVERSAL DATA MIGRATOR ====================
function universalDataImport(file) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            console.log("Importing data:", importedData);
            
            // DETECT FILE TYPE
            let migrationResult;
            
            // OPTION 1: Smart Backup (NEW VERSION)
            if (importedData.exportType === 'smart_backup') {
                migrationResult = migrateSmartBackup(importedData);
            }
            // OPTION 2: Excel Export (OLD VERSION)
            else if (importedData.exportedAt || importedData.products) {
                migrationResult = migrateLegacyBackup(importedData);
            }
            // OPTION 3: Raw Products Array
            else if (Array.isArray(importedData) && importedData[0]?.name) {
                migrationResult = migrateRawProducts(importedData);
            }
            // OPTION 4: Individual Data Files
            else if (importedData.products || importedData.sales || importedData.expenses) {
                migrationResult = migrateSeparateData(importedData);
            }
            else {
                showNotification('‚ùå Unsupported backup format!', 'danger');
                return;
            }
            
            // SHOW RESULTS
            if (migrationResult.success) {
                showNotification(`‚úÖ Migration successful! ${migrationResult.message}`, 'success');
                
                // Refresh everything
                loadDashboard();
                loadInventoryTable();
                loadSalesHistory();
                loadExpensesTable();
                
                // Show summary
                setTimeout(() => {
                    alert(`üìä MIGRATION COMPLETE!
                    
‚úÖ Products: ${getProducts().length}
‚úÖ Sales: ${getSales().length}  
‚úÖ Expenses: ${getExpenses().length}
‚úÖ Categories: ${getCategories().length}

All data has been migrated to ShopYanga PRO 2.5.0!`);
                }, 1000);
            } else {
                showNotification(`‚ùå Migration failed: ${migrationResult.message}`, 'danger');
            }
            
        } catch (error) {
            console.error('Import error:', error);
            showNotification('‚ùå Error reading backup file!', 'danger');
        }
    };
    
    reader.onerror = function() {
        showNotification('‚ùå Error reading file!', 'danger');
    };
    
    reader.readAsText(file);
}

function migrateSmartBackup(data) {
    let importedCount = 0;
    let updatedCount = 0;
    
    // Migrate Products
    if (data.products && Array.isArray(data.products)) {
        const currentProducts = getProducts();
        
        data.products.forEach(product => {
            const existingIndex = currentProducts.findIndex(p => 
                p.name.toLowerCase() === product.name.toLowerCase()
            );
            
            if (existingIndex > -1) {
                // Update existing
                currentProducts[existingIndex] = {
                    ...currentProducts[existingIndex],
                    ...product,
                    id: currentProducts[existingIndex].id,
                    lastUpdated: new Date().toISOString()
                };
                updatedCount++;
            } else {
                // Add new
                currentProducts.push({
                    id: 'prod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    ...product,
                    addedDate: new Date().toISOString()
                });
                importedCount++;
            }
        });
        
        saveProducts(currentProducts);
    }
    
    // Migrate Categories
    if (data.metadata?.categories) {
        const currentCategories = getCategories();
        const newCategories = data.metadata.categories.filter(cat => 
            !currentCategories.includes(cat)
        );
        
        if (newCategories.length > 0) {
            saveCategories([...currentCategories, ...newCategories]);
            updateCategoryDropdowns();
        }
    }
    
    return {
        success: true,
        message: `${importedCount} new products, ${updatedCount} updated`
    };
}

function migrateLegacyBackup(data) {
    let stats = {
        products: 0,
        sales: 0,
        expenses: 0
    };
    
    // Migrate Products
    if (data.products && Array.isArray(data.products)) {
        const currentProducts = getProducts();
        const newProducts = [...currentProducts];
        
        data.products.forEach(product => {
            if (!currentProducts.find(p => p.id === product.id)) {
                newProducts.push({
                    ...product,
                    // Ensure all required fields
                    unit: product.unit || 'pcs',
                    addedDate: product.addedDate || new Date().toISOString()
                });
                stats.products++;
            }
        });
        
        saveProducts(newProducts);
    }
    
    // Migrate Sales
    if (data.sales && Array.isArray(data.sales)) {
        const currentSales = getSales();
        const newSales = [...currentSales];
        
        data.sales.forEach(sale => {
            if (!currentSales.find(s => s.id === sale.id)) {
                newSales.push({
                    ...sale,
                    // Ensure proper date format
                    date: sale.date || new Date().toISOString()
                });
                stats.sales++;
            }
        });
        
        saveSales(newSales);
    }
    
    // Migrate Expenses
    if (data.expenses && Array.isArray(data.expenses)) {
        const currentExpenses = getExpenses();
        const newExpenses = [...currentExpenses];
        
        data.expenses.forEach(expense => {
            if (!currentExpenses.find(e => e.id === expense.id)) {
                newExpenses.push(expense);
                stats.expenses++;
            }
        });
        
        saveExpenses(newExpenses);
    }
    
    return {
        success: true,
        message: `${stats.products} products, ${stats.sales} sales, ${stats.expenses} expenses migrated`
    };
}

function migrateRawProducts(productsArray) {
    const currentProducts = getProducts();
    const newProducts = [...currentProducts];
    
    productsArray.forEach(product => {
        if (!currentProducts.find(p => p.id === product.id || p.name === product.name)) {
            newProducts.push({
                id: 'prod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: product.name || 'Imported Product',
                category: product.category || 'Other',
                price: product.price || 0,
                cost: product.cost || null,
                quantity: product.quantity || 0,
                unit: product.unit || 'pcs',
                expiryDate: product.expiryDate || null,
                description: product.description || '',
                addedDate: new Date().toISOString()
            });
        }
    });
    
    saveProducts(newProducts);
    
    return {
        success: true,
        message: `${productsArray.length} products imported`
    };
}

function migrateSeparateData(data) {
    let message = '';
    
    if (data.products) {
        migrateRawProducts(data.products);
        message += `${data.products.length} products, `;
    }
    
    if (data.sales) {
        const sales = getSales();
        saveSales([...sales, ...data.sales]);
        message += `${data.sales.length} sales, `;
    }
    
    if (data.expenses) {
        const expenses = getExpenses();
        saveExpenses([...expenses, ...data.expenses]);
        message += `${data.expenses.length} expenses, `;
    }
    
    return {
        success: true,
        message: message
    };
}

function handleUniversalImport(file) {
    if (!file) return;
    
    if (!confirm(`MIGRATE DATA FROM OLD VERSION?\n\nThis will import:\n‚Ä¢ All products\n‚Ä¢ Sales history\n‚Ä¢ Expenses\n‚Ä¢ Categories\n\nYour current data will be preserved.`)) {
        return;
    }
    
    // Check file type
    if (file.name.endsWith('.csv') || file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
        // Handle Excel/CSV files
        showNotification('Processing Excel/CSV file...', 'info');
        // You can add CSV import logic here if needed
    } else if (file.name.endsWith('.json')) {
        // Handle JSON backup
        universalDataImport(file);
    } else {
        showNotification('‚ùå Please use JSON, CSV, or Excel files', 'danger');
    }
}

        // ==================== ENHANCED 34-DAY RENTAL SYSTEM ====================
        // (Keep all existing rental system functions - they remain the same)
        // ==================== DEVELOPER FUNCTIONS ====================
        // (Keep all existing developer functions - they remain the same)
        // ==================== THEME SYSTEM ====================
        // (Keep all existing theme functions - they remain the same)
        // ==================== SECURITY SYSTEM ====================
        // (Keep all existing security functions - they remain the same)
        // ==================== INVENTORY MANAGEMENT ====================
        // (Update all inventory functions to use 1GB storage)
        // ==================== SALES MANAGEMENT ====================
        // (Update all sales functions to use 1GB storage)
        // ==================== EXPENSE MANAGEMENT ====================
        // (Update all expense functions to use 1GB storage)
        // ==================== DASHBOARD ====================
        // (Update all dashboard functions to use 1GB storage)
        // ==================== ANALYTICS & REPORTS ====================
        // (Update all analytics functions to use 1GB storage)
        // ==================== SETTINGS ====================
        // (Update all settings functions to use 1GB storage)
        // ==================== UTILITY FUNCTIONS ====================
        // (Keep all existing utility functions - they remain the same)

        // ==================== UPDATED STORAGE FUNCTIONS ====================
        async function saveProducts(products) {
            await saveTo1GBStorage('products', products);
        }

        async function getProducts() {
            const products = await loadFrom1GBStorage('products');
            return Array.isArray(products) ? products : [];
        }

        async function saveSales(sales) {
            await saveTo1GBStorage('sales', sales);
        }

        async function getSales() {
            const sales = await loadFrom1GBStorage('sales');
            return Array.isArray(sales) ? sales : [];
        }

        async function saveExpenses(expenses) {
            await saveTo1GBStorage('expenses', expenses);
        }

        async function getExpenses() {
            const expenses = await loadFrom1GBStorage('expenses');
            return Array.isArray(expenses) ? expenses : [];
        }

        async function saveShopSettings(settings) {
            await saveTo1GBStorage('settings', settings);
        }

        async function getShopSettings() {
            const settings = await loadFrom1GBStorage('settings');
            if (!settings || Object.keys(settings).length === 0) {
                const defaultSettings = {
                    shopName: 'ShopYanga',
                    lowStockThreshold: 5,
                    expiryWarningDays: 7
                };
                await saveShopSettings(defaultSettings);
                return defaultSettings;
            }
            return settings;
        }

        // ==================== FIREBASE SYNC SYSTEM ====================
let isOnline = navigator.onLine;
let syncEnabled = true;

// Generate unique shop ID (uses existing device ID)
function getShopId() {
    let shopId = localStorage.getItem('shopYangaShopId');
    if (!shopId) {
        const deviceId = getCustomerDeviceId(); // Your existing function
        shopId = 'SHOP-' + deviceId.replace('DEV-', '').substring(0, 12).toUpperCase();
        localStorage.setItem('shopYangaShopId', shopId);
    }
    return shopId;
}

// Generate owner access code (for remote viewing)
function generateOwnerCode() {
    const shopId = getShopId();
    const code = 'OWNER-' + Date.now().toString(36).toUpperCase().slice(-6);
    localStorage.setItem('shopYangaOwnerCode', code);
    return { shopId, code };
}

// Get owner dashboard URL
function getOwnerDashboardURL() {
    const shopId = getShopId();
    const ownerCode = localStorage.getItem('shopYangaOwnerCode') || 'NOCODE';
    return `https://shopyanga-dashboard.web.app/?shop=${shopId}&code=${ownerCode}`;
}

// Sync all data to Firebase
async function syncAllDataToFirebase() {
    if (!database || !isOnline || !syncEnabled) return false;
    
    try {
        const shopId = getShopId();
        const syncData = {
            shopId: shopId,
            shopName: document.getElementById('shopName')?.value || 'ShopYanga',
            products: getProducts(),
            sales: getSales(),
            expenses: getExpenses(),
            lastSync: new Date().toISOString(),
            deviceId: getCustomerDeviceId(),
            appVersion: '2.5.0'
        };
        
        // Save to Firebase
        await database.ref('shops/' + shopId).set(syncData);
        console.log('‚úÖ Data synced to Firebase:', shopId);
        
        // Update sync status
        updateSyncStatus('success', 'Data synced to cloud');
        return true;
    } catch (error) {
        console.error('‚ùå Sync error:', error);
        updateSyncStatus('error', 'Sync failed: ' + error.message);
        return false;
    }
}

// Auto-sync when online
function setupAutoSync() {
    // Check online status
    window.addEventListener('online', () => {
        isOnline = true;
        showNotification('üåê Online - Syncing data...', 'info');
        syncAllDataToFirebase();
    });
    
    window.addEventListener('offline', () => {
        isOnline = false;
        showNotification('üì¥ Offline - Working locally', 'warning');
        updateSyncStatus('offline', 'Working offline');
    });
    
    // Sync every 5 minutes when online
    setInterval(() => {
        if (isOnline && syncEnabled) {
            syncAllDataToFirebase();
        }
    }, 5 * 60 * 1000); // 5 minutes
    
    // Sync on page load if online
    setTimeout(() => {
        if (isOnline) {
            syncAllDataToFirebase();
        }
    }, 3000);
}

// Update sync status display
function updateSyncStatus(status, message) {
    const statusElement = document.getElementById('syncStatus');
    if (!statusElement) return;
    
    const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        offline: 'üì¥',
        syncing: 'üîÑ'
    };
    
    statusElement.innerHTML = `${icons[status] || 'üì°'} ${message}`;
    statusElement.style.color = status === 'success' ? 'var(--success)' : 
                               status === 'error' ? 'var(--danger)' : 
                               status === 'offline' ? 'var(--warning)' : 'var(--text-color)';
}

// Backup to Firebase (manual trigger)
function backupToFirebase() {
    if (!isOnline) {
        showNotification('No internet connection!', 'danger');
        return;
    }
    
    showNotification('Backing up to cloud...', 'info');
    syncAllDataToFirebase().then(success => {
        if (success) {
            showNotification('‚úÖ Backup complete! Data safe in cloud.', 'success');
        }
    });
}

// Restore from Firebase (manual trigger)
async function restoreFromFirebase() {
    if (!isOnline || !database) {
        showNotification('Cannot restore: No internet connection', 'danger');
        return;
    }
    
    if (!confirm('Restore data from cloud? This will overwrite local data.')) {
        return;
    }
    
    try {
        const shopId = getShopId();
        showNotification('Restoring from cloud...', 'info');
        
        const snapshot = await database.ref('shops/' + shopId).once('value');
        const data = snapshot.val();
        
        if (!data) {
            showNotification('No backup found in cloud!', 'warning');
            return;
        }
        
        // Restore all data
        if (data.products) saveProducts(data.products);
        if (data.sales) saveSales(data.sales);
        if (data.expenses) saveExpenses(data.expenses);
        
        showNotification('‚úÖ Data restored from cloud!', 'success');
        
        // Reload all views
        loadDashboard();
        loadInventoryTable();
        loadSalesHistory();
        loadExpensesTable();
        
    } catch (error) {
        showNotification('Restore failed: ' + error.message, 'danger');
    }
}
// ==================== END SYNC SYSTEM ====================

        // ==================== PERSISTENT LICENSE STORAGE ====================
        async function getPersistentLicense() {
            const license = await loadFrom1GBStorage('license');
            return license || null;
        }
        
        async function savePersistentLicense(licenseData) {
            await saveTo1GBStorage('license', licenseData);
        }

        // ==================== INITIALIZATION ====================
        async function initializeStorage() {
            // Check if we have existing localStorage data
            const hasLocalStorageData = localStorage.getItem('shopYangaProducts') !== null;
            
            if (hasLocalStorageData) {
                console.log('Found existing localStorage data - will auto-migrate');
            }
            
            // Initialize 1GB storage
            await init1GBStorage();
            
            // Initialize default categories if none exist
            await loadDefaultCategories();
            
            // Initialize default settings if none exist
            const settings = await getShopSettings();
            if (!settings.shopName) {
                await saveShopSettings({
                    shopName: 'ShopYanga',
                    lowStockThreshold: 5,
                    expiryWarningDays: 7
                });
            }
        }
        
        
        async function initializeApp() {
    console.log("üöÄ Shop Yanga Manager PRO with 1GB Storage");
    
    // Initialize PWA (will handle local file detection)
    initializePWA();
    
    // Load theme (day/night mode)
    loadTheme();
    
    // Initialize storage system (1GB or fallback)
    await initializeStorage();
    
    // Check 34-day rental system
    const isLocked = initialize34DaySystem();
    
    if (isLocked) {
        console.log('System locked - waiting for activation/renewal');
        return;
    }
    
    console.log('System active - continuing initialization');
    
    // Load the rest of the app
    await initializeAppAfterLicenseCheck();
}
        function checkForLegacyData() {
    // Check if user has old localStorage data
    const oldDataKeys = [
        'shopProducts',
        'shopSales', 
        'shopExpenses',
        'shopCategories',
        'shopYangaData',
        'shopInventory'
    ];
    
    let hasOldData = false;
    oldDataKeys.forEach(key => {
        if (localStorage.getItem(key)) {
            hasOldData = true;
            console.log(`Found old data in key: ${key}`);
        }
    });
    
    if (hasOldData) {
        setTimeout(() => {
            showNotification('üîÑ Old data detected! Use Migration tool in Backup section.', 'warning');
        }, 2000);
    }
}

        // ==================== PWA SERVICE WORKER ====================
        function initializePWA() {
            console.log('üì± Initializing PWA features...');
            
            const isPwaSupported = 'serviceWorker' in navigator && ('PushManager' in window || 'beforeinstallprompt' in window);
            
            if (isPwaSupported) {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('‚úÖ Service Worker registered:', registration.scope);
                            
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                console.log('üîÑ Service Worker update found!');
                                
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        showNotification('üì± New version available! Refresh to update.', 'info');
                                    }
                                });
                            });
                        })
                        .catch(error => {
                            console.log('‚ÑπÔ∏è Service Worker registration failed:', error.message);
                        });
                }
                
                let deferredPrompt;
                const installButton = document.getElementById('installButton');
                
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    
                    setTimeout(() => {
                        if (installButton) {
                            installButton.style.display = 'flex';
                        }
                    }, 3000);
                    
                    if (installButton) {
                        installButton.onclick = function() {
                            if (deferredPrompt) {
                                deferredPrompt.prompt();
                                deferredPrompt.userChoice.then(choiceResult => {
                                    if (choiceResult.outcome === 'accepted') {
                                        console.log('‚úÖ User installed the PWA');
                                        showNotification('üéâ ShopYanga installed!', 'success');
                                    }
                                    deferredPrompt = null;
                                    installButton.style.display = 'none';
                                });
                            }
                        };
                    }
                });
                
                window.matchMedia('(display-mode: standalone)').addListener(e => {
                    if (e.matches) {
                        console.log('üì± App running in standalone mode');
                        if (installButton) installButton.style.display = 'none';
                    }
                });
            }
        }

// ==================== CUSTOM CATEGORIES SYSTEM ====================
        function getCategories() {
            return JSON.parse(localStorage.getItem('shopYangaCategories') || '[]');
        }
        
        function saveCategories(categories) {
            localStorage.setItem('shopYangaCategories', JSON.stringify(categories));
            // Also save to IndexedDB if available
            if (shopDB) {
                saveToIndexedDB('categories', categories);
            }
        }
        
        function loadDefaultCategories() {
            const categories = getCategories();
            
            // If no categories exist, create default ones
            if (categories.length === 0) {
                const defaultCategories = [
                    'Food',
                    'Drinks',
                    'Toiletries',
                    'Stationery',
                    'Electronics',
                    'Clothing',
                    'Other'
                ];
                
                saveCategories(defaultCategories);
                return defaultCategories;
            }
            
            return categories;
        }
        
        function showCategoriesModal() {
            if (currentUserRole !== 'owner') {
                showSecurityModal('role');
                return;
            }
            
            document.getElementById('categoriesModal').style.display = 'flex';
            loadCategoriesList();
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryName').focus();
            
            const categoriesModal = document.getElementById('categoriesModal');
            const categoriesClose = document.getElementById('categoriesClose');
            
            // Remove old listener
            categoriesClose.replaceWith(categoriesClose.cloneNode(true));
            
            // Get new reference
            const newClose = document.getElementById('categoriesClose');
            
            // Add new listener
            newClose.onclick = function() {
                document.getElementById('categoriesModal').style.display = 'none';
            };
            
            // Close modal on outside click
            categoriesModal.onclick = function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            };
            
            // Enter key to add category
            document.getElementById('newCategoryName').onkeypress = function(e) {
                if (e.key === 'Enter') {
                    addNewCategory();
                }
            };
        }
        
        function loadCategoriesList() {
            const categories = getCategories();
            const container = document.getElementById('categoriesList');
            
            if (categories.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üè∑Ô∏è</div>
                        <p>No categories yet</p>
                        <p style="font-size: 0.9rem;">Add your first category above</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = categories.map((category, index) => `
                <div class="table-row" style="grid-template-columns: 1fr auto; margin-bottom: 5px; padding: 10px;">
                    <div>
                        <span class="badge badge-info">${category}</span>
                        <div style="font-size: 0.8rem; color: #666;">
                            Used by ${countProductsInCategory(category)} products
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn btn-sm" onclick="editCategory(${index})" style="background: var(--warning); color: white;">
                            Edit
                        </button>
                        <button class="action-btn btn-sm" onclick="deleteCategory(${index})" style="background: var(--danger); color: white;" ${countProductsInCategory(category) > 0 ? 'disabled' : ''}>
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function countProductsInCategory(category) {
            const products = getProducts();
            return products.filter(p => p.category === category).length;
        }
        
        function addNewCategory() {
            const categoryName = document.getElementById('newCategoryName').value.trim();
            
            if (!categoryName) {
                showNotification('Please enter a category name!', 'warning');
                return;
            }
            
            const categories = getCategories();
            
            // Check if category already exists
            if (categories.includes(categoryName)) {
                showNotification('Category already exists!', 'warning');
                return;
            }
            
            categories.push(categoryName);
            saveCategories(categories);
            
            document.getElementById('newCategoryName').value = '';
            loadCategoriesList();
            updateCategoryDropdowns();
            
            showNotification(`Category "${categoryName}" added!`, 'success');
        }
        
        function editCategory(index) {
            const categories = getCategories();
            const oldName = categories[index];
            const newName = prompt('Edit category name:', oldName);
            
            if (!newName || newName.trim() === '') {
                return;
            }
            
            const newNameTrimmed = newName.trim();
            
            // Check if new name already exists (and it's not the same as old name)
            if (categories.includes(newNameTrimmed) && newNameTrimmed !== oldName) {
                showNotification('Category already exists!', 'warning');
                return;
            }
            
            // Update category name
            categories[index] = newNameTrimmed;
            saveCategories(categories);
            
            // Update all products with this category
            updateProductsCategory(oldName, newNameTrimmed);
            
            loadCategoriesList();
            updateCategoryDropdowns();
            
            showNotification(`Category updated to "${newNameTrimmed}"!`, 'success');
        }
        
        function updateProductsCategory(oldCategory, newCategory) {
            const products = getProducts();
            let updatedCount = 0;
            
            products.forEach(product => {
                if (product.category === oldCategory) {
                    product.category = newCategory;
                    updatedCount++;
                }
            });
            
            if (updatedCount > 0) {
                saveProducts(products);
                showNotification(`Updated ${updatedCount} products to new category`, 'info');
                loadInventoryTable();
            }
        }
        
        function deleteCategory(index) {
            const categories = getCategories();
            const categoryName = categories[index];
            const productCount = countProductsInCategory(categoryName);
            
            if (productCount > 0) {
                showNotification(`Cannot delete "${categoryName}" - used by ${productCount} products!`, 'danger');
                return;
            }
            
            if (!confirm(`Delete category "${categoryName}"?`)) {
                return;
            }
            
            categories.splice(index, 1);
            saveCategories(categories);
            
            loadCategoriesList();
            updateCategoryDropdowns();
            
            showNotification(`Category "${categoryName}" deleted!`, 'success');
        }
        
        function updateCategoryDropdowns() {
    try {
        const categories = getCategories();
        
        // List of all category dropdown IDs in your app
        const dropdownIds = [
            'filterCategory',
            'modalProductCategory',
            'modalProductCategoryFilter'
        ];
        
        dropdownIds.forEach(dropdownId => {
            const select = document.getElementById(dropdownId);
            if (select) {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Category</option>' +
                    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                
                // Restore selected value if it still exists
                if (categories.includes(currentValue)) {
                    select.value = currentValue;
                }
            }
        });
        
    } catch (error) {
        console.error("Error updating category dropdowns:", error);
    }
}

function checkSettingsElements() {
    console.log("üîç Checking Settings tab elements:");
    
    const elements = [
        'shopName',
        'lowStockThreshold',
        'expiryWarningDays',
        'daysCounterDisplay',
        'ownerPassword',
        'confirmPassword',
        'customerActivationPortal'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        console.log(`${id}: ${element ? '‚úÖ Found' : '‚ùå Not found'}`);
    });
}

        // ==================== BACKUP MODAL TABS ====================
function switchBackupTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.backup-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from all tabs
    document.querySelectorAll('.backup-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // Activate selected tab button
    document.querySelectorAll('.backup-tab').forEach(tab => {
        if (tab.textContent.includes(getTabDisplayName(tabName))) {
            tab.classList.add('active');
        }
    });
    
    // Reset file inputs when switching tabs
    if (tabName !== 'import') {
        document.getElementById('importFile').value = '';
        document.getElementById('processImportBtn').disabled = true;
    }
    if (tabName !== 'smart') {
        document.getElementById('smartBackupFile').value = '';
    }
}

function getTabDisplayName(tabName) {
    const names = {
        'export': 'üì§ Export',
        'import': 'üì• Import',
        'smart': 'üîÑ Smart'
    };
    return names[tabName] || tabName;
}

// Initialize modal with export tab active
function showExcelBackupModal() {
    document.getElementById('excelBackupModal').style.display = 'flex';
    
    // Start with Export tab active
    switchBackupTab('export');
    
    // Reset import form
    document.getElementById('importDataType').value = '';
    document.getElementById('importFile').value = '';
    document.getElementById('processImportBtn').disabled = true;
    
    const excelBackupModal = document.getElementById('excelBackupModal');
    const excelBackupClose = document.getElementById('excelBackupClose');
    
    // Update close button listener
    excelBackupClose.onclick = function() {
        document.getElementById('excelBackupModal').style.display = 'none';
    };
    
    // Close modal on outside click
    excelBackupModal.onclick = function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    };
}
        
        function exportToCSV(data, headers, filename) {
            let csv = headers.join(',') + '\n';
            
            data.forEach(row => {
                const rowData = headers.map(header => {
                    let value = row[header] || '';
                    // Handle special characters and commas
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csv += rowData.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification(`${filename} exported successfully!`, 'success');
        }
        
        function exportProductsToExcel() {
            const products = getProducts();
            
            if (products.length === 0) {
                showNotification('No products to export!', 'warning');
                return;
            }
            
            const data = products.map(product => ({
                'Product Name': product.name,
                'Category': product.category,
                'Selling Price': product.price,
                'Cost Price': product.cost || '',
                'Quantity': product.quantity,
                'Unit': product.unit || 'pcs',
                'Expiry Date': product.expiryDate || '',
                'Description': product.description || '',
                'Added Date': product.addedDate ? new Date(product.addedDate).toLocaleDateString() : ''
            }));
            
            const headers = ['Product Name', 'Category', 'Selling Price', 'Cost Price', 'Quantity', 'Unit', 'Expiry Date', 'Description', 'Added Date'];
            const filename = `shopyanga-products-${new Date().toISOString().split('T')[0]}.csv`;
            
            exportToCSV(data, headers, filename);
        }
        
        function exportSalesToExcel() {
    // Get ALL sales
    const allSales = getSales();
    
    // Get the current filter values from the Sales tab
    const dateFrom = document.getElementById('salesDateFrom')?.value;
    const dateTo = document.getElementById('salesDateTo')?.value;
    
    let salesToExport = [...allSales];
    
    // Filter by date if dates are selected
    if (dateFrom || dateTo) {
        salesToExport = allSales.filter(sale => {
            const saleDate = sale.date.split('T')[0];
            
            let matches = true;
            
            // Check "from" date
            if (dateFrom && saleDate < dateFrom) {
                matches = false;
            }
            
            // Check "to" date
            if (dateTo && saleDate > dateTo) {
                matches = false;
            }
            
            return matches;
        });
    }
    
    // If no sales after filtering, show warning
    if (salesToExport.length === 0) {
        showNotification('No sales to export!', 'warning');
        return;
    }
    
    // Prepare data for export
    const data = salesToExport.map(sale => {
        const items = sale.items?.map(item => 
            `${item.quantity} √ó ${item.productName} (${formatCurrency(item.total)})`
        ).join('; ') || '';
        
        return {
            'Date': new Date(sale.date).toLocaleDateString(),
            'Time': new Date(sale.date).toLocaleTimeString(),
            'Items': items,
            'Item Count': sale.items?.reduce((sum, item) => sum + item.quantity, 0) || 0,
            'Subtotal': sale.subtotal,
            'Discount': sale.discount,
            'Total': sale.total,
            'Payment Method': sale.paymentMethod,
            'Status': sale.status || 'completed'
        };
    });
    
    const headers = ['Date', 'Time', 'Items', 'Item Count', 'Subtotal', 'Discount', 'Total', 'Payment Method', 'Status'];
    
    // Create filename with date range if filtered
    let filename = 'shopyanga-sales';
    if (dateFrom && dateTo) {
        filename += `-${dateFrom.replace(/-/g, '')}-to-${dateTo.replace(/-/g, '')}`;
    }
    filename += `-${new Date().toISOString().split('T')[0]}.csv`;
    
    exportToCSV(data, headers, filename);
    
    // Show success message with filter info
    let message = `Exported ${salesToExport.length} sales`;
    if (dateFrom && dateTo) {
        message += ` from ${dateFrom} to ${dateTo}`;
    }
    showNotification(message, 'success');
}
        
        function exportExpensesToExcel() {
            const expenses = getExpenses();
            
            if (expenses.length === 0) {
                showNotification('No expenses to export!', 'warning');
                return;
            }
            
            const data = expenses.map(expense => ({
                'Date': expense.date,
                'Category': expense.category,
                'Description': expense.description,
                'Amount': expense.amount,
                'Payment Method': expense.paymentMethod
            }));
            
            const headers = ['Date', 'Category', 'Description', 'Amount', 'Payment Method'];
            const filename = `shopyanga-expenses-${new Date().toISOString().split('T')[0]}.csv`;
            
            exportToCSV(data, headers, filename);
        }
        
        function exportAllToExcel() {
            // Create a ZIP file with all exports
            const products = getProducts();
            const sales = getSales();
            const expenses = getExpenses();
            
            if (products.length === 0 && sales.length === 0 && expenses.length === 0) {
                showNotification('No data to export!', 'warning');
                return;
            }
            
            // For now, just export a combined CSV
            // In a real app, you'd use a ZIP library like JSZip
            const allData = [];
            
            // Add products
            if (products.length > 0) {
                products.forEach(product => {
                    allData.push({
                        'Type': 'PRODUCT',
                        'Name': product.name,
                        'Category': product.category,
                        'Price': product.price,
                        'Cost': product.cost || '',
                        'Quantity': product.quantity,
                        'Unit': product.unit || 'pcs',
                        'Expiry': product.expiryDate || ''
                    });
                });
            }
            
            // Add sales
            if (sales.length > 0) {
                sales.forEach(sale => {
                    allData.push({
                        'Type': 'SALE',
                        'Date': new Date(sale.date).toLocaleDateString(),
                        'Total': sale.total,
                        'Payment': sale.paymentMethod,
                        'Items': sale.items?.length || 0
                    });
                });
            }
            
            // Add expenses
            if (expenses.length > 0) {
                expenses.forEach(expense => {
                    allData.push({
                        'Type': 'EXPENSE',
                        'Date': expense.date,
                        'Category': expense.category,
                        'Description': expense.description,
                        'Amount': expense.amount,
                        'Payment': expense.paymentMethod
                    });
                });
            }
            
            const headers = ['Type', 'Name', 'Category', 'Price', 'Cost', 'Quantity', 'Unit', 'Expiry', 'Date', 'Total', 'Payment', 'Items', 'Description', 'Amount'];
            const filename = `shopyanga-all-data-${new Date().toISOString().split('T')[0]}.csv`;
            
            exportToCSV(allData, headers, filename);
        }
        
        function handleImportFile() {
            const file = document.getElementById('importFile').files[0];
            const dataType = document.getElementById('importDataType').value;
            
            if (!file || !dataType) {
                showNotification('Please select both data type and file!', 'warning');
                return;
            }
            
            document.getElementById('processImportBtn').disabled = false;
            showNotification(`File "${file.name}" selected for ${dataType} import`, 'info');
        }
        
        function processImportFile() {
            const file = document.getElementById('importFile').files[0];
            const dataType = document.getElementById('importDataType').value;
            
            if (!file || !dataType) {
                showNotification('Please select a file first!', 'warning');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    if (file.name.endsWith('.json')) {
                        // JSON import
                        const data = JSON.parse(content);
                        importJSONData(data, dataType);
                    } else if (file.name.endsWith('.csv')) {
                        // CSV import
                        importCSVData(content, dataType);
                    } else {
                        showNotification('Unsupported file format! Use CSV or JSON.', 'danger');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    showNotification('Error reading file! Check format.', 'danger');
                }
            };
            
            reader.onerror = function() {
                showNotification('Error reading file!', 'danger');
            };
            
            reader.readAsText(file);
        }
        
        function importJSONData(data, dataType) {
            try {
                switch(dataType) {
                    case 'products':
                        if (Array.isArray(data)) {
                            saveProducts(data);
                            showNotification(`Imported ${data.length} products!`, 'success');
                            loadInventoryTable();
                        } else if (data.products) {
                            saveProducts(data.products);
                            showNotification(`Imported ${data.products.length} products!`, 'success');
                            loadInventoryTable();
                        }
                        break;
                        
                    case 'sales':
                        if (Array.isArray(data)) {
                            saveSales(data);
                            showNotification(`Imported ${data.length} sales!`, 'success');
                            loadSalesHistory();
                        } else if (data.sales) {
                            saveSales(data.sales);
                            showNotification(`Imported ${data.sales.length} sales!`, 'success');
                            loadSalesHistory();
                        }
                        break;
                        
                    case 'expenses':
                        if (Array.isArray(data)) {
                            saveExpenses(data);
                            showNotification(`Imported ${data.length} expenses!`, 'success');
                            loadExpensesTable();
                        } else if (data.expenses) {
                            saveExpenses(data.expenses);
                            showNotification(`Imported ${data.expenses.length} expenses!`, 'success');
                            loadExpensesTable();
                        }
                        break;
                }
                
                // Close modal and reset
                document.getElementById('excelBackupModal').style.display = 'none';
                document.getElementById('importFile').value = '';
                document.getElementById('importDataType').value = '';
                document.getElementById('processImportBtn').disabled = true;
                
            } catch (error) {
                showNotification('Error importing data! Check file format.', 'danger');
            }
        }
        
        function importCSVData(csvContent, dataType) {
            try {
                const lines = csvContent.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const values = parseCSVLine(lines[i]);
                    const item = {};
                    
                    headers.forEach((header, index) => {
                        if (values[index] !== undefined) {
                            item[header] = values[index].trim();
                        }
                    });
                    
                    if (Object.keys(item).length > 0) {
                        data.push(item);
                    }
                }
                
                // Convert to appropriate format based on data type
                switch(dataType) {
                    case 'products':
                        const products = data.map(item => ({
                            id: 'prod_' + Date.now() + Math.random(),
                            name: item['Product Name'] || item['Name'] || '',
                            category: item['Category'] || 'Other',
                            price: parseFloat(item['Selling Price'] || item['Price'] || 0),
                            cost: parseFloat(item['Cost Price'] || item['Cost'] || 0) || null,
                            quantity: parseInt(item['Quantity'] || 0),
                            unit: item['Unit'] || 'pcs',
                            expiryDate: item['Expiry Date'] || item['Expiry'] || null,
                            description: item['Description'] || '',
                            addedDate: new Date().toISOString()
                        }));
                        saveProducts(products);
                        showNotification(`Imported ${products.length} products!`, 'success');
                        loadInventoryTable();
                        break;
                        
                    case 'expenses':
                        const expenses = data.map(item => ({
                            id: 'exp_' + Date.now() + Math.random(),
                            date: item['Date'] || new Date().toISOString().split('T')[0],
                            category: item['Category'] || 'other',
                            description: item['Description'] || '',
                            amount: parseFloat(item['Amount'] || 0),
                            paymentMethod: item['Payment Method'] || 'cash'
                        }));
                        saveExpenses(expenses);
                        showNotification(`Imported ${expenses.length} expenses!`, 'success');
                        loadExpensesTable();
                        break;
                }
                
                // Close modal and reset
                document.getElementById('excelBackupModal').style.display = 'none';
                document.getElementById('importFile').value = '';
                document.getElementById('importDataType').value = '';
                document.getElementById('processImportBtn').disabled = true;
                
            } catch (error) {
                console.error('CSV import error:', error);
                showNotification('Error importing CSV! Check format.', 'danger');
            }
        }
        
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"' && !inQuotes) {
                    inQuotes = true;
                } else if (char === '"' && inQuotes && nextChar === '"') {
                    current += '"';
                    i++; // Skip next quote
                } else if (char === '"' && inQuotes) {
                    inQuotes = false;
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current);
            return values;
        }

// ==================== BACKUP MODAL TABS ====================
function switchBackupTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.backup-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from all tabs
    document.querySelectorAll('.backup-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // Activate selected tab button
    document.querySelectorAll('.backup-tab').forEach(tab => {
        if (tab.textContent.includes(getTabDisplayName(tabName))) {
            tab.classList.add('active');
        }
    });
    
    // Reset file inputs when switching tabs
    if (tabName !== 'import') {
        document.getElementById('importFile').value = '';
        document.getElementById('processImportBtn').disabled = true;
    }
    if (tabName !== 'smart') {
        document.getElementById('smartBackupFile').value = '';
    }
}

function getTabDisplayName(tabName) {
    const names = {
        'export': 'üì§ Export',
        'import': 'üì• Import',
        'smart': 'üîÑ Smart'
    };
    return names[tabName] || tabName;
}

        // ==================== SMART BACKUP & RESTORE SYSTEM ====================
function exportProductsWithMetadata() {
    const products = getProducts();
    const settings = getShopSettings();
    const categories = getCategories();
    
    const exportData = {
        version: '2.0',
        exportDate: new Date().toISOString(),
        shopName: settings.shopName,
        totalProducts: products.length,
        exportType: 'smart_backup',
        metadata: {
            appVersion: 'ShopYanga PRO 2.5.0',
            schemaVersion: '2.0',
            categories: categories
        },
        products: products.map(product => ({
            name: product.name,
            category: product.category,
            price: product.price,
            cost: product.cost || null,
            quantity: product.quantity,
            unit: product.unit || 'pcs',
            expiryDate: product.expiryDate || null,
            description: product.description || '',
            sku: product.id || `SKU_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
        }))
    };
    
    // Create JSON file
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `shopyanga-products-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification(`‚úÖ Smart backup exported! ${products.length} products saved.`, 'success');
}

function importProductsSmart(file) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            const currentProducts = getProducts();
            const currentCategories = getCategories();
            
            // Validate file structure
            if (!importedData.products || !Array.isArray(importedData.products)) {
                showNotification('‚ùå Invalid backup file format!', 'danger');
                return;
            }
            
            let importedCount = 0;
            let updatedCount = 0;
            let newCategories = [];
            
            importedData.products.forEach(importedProduct => {
                // Check if product already exists (by name)
                const existingIndex = currentProducts.findIndex(p => 
                    p.name.toLowerCase() === importedProduct.name.toLowerCase()
                );
                
                if (existingIndex > -1) {
                    // Update existing product
                    currentProducts[existingIndex] = {
                        ...currentProducts[existingIndex],
                        ...importedProduct,
                        id: currentProducts[existingIndex].id, // Keep original ID
                        lastUpdated: new Date().toISOString()
                    };
                    updatedCount++;
                } else {
                    // Add new product
                    currentProducts.push({
                        id: 'prod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        ...importedProduct,
                        addedDate: new Date().toISOString()
                    });
                    importedCount++;
                }
                
                // Check for new categories
                if (importedProduct.category && 
                    !currentCategories.includes(importedProduct.category) &&
                    !newCategories.includes(importedProduct.category)) {
                    newCategories.push(importedProduct.category);
                }
            });
            
            // Save updated products
            saveProducts(currentProducts);
            
            // Add new categories if any
            if (newCategories.length > 0) {
                const updatedCategories = [...currentCategories, ...newCategories];
                saveCategories(updatedCategories);
                updateCategoryDropdowns();
            }
            
            // Show summary
            let message = `‚úÖ Import successful! `;
            if (importedCount > 0) message += `${importedCount} new products added. `;
            if (updatedCount > 0) message += `${updatedCount} products updated. `;
            if (newCategories.length > 0) message += `${newCategories.length} new categories added.`;
            
            showNotification(message, 'success');
            
            // Refresh views
            loadInventoryTable();
            loadDashboard();
            
        } catch (error) {
            console.error('Import error:', error);
            showNotification('‚ùå Error importing file! Invalid format.', 'danger');
        }
    };
    
    reader.onerror = function() {
        showNotification('‚ùå Error reading file!', 'danger');
    };
    
    reader.readAsText(file);
}

function handleSmartImport(file) {
    if (!file) return;
    
    if (!confirm(`Import products from backup?\n\nThis will:\n‚Ä¢ Add new products\n‚Ä¢ Update existing ones\n‚Ä¢ Preserve your current data\n\nContinue?`)) {
        return;
    }
    
    importProductsSmart(file);
}

        // ==================== ENHANCED 34-DAY RENTAL SYSTEM ====================
       function initialize34DaySystem() {
    console.log('üîê Initializing enhanced 34-day rental system...');
    
    loadActivationRegistry(); // Load activation codes
    
    const persistentLicense = getPersistentLicense();
    
    if (!persistentLicense) {
        console.log('‚ö†Ô∏è First time launch detected');
        showFirstTimeActivation();
        return true;
    }
    
    systemStartDate = persistentLicense.startDate || localStorage.getItem('shopYangaSystemStartDate');
    daysSinceReset = parseInt(localStorage.getItem('shopYangaDaysSinceReset')) || 0;
    lastResetCode = localStorage.getItem('shopYangaLastResetCode') || '';
    
    if (!systemStartDate) {
        systemStartDate = new Date().toISOString();
        localStorage.setItem('shopYangaSystemStartDate', systemStartDate);
        localStorage.setItem('shopYangaDaysSinceReset', '0');
        
        savePersistentLicense({
            initialized: true,
            firstLaunch: false,
            startDate: systemStartDate,
            licenseType: '34day_trial',
            activated: true,
            activationDate: new Date().toISOString()
        });
    }
    
    return check34DayRequirement();
}

// ==================== CUSTOMER ACTIVATION UI FUNCTIONS ====================
function loadCustomerActivationUI() {
    console.log("üéØ Loading Customer Activation Portal...");
    
    const portal = document.getElementById('customerActivationPortal');
    if (!portal) {
        console.error("‚ùå Activation portal element not found!");
        return;
    }
    
    const deviceId = getCustomerDeviceId();
    console.log("Device ID:", deviceId);
    
    // SIMPLE VERSION - EASIER FOR CUSTOMERS
    portal.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 3rem; margin-bottom: 15px;">üîë</div>
            <h3 style="color: var(--text-color);">Activate Your App</h3>
            <p style="color: #666; margin-bottom: 20px;">
                Get activation code from shop owner and enter it below
            </p>
            
            <!-- SIMPLE INPUT -->
            <div style="margin-bottom: 20px;">
                <input type="text" 
                       id="simpleActivationCode" 
                       placeholder="Enter code here (SY-XXXXX)"
                       style="width: 100%; padding: 15px; font-size: 1.1rem; text-align: center; border: 2px solid var(--primary); border-radius: 10px;">
            </div>
            
            <!-- ACTIVATE BUTTON -->
            <button onclick="activateAppSimple()" 
                    style="background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1rem; cursor: pointer; width: 100%;">
                üîì Activate Now
            </button>
            
            <!-- DEVICE INFO -->
            <div style="margin-top: 25px; padding: 15px; background: var(--light); border-radius: 10px;">
                <p style="margin-bottom: 10px;"><strong>Your Device ID:</strong></p>
                <div style="background: #2d3748; color: white; padding: 10px; border-radius: 5px; font-family: monospace; word-break: break-all;">
                    ${deviceId}
                </div>
                <button onclick="copyToClipboard('${deviceId}')" 
                        style="margin-top: 10px; background: var(--success); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                    üìã Copy Device ID
                </button>
                <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                    Share this Device ID with shop owner to get activation code
                </p>
            </div>
            
            <!-- HELP -->
            <div style="margin-top: 20px; color: #666; font-size: 0.9rem;">
                <p>Need help? Contact: ${developerContactPhone}</p>
            </div>
        </div>
    `;
    
    console.log("‚úÖ Activation UI loaded!");
}

// ADD THIS NEW SIMPLE ACTIVATION FUNCTION
function activateAppSimple() {
    const codeInput = document.getElementById('simpleActivationCode');
    const code = codeInput?.value.trim().toUpperCase() || '';
    
    if (!code) {
        showNotification('Please enter activation code!', 'warning');
        return;
    }
    
    showNotification('Activating... Please wait', 'info');
    
    setTimeout(() => {
        const result = applyCustomerActivation(code);
        
        if (result.success) {
            showNotification('‚úÖ Activated! Restarting app...', 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showNotification(`‚ùå Failed: ${result.message}`, 'danger');
        }
    }, 1000);
}

function processCustomerActivation() {
    const codeInput = document.getElementById('customerActivationInput');
    const code = codeInput?.value.trim().toUpperCase() || '';
    
    if (!code) {
        showNotification('Please enter activation code!', 'warning');
        return;
    }
    
    if (!code.startsWith('SY-')) {
        showNotification('Invalid code format! Code must start with SY-', 'danger');
        return;
    }
    
    const resultDiv = document.getElementById('settingsActivationResult');
    resultDiv.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div class="spinner"></div>
            <p>Verifying activation code...</p>
        </div>
    `;
    
    setTimeout(() => {
        const result = applyCustomerActivation(code);
        
        if (result.success) {
            resultDiv.innerHTML = `
                <div style="background: var(--success); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 3rem;">‚úÖ</div>
                    <h3>Activation Successful!</h3>
                    <p>Your app is now active for ${result.days} days</p>
                    <p>Application will restart in 5 seconds...</p>
                </div>
            `;
            
            if (codeInput) codeInput.value = '';
            
            setTimeout(() => {
                location.reload();
            }, 5000);
            
        } else {
            resultDiv.innerHTML = `
                <div style="background: var(--danger); color: white; padding: 20px; border-radius: 10px;">
                    <div style="font-size: 3rem;">‚ùå</div>
                    <h3>Activation Failed</h3>
                    <p>${result.message}</p>
                    <p>Please check the code and try again</p>
                </div>
            `;
        }
    }, 1000);
}

function copyDeviceIdToClipboard() {
    const deviceId = getCustomerDeviceId();
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(deviceId).then(() => {
            showNotification('Device ID copied to clipboard!', 'success');
        }).catch(() => {
            const textArea = document.createElement('textarea');
            textArea.value = deviceId;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showNotification('Device ID copied!', 'success');
        });
    } else {
        const textArea = document.createElement('textarea');
        textArea.value = deviceId;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Device ID copied!', 'success');
    }
}
        // ==================== LOCK SCREEN ACTIVATION FUNCTIONS ====================
function showSystemLock() {
    document.getElementById('systemLock').style.display = 'flex';
    document.body.style.overflow = 'hidden';
    document.getElementById('lockDeviceId').textContent = getCustomerDeviceId();
    
    setTimeout(() => {
        document.getElementById('lockActivationCode').focus();
    }, 500);
}

function activateFromLockScreen() {
    const code = document.getElementById('lockActivationCode').value.trim().toUpperCase();
    
    if (!code) {
        showNotification('Enter activation code!', 'warning');
        return;
    }
    
    const result = applyCustomerActivation(code);
    
    if (result.success) {
        document.getElementById('lockActivationCode').style.border = '2px solid var(--success)';
        showNotification('‚úÖ Activation successful! Restarting...', 'success');
        
        setTimeout(() => {
            hideSystemLock();
            setTimeout(() => location.reload(), 500);
        }, 2000);
    } else {
        showNotification(`‚ùå ${result.message}`, 'danger');
        document.getElementById('lockActivationCode').style.border = '2px solid var(--danger)';
        document.getElementById('lockActivationCode').focus();
    }
}

function shareDeviceId() {
    const deviceId = getCustomerDeviceId();
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(deviceId).then(() => {
            showNotification('Device ID copied to clipboard!', 'success');
        }).catch(() => {
            copyDeviceIdManual(deviceId);
        });
    } else {
        copyDeviceIdManual(deviceId);
    }
}

function copyDeviceIdManual(deviceId) {
    const textarea = document.createElement('textarea');
    textarea.value = deviceId;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showNotification('Device ID copied!', 'success');
}

function hideSystemLock() {
    document.getElementById('systemLock').style.display = 'none';
    document.body.style.overflow = 'auto';
}
        
        function showFirstTimeActivation() {
    const deviceId = getCustomerDeviceId();
    
    document.getElementById('systemLock').innerHTML = `
        <div class="system-lock-content">
            <p style="font-size: 1.2rem; margin-bottom: 20px; color: rgba(255,255,255,0.9);">üì± Activation Required</p>
            
            <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; margin-bottom: 25px; backdrop-filter: blur(10px);">
                
                <!-- STEP 1: SHOW DEVICE ID -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: white; margin-bottom: 10px;">üì± Your Device ID</h3>
                    <p style="color: rgba(255,255,255,0.8); margin-bottom: 10px;">
                        Share this ID with shop owner to get activation code:
                    </p>
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <code style="color: #fff; font-family: 'Courier New', monospace; font-size: 1rem; word-break: break-all; display: block; text-align: center;">
                            ${deviceId}
                        </code>
                    </div>
                    <button onclick="copyToClipboard('${deviceId}')" 
                            style="background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px;">
                        üìã Copy Device ID
                    </button>
                    <small style="color: rgba(255,255,255,0.7); display: block; text-align: center;">
                        Send this to shop owner via WhatsApp/SMS
                    </small>
                </div>
                
                <!-- STEP 2: ENTER CODE -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: white; margin-bottom: 10px;">üîë Enter Activation Code</h3>
                    <p style="color: rgba(255,255,255,0.8); margin-bottom: 10px;">
                        Enter code received from shop owner:
                    </p>
                    <input type="text" 
                           id="firstTimeCode" 
                           class="system-lock-input" 
                           placeholder="Enter code (SY-XXXXX-XXXXX)" 
                           style="margin-bottom: 15px; font-size: 1rem; text-align: center; letter-spacing: 1px;">
                    
                    <button onclick="activateFirstTime()" 
                            class="system-lock-btn" 
                            style="background: #ffffff; color: #667eea; font-weight: bold; padding: 15px;">
                        ‚úÖ Activate 34-Day Access
                    </button>
                </div>
                
                <!-- HELP SECTION -->
                <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                    <h4 style="color: white; margin-bottom: 10px;">üìû Need Help?</h4>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">
                        <div>${developerCompany}</div>
                        <div>üìß ${developerContactEmail}</div>
                        <div>üìû ${developerContactPhone}</div>
                    </div>
                </div>
                
            </div>
            
            <div class="days-counter">
                <p style="font-size: 0.9rem; color: rgba(255,255,255,0.8);">
                    Professional Business Management System ‚Ä¢ Made for Malawi
                </p>
            </div>
        </div>
    `;
    
    document.getElementById('systemLock').style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Focus on input after a short delay
    setTimeout(() => {
        const input = document.getElementById('firstTimeCode');
        if (input) {
            input.focus();
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    activateFirstTime();
                }
            });
        }
    }, 500);
}
        
        function activateFirstTime() {
    const enteredCode = document.getElementById('firstTimeCode')?.value.trim() || '';
    const deviceId = getCustomerDeviceId();
    
    if (!enteredCode) {
        showNotification('Please enter an activation code!', 'warning');
        return;
    }
    
    // Check if it's a developer code
    if (enteredCode === developerMasterPassword || enteredCode === developerAccessCode) {
        // Use developer code
        systemStartDate = new Date().toISOString();
        localStorage.setItem('shopYangaSystemStartDate', systemStartDate);
        localStorage.setItem('shopYangaDaysSinceReset', '0');
        
        savePersistentLicense({
            initialized: true,
            firstLaunch: true,
            startDate: systemStartDate,
            licenseType: '34day_trial',
            activated: true,
            activationDate: new Date().toISOString(),
            activationCode: enteredCode,
            developer: developerCompany,
            deviceId: deviceId
        });
        
        const initialResetCode = `SY-INIT-${Date.now().toString(36).toUpperCase().slice(-6)}`;
        lastResetCode = initialResetCode;
        localStorage.setItem('shopYangaLastResetCode', initialResetCode);
        
        hideSystemLock();
        
        showNotification('‚úÖ System activated! 34-day trial started.', 'success');
        
        setTimeout(() => {
            showNotification(`üìû Contact ${developerCompany} for renewal before period ends.`, 'info');
        }, 1000);
        
    } else {
        // Try regular activation code
        const result = applyCustomerActivation(enteredCode);
        
        if (result.success) {
            hideSystemLock();
            showNotification('‚úÖ Activation successful! Restarting app...', 'success');
            
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showNotification(`‚ùå ${result.message}`, 'danger');
            const input = document.getElementById('firstTimeCode');
            if (input) {
                input.style.border = '2px solid var(--danger)';
                input.focus();
            }
        }
    }
}

        // ==================== ENHANCED SYSTEM LOCK (After 34 days) ====================
        function showSystemLock() {
    const deviceId = getCustomerDeviceId();
    const daysUsed = daysSinceReset || 0;
    
    document.getElementById('systemLock').innerHTML = `
        <div class="system-lock-content">
            <h1>‚è∞ 34-Day Period Expired</h1>
            
            <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; margin: 25px 0; backdrop-filter: blur(10px);">
                
                <!-- CURRENT STATUS -->
                <div style="margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">üîí</div>
                    <h3 style="color: white; margin-bottom: 5px;">Renewal Required</h3>
                    <p style="color: rgba(255,255,255,0.8);">
                        Your ${daysUsed} days have been used. Renew for continued access.
                    </p>
                </div>
                
                <!-- DEVICE ID DISPLAY -->
                <div style="margin-bottom: 25px;">
                    <h4 style="color: white; margin-bottom: 10px;">üì± Your Device ID</h4>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                        <code style="color: #fff; font-family: monospace; font-size: 0.9rem; word-break: break-all; display: block; text-align: center;">
                            ${deviceId}
                        </code>
                    </div>
                    <button onclick="copyToClipboard('${deviceId}')" 
                            style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 15px; border-radius: 5px; cursor: pointer; width: 100%;">
                        üìã Copy Device ID
                    </button>
                    <small style="color: rgba(255,255,255,0.7); display: block; text-align: center; margin-top: 5px;">
                        Share this with shop owner for renewal
                    </small>
                </div>
                
                <!-- RENEWAL INPUT -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: white; margin-bottom: 10px;">üîÑ Enter Renewal Code</h4>
                    <input type="text" 
                           id="renewalCodeInput" 
                           class="system-lock-input" 
                           placeholder="Enter renewal code from shop owner"
                           style="margin-bottom: 15px; font-size: 1rem;">
                    
                    <button onclick="validateRenewalCode()" 
                            class="system-lock-btn" 
                            style="background: #d69e2e; color: white; font-weight: bold;">
                        üîÑ Apply Renewal Code
                    </button>
                </div>
                
            </div>
            
            <div class="days-counter">
                <h4 style="color: white; margin-bottom: 10px;">üìû Contact for Renewal</h4>
                <div style="color: rgba(255,255,255,0.8);">
                    <div>${developerCompany}</div>
                    <div>üìû ${developerContactPhone}</div>
                    <div>üìß ${developerContactEmail}</div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        Days used: <strong>${daysUsed}/34</strong>
                    </p>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('systemLock').style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Focus on input
    setTimeout(() => {
        document.getElementById('renewalCodeInput').focus();
    }, 500);
}
        
        function validateRenewalCode() {
    const renewalCode = document.getElementById('renewalCodeInput')?.value.trim() || '';
    const deviceId = getCustomerDeviceId();
    
    if (!renewalCode) {
        showNotification('Please enter renewal code', 'warning');
        return;
    }
    
    // Check developer codes
    if (renewalCode.startsWith('SY-RENEW-') || renewalCode === developerMasterPassword || renewalCode === developerAccessCode) {
        systemStartDate = new Date().toISOString();
        localStorage.setItem('shopYangaSystemStartDate', systemStartDate);
        localStorage.setItem('shopYangaDaysSinceReset', '0');
        
        savePersistentLicense({
            initialized: true,
            firstLaunch: false,
            startDate: systemStartDate,
            licenseType: 'renewed',
            lastRenewal: new Date().toISOString(),
            renewalCode: renewalCode,
            deviceId: deviceId
        });
        
        document.getElementById('renewalCodeInput').value = '';
        hideSystemLock();
        
        showNotification('‚úÖ System renewed! 34-day period restarted.', 'success');
        
        setTimeout(() => {
            location.reload();
        }, 1500);
        
    } else {
        // Try as regular activation code
        const result = applyCustomerActivation(renewalCode);
        
        if (result.success) {
            document.getElementById('renewalCodeInput').value = '';
            hideSystemLock();
            showNotification('‚úÖ Renewal successful!', 'success');
            
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showNotification(`‚ùå ${result.message || 'Invalid renewal code!'}`, 'danger');
            const input = document.getElementById('renewalCodeInput');
            if (input) {
                input.style.border = '2px solid #e53e3e';
                input.focus();
            }
        }
    }
}
        
        function hideSystemLock() {
    const lockScreen = document.getElementById('systemLock');
    if (lockScreen) {
        lockScreen.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}
        
        function check34DayRequirement() {
    // If no start date, needs activation
    if (!systemStartDate) {
        showSystemLock();
        return true;
    }
    
    const startDate = new Date(systemStartDate);
    const currentDate = new Date();
    const daysPassed = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));
    
    document.getElementById('daysCounterDisplay').textContent = daysPassed;
    document.getElementById('footerTrialDays').textContent = daysPassed;
    
    if (daysPassed >= 34) {
        showSystemLock();
        return true;
    }
    
    daysSinceReset = daysPassed;
    localStorage.setItem('shopYangaDaysSinceReset', daysPassed.toString());
    
    updateFooterWarning(daysPassed);
    
    if (daysPassed >= 30) {
        const daysLeft = 34 - daysPassed;
        showNotification(`‚ö†Ô∏è Rental period ends in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}! Contact ${developerCompany} to renew.`, 'warning');
    }
    
    return false;
}
        
        function updateFooterWarning(daysPassed) {
            const daysLeft = 34 - daysPassed;
            const warningElement = document.getElementById('footerTrialWarning');
            const daysElement = document.getElementById('footerTrialDays');
            
            if (warningElement && daysElement) {
                daysElement.textContent = daysPassed;
                warningElement.textContent = `${daysLeft} days remaining`;
                
                if (daysLeft <= 3) {
                    warningElement.style.color = 'var(--danger)';
                } else if (daysLeft <= 7) {
                    warningElement.style.color = 'var(--warning)';
                } else {
                    warningElement.style.color = 'var(--success)';
                }
            }
        }

        // ==================== DEVELOPER ACTIVATION PANEL ====================
function generateSingleActivation() {
    // Get all inputs
    const deviceId = document.getElementById('devCustomerDeviceId')?.value.trim() || '';
    const phone = document.getElementById('devCustomerPhone')?.value.trim() || '';
    const name = document.getElementById('devCustomerName')?.value.trim() || '';
    const days = parseInt(document.getElementById('devActivationDays')?.value) || 34;
    
    // Validate Device ID
    if (!deviceId) {
        showNotification('‚ùå Enter customer Device ID!', 'warning');
        document.getElementById('devCustomerDeviceId')?.focus();
        return;
    }
    
    if (!deviceId.startsWith('DEV-')) {
        showNotification('‚ùå Device ID must start with DEV-', 'warning');
        return;
    }
    
    // Validate Phone
    if (!phone) {
        showNotification('‚ùå Enter customer phone number!', 'warning');
        document.getElementById('devCustomerPhone')?.focus();
        return;
    }
    
    // Validate phone format (Malawi)
    const cleanPhone = phone.replace(/\s/g, '');
    if (!/^(\+265|0)[0-9]{9}$/.test(cleanPhone)) {
        showNotification('‚ùå Enter valid Malawi phone (0883553071 or +265...)', 'warning');
        return;
    }
    
    // Create customer info WITH Device ID
    const customerInfo = {
        deviceId: deviceId,  // THIS IS THE CRITICAL LINK!
        phone: cleanPhone,
        name: name || 'Customer',
        registeredAt: new Date().toISOString(),
        daysRequested: days,
        generatedBy: 'shop_owner'
    };
    
    // Generate the code
const result = generateDeviceLinkedActivationCode(customerInfo, days);

if (!result) return;

// Display the result
const resultDiv = document.getElementById('generatedCodeResult');
if (resultDiv) {
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 2rem; color: var(--success);">‚úÖ</div>
            <h4 style="margin: 10px 0; color: var(--text-color);">Activation Code Generated!</h4>
            
            <div style="margin-bottom: 15px; background: #f0fff4; padding: 10px; border-radius: 5px; text-align: left;">
                <div><strong>üì± Device ID:</strong> ${deviceId}</div>
                <div><strong>üë§ Customer:</strong> ${name || 'Unknown'}</div>
                <div><strong>üìû Phone:</strong> ${cleanPhone}</div>
                <div><strong>üìÖ Days:</strong> ${days} days</div>
                <div><strong>‚è∞ Generated:</strong> ${new Date().toLocaleTimeString()}</div>
            </div>
            
            <!-- SHORT CODE (for reference) -->
            <div style="margin-bottom: 10px;">
                <small>Short Code (Reference):</small>
                <div style="background: #4a5568; color: white; padding: 8px; border-radius: 5px; font-family: monospace; font-size: 0.9rem;">
                    ${result.shortCode}
                </div>
            </div>
            
            <!-- FULL ACTIVATION CODE (CUSTOMER NEEDS THIS) -->
            <div style="margin-bottom: 15px;">
                <small><strong>üìã FULL ACTIVATION CODE (Copy & Send to Customer):</strong></small>
                <div style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 5px; font-family: monospace; font-size: 0.85rem; word-break: break-all; border: 2px solid var(--primary);">
                    ${result.fullCode}
                </div>
                <small style="color: #666; display: block; margin-top: 5px;">
                    Customer must enter THIS EXACT code (all characters)
                </small>
            </div>
            
            <!-- ACTION BUTTONS -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                <button onclick="copyToClipboard('${result.fullCode}')" 
                        style="background: var(--primary); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">
                    üìã Copy FULL Code
                </button>
                
                <button onclick="shareCodeViaSMS('${cleanPhone}', '${result.fullCode}', ${days}, '${deviceId}')" 
                        style="background: #4CAF50; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">
                    üì≤ Send SMS
                </button>
            </div>
            
            <!-- SHARE WHATSAPP -->
            <button onclick="shareCodeViaWhatsApp('${cleanPhone}', '${result.fullCode}', ${days}, '${deviceId}')" 
                    style="background: #25D366; color: white; border: none; padding: 10px; border-radius: 5px; width: 100%; cursor: pointer; margin-top: 10px;">
                üí¨ Share via WhatsApp
            </button>
            
            <!-- INSTRUCTIONS -->
            <div style="margin-top: 15px; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 5px; font-size: 0.8rem; color: #666;">
                <p><strong>üí° Instructions for Customer:</strong></p>
                <ol style="margin: 5px 0 5px 15px;">
                    <li>Copy the FULL code above</li>
                    <li>Open ShopYanga app</li>
                    <li>Go to Settings ‚Üí Activation Portal</li>
                    <li>Paste the ENTIRE code</li>
                    <li>Click "Activate Now"</li>
                </ol>
            </div>
        </div>
    `;
}
    
    // Clear inputs for next customer
    document.getElementById('devCustomerDeviceId').value = '';
    document.getElementById('devCustomerPhone').value = '';
    document.getElementById('devCustomerName').value = '';
    
    showNotification(`‚úÖ Code generated for ${cleanPhone} (Device: ${deviceId.substring(0, 10)}...)`, 'success');
    return activationCode;
}

function generateDeviceLinkedActivationCode(customerInfo, days = 34) {
    // Check if device ID provided
    if (!customerInfo.deviceId || customerInfo.deviceId === 'unknown') {
        alert("‚ùå ERROR: No Device ID provided!\n\nCustomer must share their Device ID first.");
        showNotification("Cannot generate code - need customer's Device ID", "danger");
        return null;
    }
    
    const deviceId = customerInfo.deviceId;
    
    // Create unique short code
    const timestamp = Date.now();
    const randomPart = Math.random().toString(36).substr(2, 6).toUpperCase();
    const deviceShortId = deviceId.split('-')[1]?.substr(0, 4) || 'DEV';
    const shortCode = `SY-${deviceShortId}-${timestamp.toString(36).toUpperCase().slice(-6)}-${randomPart}`;
    
    // Create activation data
    const activationData = {
        code: shortCode,
        deviceId: deviceId,
        customerInfo: customerInfo,
        days: days,
        generatedAt: new Date().toISOString(),
        expiryDate: new Date(Date.now() + (days * 24 * 60 * 60 * 1000)).toISOString(),
        status: 'active'
    };
    
    // Encode the activation data into Base64
    const encodedData = btoa(JSON.stringify(activationData));
    
    // Create FULL code with encoded data
    const fullCode = `${shortCode}-${encodedData}`;
    
    // Store in registry
    activationRegistry[shortCode] = {
        ...activationData,
        encodedData: encodedData,
        verificationHash: generateDeviceLinkedHash(shortCode, deviceId),
        used: false
    };
    
    saveActivationRegistry();
    
    console.log(`‚úÖ Generated code for device: ${deviceId}`);
    console.log(`Short code: ${shortCode}`);
    console.log(`Full code: ${fullCode.substring(0, 50)}...`);
    
    // Return both formats
    return {
        shortCode: shortCode,
        fullCode: fullCode,
        encodedData: encodedData,
        activationData: activationData
    };
}

function generateDeviceLinkedHash(code, deviceId) {
    if (!deviceId) {
        console.error("‚ùå Cannot generate hash: deviceId is missing");
        return 'NO_DEVICE_ID';
    }
    
    // Create a STRONG hash that links code to specific device
    const combinedString = `CODE:${code}:DEVICE:${deviceId}:SALT:SHOPYANGA_SECURE_${new Date().getFullYear()}`;
    
    let hash = 0;
    for (let i = 0; i < combinedString.length; i++) {
        const char = combinedString.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
    }
    
    // Make it longer and more secure
    const secureHash = Math.abs(hash).toString(36).toUpperCase() + 
                      Math.abs(hash * 31).toString(36).toUpperCase();
    
    return secureHash.substr(0, 16); // 16-character hash
}

function updateActivationButtons(code, phone, days) {
    const copyBtn = document.getElementById('copyCodeBtn');
    const smsBtn = document.getElementById('sendSMSBtn');
    
    if (copyBtn && code) {
        copyBtn.style.display = 'block';
        copyBtn.onclick = function() {
            copyToClipboard(code);
        };
    }
    
    if (smsBtn && phone && code) {
        smsBtn.style.display = 'block';
        smsBtn.onclick = function() {
            shareCodeViaSMS(phone, code, days);
        };
    }
}

function shareCodeViaSMS(phone, code, days) {
    const cleanPhone = phone.replace(/\s/g, '');
    const formattedPhone = cleanPhone.startsWith('0') ? '+265' + cleanPhone.substring(1) : cleanPhone;
    
    const message = `ShopYanga Activation Code: ${code}
    
Enter this code in your ShopYanga app to activate for ${days} days.

Go to Settings ‚Üí Customer Activation Portal ‚Üí Enter code.

Need help? Call ${developerContactPhone}`;
    
    const smsLink = `sms:${formattedPhone}?body=${encodeURIComponent(message)}`;
    
    window.open(smsLink, '_blank');
    showNotification('üì± SMS ready to send!', 'info');
}

function generateBulkCodes(count) {
    if (count > 100 && !confirm(`Generate ${count} activation codes? This may take a moment.`)) {
        return;
    }
    
    const bulkCodes = [];
    
    for (let i = 0; i < count; i++) {
        const customerInfo = {
            phone: `BULK-${Date.now()}-${i}`,
            name: `Bulk Customer ${i + 1}`,
            registeredAt: new Date().toISOString(),
            source: 'bulk_generation'
        };
        
        const code = generateScalableActivationCode(customerInfo, 34);
        bulkCodes.push(code);
    }
    
    exportBulkCodes(bulkCodes);
    showNotification(`Generated ${count} bulk activation codes!`, 'success');
}

function exportBulkCodes(codes) {
    const csvContent = "Code,Status,Days,Generated\n" + 
        codes.map(code => `${code},UNUSED,34,${new Date().toLocaleDateString()}`).join("\n");
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `bulk-codes-${Date.now()}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function shareCodeViaSMS(phone, code, days) {
    const message = `ShopYanga Activation Code: ${code}. Enter this code in your app to activate for ${days} days. Code expires in 30 days.`;
    const smsLink = `sms:${phone}?body=${encodeURIComponent(message)}`;
    
    window.open(smsLink, '_blank');
    showNotification('SMS ready to send!', 'info');
}

function copyToClipboard(text) {
    if (!text) return;
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification('Copied to clipboard!', 'success');
        }).catch(() => {
            fallbackCopyText(text);
        });
    } else {
        fallbackCopyText(text);
    }
}

function fallbackCopyText(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        document.execCommand('copy');
        showNotification('Copied to clipboard!', 'success');
    } catch (err) {
        showNotification('Failed to copy text', 'warning');
    }
    
    document.body.removeChild(textArea);
}

function copyTextManual(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showNotification('Copied!', 'success');
}

        // ==================== DEVELOPER FUNCTIONS ====================   
        function showDeveloperPanel() {
    const panel = document.getElementById('devPanel');
    if (!panel) return;
    
    const activeCount = Object.values(activationRegistry).filter(a => a.used).length;
    const unusedCount = Object.values(activationRegistry).filter(a => !a.used).length;
    
    // Count insecure codes (without device ID)
    const insecureCodes = Object.values(activationRegistry).filter(a => !a.deviceId).length;
    
    panel.style.display = 'block';
    panel.innerHTML = `
        <div style="max-width: 400px; max-height: 80vh; overflow-y: auto; padding: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="color: var(--primary); margin: 0;">üë®‚Äçüíª Remote Activation Panel</h4>
                <button onclick="this.parentElement.parentElement.parentElement.style.display='none'" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">√ó</button>
            </div>
            
            <!-- QUICK STATS -->
            <div style="background: var(--light); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Total Codes:</span>
                    <strong>${Object.keys(activationRegistry).length}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Used:</span>
                    <strong style="color: var(--success);">${activeCount}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Available:</span>
                    <strong style="color: var(--warning);">${unusedCount}</strong>
                </div>
            </div>
            
            <!-- ADD SECURITY STATUS SECTION HERE -->
            <div style="margin-top: 15px; padding: 10px; background: ${insecureCodes > 0 ? '#fed7d7' : '#f0fff4'}; border-radius: 5px; border: 1px solid ${insecureCodes > 0 ? '#fc8181' : '#38a169'};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 500;">üîí Security Status:</span>
                    <span style="color: ${insecureCodes > 0 ? '#742a2a' : '#22543d'}">
                        ${insecureCodes > 0 ? '‚ö†Ô∏è Needs Fixing' : '‚úÖ Secure'}
                    </span>
                </div>
                ${insecureCodes > 0 ? 
                    `<small style="display: block; margin-top: 5px; color: #742a2a;">
                        ${insecureCodes} codes need device linking
                        <button onclick="checkCodeSecurity()" style="margin-left: 10px; padding: 2px 5px; background: var(--warning); color: white; border: none; border-radius: 3px; font-size: 0.7rem;">
                            Fix Now
                        </button>
                    </small>` 
                    : ''}
            </div>
            
            <!-- STEP 1: ENTER CUSTOMER'S DEVICE ID -->
            <div style="margin-bottom: 20px; background: #f0f4ff; padding: 15px; border-radius: 10px; border-left: 4px solid var(--primary);">
                <h5 style="margin-bottom: 10px; color: var(--primary);">üì± Step 1: Enter Customer's Device ID</h5>
                <p style="font-size: 0.9rem; margin-bottom: 10px; color: #555;">
                    Customer should send you their Device ID (from their activation screen)
                </p>
                
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-size: 0.9rem; margin-bottom: 3px; font-weight: 500;">Customer Device ID *</label>
                    <input type="text" id="devCustomerDeviceId" placeholder="DEV-ABC123-XYZ789" 
                           style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-color); color: var(--text-color); font-family: monospace;"
                           oninput="validateDeviceId(this.value)">
                    <small style="color: #666; font-size: 0.8rem;">Example: DEV-KL9A2B-C5D6E7</small>
                    <div id="deviceIdValidation" style="font-size: 0.8rem; margin-top: 5px;"></div>
                </div>
                
                <!-- Quick Test Button -->
                <button onclick="testCustomerDeviceId()" style="background: var(--warning); color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 0.8rem; cursor: pointer;">
                    Test Device ID Format
                </button>
            </div>
            
            <!-- STEP 2: ENTER CUSTOMER INFO -->
            <div style="margin-bottom: 20px;">
                <h5 style="margin-bottom: 10px; color: var(--primary);">üë§ Step 2: Enter Customer Details</h5>
                
                <div style="margin-bottom: 8px;">
                    <label style="display: block; font-size: 0.9rem; margin-bottom: 3px; font-weight: 500;">Customer Phone *</label>
                    <input type="text" id="devCustomerPhone" placeholder="0883553071" 
                           style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-color); color: var(--text-color);">
                    <small style="color: #666; font-size: 0.8rem;">Malawi format: 0883553071 or +265...</small>
                </div>
                
                <div style="margin-bottom: 8px;">
                    <label style="display: block; font-size: 0.9rem; margin-bottom: 3px;">Customer Name (Optional)</label>
                    <input type="text" id="devCustomerName" placeholder="John Customer" 
                           style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-color); color: var(--text-color);">
                </div>
                
                <div style="margin-bottom: 8px;">
                    <label style="display: block; font-size: 0.9rem; margin-bottom: 3px;">Activation Days</label>
                    <input type="number" id="devActivationDays" value="34" min="1" max="365" 
                           style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-color); color: var(--text-color);">
                    <small style="color: #666; font-size: 0.8rem;">Default: 34 days (monthly rental)</small>
                </div>
            </div>
            
            <!-- STEP 3: GENERATE CODE -->
            <div style="margin-bottom: 20px;">
                <button onclick="generateSingleActivation()" 
                        style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border: none; padding: 12px; border-radius: 5px; width: 100%; cursor: pointer; font-weight: bold; font-size: 1rem;">
                    üîë Generate Activation Code
                </button>
                
                <!-- Generated Code Display -->
                <div id="generatedCodeResult" style="display: none; background: var(--light); padding: 15px; border-radius: 5px; margin-top: 10px; font-size: 0.9rem; border: 2px dashed var(--primary);"></div>
            </div>
            
            <!-- HELP SECTION -->
            <div style="margin-top: 15px; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 5px; font-size: 0.8rem; color: #666;">
                <p><strong>üí° How it works:</strong></p>
                <ol style="margin: 5px 0 5px 15px;">
                    <li>Customer shares Device ID with you</li>
                    <li>You generate code linked to their phone</li>
                    <li>Send code to customer</li>
                    <li>Customer enters code in their app</li>
                    <li>App activates offline for 34 days</li>
                </ol>
                <p style="margin-top: 10px; font-size: 0.75rem;">
                    <strong>Contact:</strong> ${developerContactPhone}
                </p>
            </div>
        </div>
    `;
    
    // Update buttons if code exists
    updateActivationButtons();
}

function getRecentActivationsHTML() {
    const activations = Object.values(activationRegistry)
        .sort((a, b) => new Date(b.generatedAt) - new Date(a.generatedAt))
        .slice(0, 5);
    
    if (activations.length === 0) {
        return '<p style="text-align: center; color: #666; padding: 10px;">No activations yet</p>';
    }
    
    return activations.map(act => `
        <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #e2e8f0;">
            <div>
                <div style="font-weight: 500;">${act.customerInfo?.phone || 'Unknown'}</div>
                <div style="font-size: 0.75rem; color: #666;">${act.code.substring(0, 10)}...</div>
            </div>
            <div style="text-align: right;">
                <div style="color: ${act.used ? 'var(--success)' : 'var(--warning)'}; font-size: 0.75rem;">
                    ${act.used ? '‚úÖ Used' : 'üìù Active'}
                </div>
                <div style="font-size: 0.7rem; color: #888;">
                    ${new Date(act.generatedAt).toLocaleDateString()}
                </div>
            </div>
        </div>
    `).join('');
}

function exportActivationRegistry() {
    const exportData = {
        exportedAt: new Date().toISOString(),
        totalCodes: Object.keys(activationRegistry).length,
        usedCodes: Object.values(activationRegistry).filter(a => a.used).length,
        unusedCodes: Object.values(activationRegistry).filter(a => !a.used).length,
        activations: activationRegistry
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `shopyanga-activations-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('Activation registry exported!', 'success');
}

function cleanupOldActivations() {
    const cutoffDate = new Date(Date.now() - (90 * 24 * 60 * 60 * 1000)); // 90 days ago
    let removedCount = 0;
    
    Object.keys(activationRegistry).forEach(code => {
        const activation = activationRegistry[code];
        const generatedDate = new Date(activation.generatedAt);
        
        if (generatedDate < cutoffDate && activation.used) {
            delete activationRegistry[code];
            removedCount++;
        }
    });
    
    saveActivationRegistry();
    showNotification(`Cleaned up ${removedCount} old activations`, 'success');
}

function backupActivationData() {
    const backup = {
        timestamp: new Date().toISOString(),
        activationCount: Object.keys(activationRegistry).length,
        deviceId: getCustomerDeviceId(),
        data: activationRegistry
    };
    
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `activation-backup-${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('Activation data backed up!', 'success');
}
        
        function extendTrial(days) {
            if (!systemStartDate) return;
            
            const startDate = new Date(systemStartDate);
            startDate.setDate(startDate.getDate() - days);
            systemStartDate = startDate.toISOString();
            localStorage.setItem('shopYangaSystemStartDate', systemStartDate);
            
            check34DayRequirement();
            showNotification(`‚úÖ Trial extended by ${days} days!`, 'success');
            
            showDeveloperPanel();
        }
        
        function showLicenseInfo() {
            const license = getPersistentLicense();
            alert(`üìã LICENSE INFORMATION:
            
Company: ${developerCompany}
Contact: ${developerContactEmail}
Phone: ${developerContactPhone}

System ID: ${generateDeviceId()}
License Type: ${license?.licenseType || '34-day Trial'}
Activated: ${license?.activationDate ? new Date(license.activationDate).toLocaleDateString() : 'Not activated'}
Days Used: ${daysSinceReset}/34
Status: ${daysSinceReset >= 34 ? 'EXPIRED' : 'ACTIVE'}

Master Codes:
1. ${developerMasterPassword}
2. ${developerAccessCode}

‚ö†Ô∏è For developer use only!`);
        }
        
        function addDeveloperSecretPanel() {
            const header = document.querySelector('.main-header h1');
            let clickCount = 0;
            let clickTimer;
            
            header.style.userSelect = 'none';
            header.style.webkitUserSelect = 'none';
            header.style.msUserSelect = 'none';
            
            header.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                clickCount++;
                clearTimeout(clickTimer);
                clickTimer = setTimeout(() => {
                    clickCount = 0;
                }, 500);
                
                if (clickCount === 6) {
                    showDeveloperPanel();
                    clickCount = 0;
                    
                    const originalColor = header.style.color;
                    header.style.color = 'var(--primary)';
                    setTimeout(() => {
                        header.style.color = originalColor;
                    }, 300);
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    showDeveloperPanel();
                    e.preventDefault();
                }
            });
        }

        // ==================== THEME SYSTEM ====================
        function loadTheme() {
            const savedTheme = localStorage.getItem('shopYangaTheme');
            if (savedTheme) {
                currentTheme = savedTheme;
                applyTheme();
            }
        }
        
        function toggleTheme() {
            currentTheme = currentTheme === 'day' ? 'night' : 'day';
            localStorage.setItem('shopYangaTheme', currentTheme);
            applyTheme();
        }
        
        function applyTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (currentTheme === 'night') {
                body.classList.add('night-mode');
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Day';
            } else {
                body.classList.remove('night-mode');
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Night';
            }
        }

        // ==================== SECURITY SYSTEM ====================
        function loadSecuritySettings() {
            const savedPassword = localStorage.getItem('shopYangaOwnerPassword');
            if (savedPassword) {
                ownerPassword = savedPassword;
            }
            const savedRole = localStorage.getItem('shopYangaCurrentRole');
            if (savedRole) {
                currentUserRole = savedRole;
            }
            updateUserInterface();
        }
        
        function saveSecuritySettings() {
            localStorage.setItem('shopYangaOwnerPassword', ownerPassword);
            localStorage.setItem('shopYangaCurrentRole', currentUserRole);
        }
        
        function switchUserRole() {
            if (currentUserRole === 'seller') {
                showSecurityModal('role');
            } else {
                currentUserRole = 'seller';
                saveSecuritySettings();
                updateUserInterface();
                showNotification('Switched to Seller Mode', 'info');
            }
        }
        
        function showSecurityModal(action = 'addProduct', productId = null) {
            document.getElementById('securityModal').style.display = 'flex';
            document.getElementById('securityPassword').value = '';
            document.getElementById('securityPassword').focus();
            
            const title = document.getElementById('securityTitle');
            const message = document.getElementById('securityMessage');
            
            if (action === 'role') {
                title.textContent = 'üîê Switch to Owner Mode';
                message.textContent = 'Enter owner password to switch to owner mode';
            } else if (action === 'delete') {
                title.textContent = 'üîê Delete Product';
                message.textContent = 'Enter owner password to delete product';
            } else {
                title.textContent = 'üîê Owner Access Required';
                message.textContent = 'Enter owner password to add products to stock';
            }
            
            const securityModal = document.getElementById('securityModal');
            const securityCancel = document.getElementById('securityCancel');
            const securitySubmit = document.getElementById('securitySubmit');
            
            securityCancel.replaceWith(securityCancel.cloneNode(true));
            securitySubmit.replaceWith(securitySubmit.cloneNode(true));
            
            const newCancel = document.getElementById('securityCancel');
            const newSubmit = document.getElementById('securitySubmit');
            
            newCancel.onclick = function() {
                document.getElementById('securityModal').style.display = 'none';
                if (action !== 'role') {
                    showNotification('Action cancelled', 'warning');
                }
            };
            
            newSubmit.onclick = function() {
                const enteredPassword = document.getElementById('securityPassword').value;
                if (enteredPassword === ownerPassword) {
                    document.getElementById('securityModal').style.display = 'none';
                    
                    if (action === 'role') {
                        currentUserRole = 'owner';
                        saveSecuritySettings();
                        updateUserInterface();
                        showNotification('Switched to Owner Mode', 'success');
                    } else if (action === 'delete' && productId) {
                        confirmAndDeleteProduct(productId);
                    } else {
                        showAddProductModal();
                    }
                } else {
                    showNotification('Incorrect password!', 'danger');
                }
            };
            
            document.getElementById('securityPassword').onkeypress = function(e) {
                if (e.key === 'Enter') {
                    newSubmit.click();
                }
            };
            
            securityModal.onclick = function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            };
        }
        
        function secureAddProduct() {
            if (currentUserRole === 'owner') {
                showAddProductModal();
            } else {
                showSecurityModal('addProduct');
            }
        }
        
        function showChangePasswordModal() {
            if (currentUserRole !== 'owner') {
                showNotification('Only owners can change password!', 'warning');
                return;
            }
            
            document.getElementById('changePasswordModal').style.display = 'flex';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            document.getElementById('currentPassword').focus();
            
            const changePasswordModal = document.getElementById('changePasswordModal');
            const changePasswordCancel = document.getElementById('changePasswordCancel');
            const changePasswordSubmit = document.getElementById('changePasswordSubmit');
            
            changePasswordCancel.replaceWith(changePasswordCancel.cloneNode(true));
            changePasswordSubmit.replaceWith(changePasswordSubmit.cloneNode(true));
            
            const newCancel = document.getElementById('changePasswordCancel');
            const newSubmit = document.getElementById('changePasswordSubmit');
            
            newCancel.onclick = function() {
                document.getElementById('changePasswordModal').style.display = 'none';
            };
            
            newSubmit.onclick = function() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                
                if (!currentPassword) {
                    showNotification('Please enter current password!', 'danger');
                    return;
                }
                
                if (currentPassword !== ownerPassword) {
                    showNotification('Current password is incorrect!', 'danger');
                    return;
                }
                
                if (!newPassword || newPassword.length < 4) {
                    showNotification('New password must be at least 4 characters!', 'danger');
                    return;
                }
                
                if (newPassword !== confirmNewPassword) {
                    showNotification('New passwords do not match!', 'danger');
                    return;
                }
                
                ownerPassword = newPassword;
                saveSecuritySettings();
                
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
                
                document.getElementById('changePasswordModal').style.display = 'none';
                showNotification('Password changed successfully!', 'success');
            };
            
            document.getElementById('currentPassword').onkeypress = function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('newPassword').focus();
                }
            };
            
            document.getElementById('newPassword').onkeypress = function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('confirmNewPassword').focus();
                }
            };
            
            document.getElementById('confirmNewPassword').onkeypress = function(e) {
                if (e.key === 'Enter') {
                    newSubmit.click();
                }
            };
            
            changePasswordModal.onclick = function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            };
        }
        
        function updateUserInterface() {
            const roleBadge = document.getElementById('userRole');
            const roleDisplay = document.getElementById('currentRoleDisplay');
            const roleSwitchBtn = document.getElementById('roleSwitchBtn');
            const ownerResetSection = document.getElementById('ownerResetSection');
            const sellerResetSection = document.getElementById('sellerResetSection');
            
            if (currentUserRole === 'owner') {
                roleBadge.innerHTML = 'üëë Owner Mode';
                roleBadge.style.background = 'rgba(56, 161, 105, 0.2)';
                roleBadge.style.color = '#22543d';
                roleDisplay.textContent = 'Owner';
                roleSwitchBtn.innerHTML = 'üë§ Switch to Seller';
                ownerResetSection.style.display = 'block';
                sellerResetSection.style.display = 'none';
                
                const daysLeft = 34 - daysSinceReset;
                if (daysLeft <= 7) {
                    roleBadge.innerHTML += ` ‚è∞ ${daysLeft}d`;
                    roleBadge.style.background = 'rgba(245, 158, 11, 0.2)';
                    roleBadge.style.color = '#744210';
                }
            } else {
                roleBadge.innerHTML = 'üë§ Seller Mode';
                roleBadge.style.background = 'rgba(102, 126, 234, 0.2)';
                roleBadge.style.color = '#434190';
                roleDisplay.textContent = 'Seller';
                roleSwitchBtn.innerHTML = 'üîê Switch to Owner';
                ownerResetSection.style.display = 'none';
                sellerResetSection.style.display = 'block';
                
                const daysLeft = 34 - daysSinceReset;
                if (daysLeft <= 7) {
                    roleBadge.innerHTML += ` ‚è∞ ${daysLeft}d`;
                    roleBadge.style.background = 'rgba(245, 158, 11, 0.2)';
                    roleBadge.style.color = '#744210';
                }
            }
        }

        // ==================== INVENTORY MANAGEMENT ====================
        function loadInventoryTable() {
            const products = getProducts();
            const settings = getShopSettings();
            
            if (products.length === 0) {
                document.getElementById('inventoryTable').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>No Products Yet</h3>
                        <p>Add your first product to get started</p>
                        <button class="btn btn-primary" onclick="secureAddProduct()" style="margin-top: 15px;">
                            ‚ûï Add First Product
                        </button>
                    </div>
                `;
                updateInventorySummary(products);
                return;
            }
            
            let filteredProducts = [...products];
            const searchTerm = document.getElementById('searchInventory')?.value?.toLowerCase() || '';
            const categoryFilter = document.getElementById('filterCategory')?.value || '';
            const stockFilter = document.getElementById('filterStock')?.value || '';
            
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.description && p.description.toLowerCase().includes(searchTerm))
                );
            }
            
            if (categoryFilter) {
                filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
            }
            
            if (stockFilter === 'low') {
                filteredProducts = filteredProducts.filter(p => p.quantity <= (settings.lowStockThreshold || 5));
            } else if (stockFilter === 'out') {
                filteredProducts = filteredProducts.filter(p => p.quantity === 0);
            }
            
            const table = document.getElementById('inventoryTable');
            table.innerHTML = filteredProducts.map(product => {
                const isLowStock = product.quantity <= (settings.lowStockThreshold || 5);
                const isOutOfStock = product.quantity === 0;
                const profitPerUnit = product.cost ? product.price - product.cost : null;
                const totalProfit = profitPerUnit ? profitPerUnit * product.quantity : null;
                
                let expiryStatus = '';
                if (product.expiryDate) {
                    const expiryDate = new Date(product.expiryDate);
                    const now = new Date();
                    const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntilExpiry < 0) {
                        expiryStatus = `<span class="badge badge-danger">Expired</span>`;
                    } else if (daysUntilExpiry <= 7) {
                        expiryStatus = `<span class="badge badge-warning">${daysUntilExpiry}d</span>`;
                    } else {
                        expiryStatus = `<span>${formatDate(expiryDate)}</span>`;
                    }
                }
                
                return `
                    <div class="table-row">
                        <div>
                            <strong>${product.name}</strong>
                            ${product.description ? `<br><small style="color: #666;">${product.description.substring(0, 30)}${product.description.length > 30 ? '...' : ''}</small>` : ''}
                        </div>
                        <div>
                            <span class="badge badge-info">${product.category}</span>
                        </div>
                        <div>
                            <div>Price: <strong>${formatCurrency(product.price)}</strong></div>
                            ${product.cost ? `<div>Cost: ${formatCurrency(product.cost)}</div>` : ''}
                        </div>
                        <div>
                            <span style="color: ${isOutOfStock ? 'var(--danger)' : isLowStock ? 'var(--warning)' : 'var(--success)'}; font-weight: bold;">
                                ${product.quantity} ${product.unit || 'pcs'}
                            </span>
                            ${isLowStock ? '<div class="badge badge-warning">LOW</div>' : ''}
                        </div>
                        <div>
                            ${expiryStatus || '-'}
                        </div>
                        <div>
                            ${profitPerUnit ? `
                                <div>Unit: ${formatCurrency(profitPerUnit)}</div>
                                <div>Total: ${formatCurrency(totalProfit)}</div>
                            ` : 'N/A'}
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn btn-sm" onclick="sellProductFromInventory('${product.id}')" style="background: var(--success); color: white;" ${isOutOfStock ? 'disabled' : ''}>
                                Sell
                            </button>
                            <button class="action-btn btn-sm" onclick="editProduct('${product.id}')" style="background: var(--warning); color: white;" ${currentUserRole === 'seller' ? 'disabled' : ''}>
                                Edit
                            </button>
                            <button class="action-btn btn-sm" onclick="deleteProduct('${product.id}')" style="background: var(--danger); color: white;">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateInventorySummary(filteredProducts);
        }
        
        function deleteProduct(productId) {
            if (currentUserRole === 'seller') {
                showSecurityModal('delete', productId);
            } else {
                confirmAndDeleteProduct(productId);
            }
        }
        
        function confirmAndDeleteProduct(productId) {
            const products = getProducts();
            const product = products.find(p => p.id === productId);
            
            if (!product) return;
            
            let message = `Are you sure you want to delete "${product.name}"?`;
            if (product.quantity > 0) {
                message = `"${product.name}" has ${product.quantity} in stock.\n\nAre you sure you want to delete it?`;
            }
            
            if (!confirm(message)) {
                return;
            }
            
            const updatedProducts = products.filter(p => p.id !== productId);
            saveProducts(updatedProducts);
            showNotification(`Product "${product.name}" deleted!`, 'danger');
            loadInventoryTable();
            loadDashboard();
        }
        
        function filterInventory() {
            loadInventoryTable();
        }
        
        function updateInventorySummary(products) {
            const totalValue = products.reduce((sum, p) => sum + (p.price * p.quantity), 0);
            const totalCost = products.reduce((sum, p) => sum + ((p.cost || 0) * p.quantity), 0);
            const totalPotentialProfit = totalValue - totalCost;
            const lowStockCount = products.filter(p => p.quantity <= (getShopSettings().lowStockThreshold || 5)).length;
            
            document.getElementById('totalInventoryValue').textContent = formatCurrency(totalValue);
            document.getElementById('totalPotentialProfit').textContent = formatCurrency(totalPotentialProfit);
            document.getElementById('totalLowStock').textContent = lowStockCount;
        }
        
        function showAddProductModal() {
            document.getElementById('productModal').style.display = 'flex';
            document.getElementById('productForm').reset();
            document.getElementById('productForm').onsubmit = handleAddProduct;
            document.getElementById('modalProductExpiry').valueAsDate = null;
            
            // Load categories into dropdown
            const categories = getCategories();
            const categorySelect = document.getElementById('modalProductCategory');
            categorySelect.innerHTML = '<option value="">Select Category</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }
        
        function handleAddProduct(e) {
            e.preventDefault();
            
            const product = {
                id: 'prod_' + Date.now(),
                name: document.getElementById('modalProductName').value.trim(),
                category: document.getElementById('modalProductCategory').value,
                price: parseFloat(document.getElementById('modalProductPrice').value) || 0,
                cost: parseFloat(document.getElementById('modalProductCost').value) || null,
                quantity: parseInt(document.getElementById('modalProductQuantity').value) || 0,
                unit: document.getElementById('modalProductUnit').value,
                expiryDate: document.getElementById('modalProductExpiry').value || null,
                description: document.getElementById('modalProductDescription').value.trim() || null,
                addedDate: new Date().toISOString()
            };
            
            if (!product.name || !product.category || product.price <= 0) {
                showNotification('Please fill all required fields correctly!', 'danger');
                return;
            }
            
            if (product.quantity < 0) {
                showNotification('Quantity cannot be negative!', 'danger');
                return;
            }
            
            const products = getProducts();
            products.push(product);
            saveProducts(products);
            
            closeModal();
            showNotification(`Product "${product.name}" added successfully!`, 'success');
            
            loadInventoryTable();
            loadDashboard();
        }
        
        function sellProductFromInventory(productId) {
            showTab('sales');
            setTimeout(() => {
                startNewSale();
                const productSelect = document.getElementById('saleProduct');
                if (productSelect) {
                    productSelect.value = productId;
                    updateSaleProduct();
                }
            }, 100);
        }
        
        function editProduct(productId) {
            if (currentUserRole === 'seller') {
                showNotification('Only owners can edit products!', 'warning');
                return;
            }
            
            const products = getProducts();
            const product = products.find(p => p.id === productId);
            
            if (!product) return;
            
            showAddProductModal();
            
            document.getElementById('modalProductName').value = product.name;
            document.getElementById('modalProductCategory').value = product.category;
            document.getElementById('modalProductPrice').value = product.price;
            document.getElementById('modalProductCost').value = product.cost || '';
            document.getElementById('modalProductQuantity').value = product.quantity;
            document.getElementById('modalProductUnit').value = product.unit || 'pcs';
            document.getElementById('modalProductExpiry').value = product.expiryDate || '';
            document.getElementById('modalProductDescription').value = product.description || '';
            
            const form = document.getElementById('productForm');
            form.onsubmit = function(e) {
                e.preventDefault();
                
                const updatedProduct = {
                    ...product,
                    name: document.getElementById('modalProductName').value.trim(),
                    category: document.getElementById('modalProductCategory').value,
                    price: parseFloat(document.getElementById('modalProductPrice').value) || 0,
                    cost: parseFloat(document.getElementById('modalProductCost').value) || null,
                    quantity: parseInt(document.getElementById('modalProductQuantity').value) || 0,
                    unit: document.getElementById('modalProductUnit').value,
                    expiryDate: document.getElementById('modalProductExpiry').value || null,
                    description: document.getElementById('modalProductDescription').value.trim() || null
                };
                
                const updatedProducts = products.map(p => 
                    p.id === productId ? updatedProduct : p
                );
                
                saveProducts(updatedProducts);
                closeModal();
                showNotification(`Product "${updatedProduct.name}" updated!`, 'success');
                loadInventoryTable();
                loadDashboard();
            };
        }
        
        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        // ==================== SALES MANAGEMENT ====================
        function startNewSale() {
            document.getElementById('saleProcess').style.display = 'block';
            document.getElementById('salesHistory').style.display = 'none';
            
            currentSaleCart = [];
            updateSaleCartDisplay();
            
            loadProductDropdown();
            updateSaleTotal();
            
            setTimeout(() => {
                document.getElementById('productSearch').focus();
            }, 100);
        }
        
        function loadProductDropdown() {
            const products = getProducts().filter(p => p.quantity > 0);
            const select = document.getElementById('saleProduct');
            
            select.innerHTML = '<option value="">Select Product</option>' +
                products.map(p => `
                    <option value="${p.id}">
                        ${p.name} - ${formatCurrency(p.price)} (Stock: ${p.quantity})
                    </option>
                `).join('');
        }
        
        function updateSaleProduct() {
            const productId = document.getElementById('saleProduct').value;
            const products = getProducts();
            const product = products.find(p => p.id == productId);
            
            if (product) {
                document.getElementById('saleQuantity').max = product.quantity;
                document.getElementById('saleQuantity').value = 1;
                updateSaleTotal();
            }
        }
        
        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase().trim();
            const products = getProducts().filter(p => p.quantity > 0);
            const select = document.getElementById('saleProduct');
            
            if (!searchTerm) {
                loadProductDropdown();
                return;
            }
            
            const filteredProducts = products.filter(p => 
                p.name.toLowerCase().includes(searchTerm) ||
                (p.description && p.description.toLowerCase().includes(searchTerm)) ||
                p.category.toLowerCase().includes(searchTerm)
            );
            
            if (filteredProducts.length === 0) {
                select.innerHTML = '<option value="">No matching products found</option>';
                showNotification('Product not found! Try browsing all products.', 'warning');
                return;
            }
            
            select.innerHTML = '<option value="">Select Product</option>' +
                filteredProducts.map(p => `
                    <option value="${p.id}">
                        ${p.name} - ${formatCurrency(p.price)} (Stock: ${p.quantity})
                    </option>
                `).join('');
            
            if (filteredProducts.length === 1) {
                select.value = filteredProducts[0].id;
                updateSaleProduct();
                showNotification(`Found "${filteredProducts[0].name}"`, 'success');
            }
        }
        
        function openProductSearchModal() {
            document.getElementById('productSearchModal').style.display = 'flex';
            filterModalProducts();
            
            setTimeout(() => {
                document.getElementById('modalProductSearch').focus();
            }, 100);
        }
        
        function closeProductSearchModal() {
            document.getElementById('productSearchModal').style.display = 'none';
        }
        
        function filterModalProducts() {
            const searchTerm = document.getElementById('modalProductSearch').value.toLowerCase().trim();
            const categoryFilter = document.getElementById('modalProductCategoryFilter').value;
            const stockFilter = document.getElementById('modalStockFilter').value;
            const products = getProducts();
            
            let filteredProducts = products;
            
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.description && p.description.toLowerCase().includes(searchTerm))
                );
            }
            
            if (categoryFilter) {
                filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
            }
            
            if (stockFilter === 'instock') {
                filteredProducts = filteredProducts.filter(p => p.quantity > 0);
            } else if (stockFilter === 'low') {
                const lowStockThreshold = getShopSettings().lowStockThreshold || 5;
                filteredProducts = filteredProducts.filter(p => p.quantity <= lowStockThreshold && p.quantity > 0);
            }
            
            const container = document.getElementById('modalProductsList');
            
            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üîç</div>
                        <h3>No products found</h3>
                        <p>Try a different search term or filter</p>
                        <button class="btn btn-primary" onclick="closeProductSearchModal(); secureAddProduct();" style="margin-top: 15px;">
                            ‚ûï Add New Product
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredProducts.map(product => {
                const isLowStock = product.quantity <= (getShopSettings().lowStockThreshold || 5);
                const isOutOfStock = product.quantity === 0;
                
                return `
                    <div class="table-row" onclick="selectProductForSale('${product.id}')" style="cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: background 0.2s;" 
                         onmouseover="this.style.background='var(--light)'" onmouseout="this.style.background=''">
                        <div>
                            <strong>${product.name}</strong>
                            ${product.description ? `<br><small style="color: #666;">${product.description.substring(0, 30)}${product.description.length > 30 ? '...' : ''}</small>` : ''}
                        </div>
                        <div>
                            <span class="badge badge-info">${product.category}</span>
                        </div>
                        <div>
                            <strong>${formatCurrency(product.price)}</strong>
                        </div>
                        <div>
                            <span style="color: ${isOutOfStock ? 'var(--danger)' : isLowStock ? 'var(--warning)' : 'var(--success)'}; font-weight: bold;">
                                ${product.quantity} ${product.unit || 'pcs'}
                            </span>
                            ${isLowStock ? '<span class="badge badge-warning">LOW</span>' : ''}
                        </div>
                        <div style="text-align: center;">
                            <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); selectProductForSale('${product.id}')">
                                Select
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectProductForSale(productId) {
            const select = document.getElementById('saleProduct');
            select.value = productId;
            updateSaleProduct();
            closeProductSearchModal();
            document.getElementById('saleQuantity').focus();
            showNotification('Product selected for sale', 'success');
        }
        
        function addToSaleCart() {
            const productId = document.getElementById('saleProduct').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value) || 1;
            
            if (!productId) {
                showNotification('Please select a product!', 'warning');
                return;
            }
            
            if (quantity <= 0) {
                showNotification('Quantity must be at least 1!', 'danger');
                return;
            }
            
            const products = getProducts();
            const product = products.find(p => p.id == productId);
            
            if (!product) {
                showNotification('Product not found!', 'danger');
                return;
            }
            
            if (quantity > product.quantity) {
                showNotification(`Only ${product.quantity} available in stock!`, 'danger');
                return;
            }
            
            const existingIndex = currentSaleCart.findIndex(item => item.productId == productId);
            
            if (existingIndex > -1) {
                currentSaleCart[existingIndex].quantity += quantity;
                currentSaleCart[existingIndex].total = currentSaleCart[existingIndex].price * currentSaleCart[existingIndex].quantity;
            } else {
                currentSaleCart.push({
                    productId: productId,
                    productName: product.name,
                    price: product.price,
                    cost: product.cost || 0,
                    quantity: quantity,
                    total: product.price * quantity
                });
            }
            
            updateSaleCartDisplay();
            updateSaleTotal();
            
            document.getElementById('saleProduct').value = '';
            document.getElementById('saleQuantity').value = 1;
            document.getElementById('productSearch').value = '';
            document.getElementById('productSearch').focus();
            
            showNotification(`Added ${quantity} √ó ${product.name} to cart`, 'success');
        }
        
        function updateSaleCartDisplay() {
            const container = document.getElementById('saleCart');
            
            if (currentSaleCart.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No products added yet</p>';
                return;
            }
            
            container.innerHTML = currentSaleCart.map((item, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--light); border-radius: 8px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <strong>${item.productName}</strong>
                        <div style="color: #666; font-size: 0.9rem;">
                            ${item.quantity} √ó ${formatCurrency(item.price)} = ${formatCurrency(item.total)}
                        </div>
                    </div>
                    <button onclick="removeFromSaleCart(${index})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem; padding: 5px;">
                        √ó
                    </button>
                </div>
            `).join('');
        }
        
        function removeFromSaleCart(index) {
            if (index >= 0 && index < currentSaleCart.length) {
                currentSaleCart.splice(index, 1);
                updateSaleCartDisplay();
                updateSaleTotal();
            }
        }
        
        function updateSaleTotal() {
            const subtotal = currentSaleCart.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
            const total = Math.max(0, subtotal - discount);
            
            document.getElementById('saleSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('saleTotal').textContent = formatCurrency(total);
        }
        
        function cancelSale() {
            if (currentSaleCart.length > 0 && !confirm('Cancel this sale? All items will be removed.')) {
                return;
            }
            
            currentSaleCart = [];
            document.getElementById('saleProcess').style.display = 'none';
            document.getElementById('salesHistory').style.display = 'block';
            showNotification('Sale cancelled', 'warning');
        }
        
        function completeSale() {
            console.log('Complete sale function called');
            
            if (currentSaleCart.length === 0) {
                showNotification('Add some products to the cart first!', 'warning');
                return;
            }
            
            const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const subtotal = currentSaleCart.reduce((sum, item) => sum + item.total, 0);
            const total = Math.max(0, subtotal - discount);
            
            let message = '<div style="font-size: 0.9rem;">';
            message += '<strong>ITEMS:</strong><br>';
            currentSaleCart.forEach(item => {
                message += `‚Ä¢ ${item.quantity} √ó ${item.productName}<br>`;
                message += `&nbsp;&nbsp;${formatCurrency(item.price)} √ó ${item.quantity} = ${formatCurrency(item.total)}<br>`;
            });
            message += `<br><strong>SUBTOTAL:</strong><br>${formatCurrency(subtotal)}<br>`;
            message += `<strong>DISCOUNT:</strong><br>${formatCurrency(discount)}<br>`;
            message += `<strong>TOTAL:</strong><br><span style="font-size: 1.2rem; font-weight: bold; color: var(--success);">${formatCurrency(total)}</span><br>`;
            message += `<strong>PAYMENT:</strong> ${paymentMethod}<br>`;
            message += '</div>';
            
            document.getElementById('confirmMessage').innerHTML = message;
            document.getElementById('confirmModal').style.display = 'flex';
            
            const confirmModal = document.getElementById('confirmModal');
            const confirmOK = document.getElementById('confirmOK');
            const confirmCancel = document.getElementById('confirmCancel');
            
            confirmOK.replaceWith(confirmOK.cloneNode(true));
            confirmCancel.replaceWith(confirmCancel.cloneNode(true));
            
            const newConfirmOK = document.getElementById('confirmOK');
            const newConfirmCancel = document.getElementById('confirmCancel');
            
            newConfirmOK.onclick = function() {
                console.log('User confirmed sale via custom modal');
                document.getElementById('confirmModal').style.display = 'none';
                processSaleCompletion(discount, paymentMethod, subtotal, total);
            };
            
            newConfirmCancel.onclick = function() {
                console.log('User cancelled sale via custom modal');
                document.getElementById('confirmModal').style.display = 'none';
                showNotification('Sale cancelled', 'warning');
            };
            
            confirmModal.onclick = function(e) {
                if (e.target === this) {
                    console.log('User closed modal by clicking outside');
                    this.style.display = 'none';
                    showNotification('Sale cancelled', 'warning');
                }
            };
        }

        function processSaleCompletion(discount, paymentMethod, subtotal, total) {
            console.log('Processing sale completion...');
            
            const products = getProducts();
            let stockError = false;
            let errorProduct = '';
            
            for (const cartItem of currentSaleCart) {
                const product = products.find(p => p.id == cartItem.productId);
                if (!product) {
                    showNotification(`Error: Product "${cartItem.productName}" not found!`, 'danger');
                    return;
                }
                if (product.quantity < cartItem.quantity) {
                    stockError = true;
                    errorProduct = product.name;
                    break;
                }
            }
            
            if (stockError) {
                showNotification(`Not enough stock for "${errorProduct}"!`, 'danger');
                return;
            }
            
            for (const cartItem of currentSaleCart) {
                const productIndex = products.findIndex(p => p.id == cartItem.productId);
                if (productIndex > -1) {
                    products[productIndex].quantity -= cartItem.quantity;
                    console.log(`Updated ${cartItem.productName} stock: ${products[productIndex].quantity} remaining`);
                }
            }
            
            saveProducts(products);
            
            const sale = {
                id: 'sale_' + Date.now(),
                items: JSON.parse(JSON.stringify(currentSaleCart)),
                subtotal: subtotal,
                discount: discount,
                total: total,
                paymentMethod: paymentMethod,
                date: new Date().toISOString(),
                status: 'completed'
            };
            
            const sales = getSales();
            sales.push(sale);
            saveSales(sales);
            
            showNotification(`‚úÖ Sale completed! Total: ${formatCurrency(total)}`, 'success');
            
            currentSaleCart = [];
            document.getElementById('saleDiscount').value = 0;
            document.getElementById('paymentMethod').value = 'cash';
            updateSaleCartDisplay();
            updateSaleTotal();
            document.getElementById('saleProcess').style.display = 'none';
            document.getElementById('salesHistory').style.display = 'block';
            
            loadSalesHistory();
            loadDashboard();
            loadInventoryTable();
            
            console.log('Sale processed successfully');
        }
        
        function loadSalesHistory() {
    const sales = getSales().sort((a, b) => new Date(b.date) - new Date(a.date));
    const dateFrom = document.getElementById('salesDateFrom')?.value;
    const dateTo = document.getElementById('salesDateTo')?.value;
    const filterType = document.getElementById('salesFilter')?.value || 'all';
    
    let filteredSales = [...sales];
    
                // ‚úÖ INSTANT FILTER: Works immediately when dates are selected
    if (dateFrom || dateTo) {
        // Show what we're filtering
        console.log(`Filtering from ${dateFrom || 'any'} to ${dateTo || 'any'}`);
        
        filteredSales = sales.filter(sale => {
            const saleDate = sale.date.split('T')[0];
            const saleDateObj = new Date(saleDate);
            
            let matches = true;
            
            // Check "from" date
            if (dateFrom) {
                const fromDateObj = new Date(dateFrom);
                if (saleDateObj < fromDateObj) {
                    matches = false;
                }
            }
            
            // Check "to" date
            if (dateTo && matches) { // Only check if still matching
                const toDateObj = new Date(dateTo);
                toDateObj.setHours(23, 59, 59, 999); // Include entire day
                if (saleDateObj > toDateObj) {
                    matches = false;
                }
            }
            
            return matches;
        });
        
        console.log(`Found ${filteredSales.length} sales in date range`);
    }
    
    // ‚úÖ Calculate pagination
    const totalPages = Math.ceil(filteredSales.length / SALES_PER_PAGE);
    const startIndex = (currentSalesPage - 1) * SALES_PER_PAGE;
    const endIndex = startIndex + SALES_PER_PAGE;
    const pageSales = filteredSales.slice(startIndex, endIndex);
    
    // Display sales for current page
    const table = document.getElementById('salesTable');
    
    if (pageSales.length === 0) {
        table.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üí∞</div>
                <h3>No Sales Found</h3>
                <p>No sales match your filter criteria</p>
                <button class="btn btn-success" onclick="startNewSale()" style="margin-top: 15px;">
                    üõçÔ∏è Make New Sale
                </button>
            </div>
        `;
        return;
    }
    
    table.innerHTML = pageSales.map(sale => {
        const itemCount = sale.items?.reduce((sum, item) => sum + item.quantity, 0) || 0;
        
        return `
            <div class="table-row">
                <div>${formatDate(new Date(sale.date))}<br><small>${new Date(sale.date).toLocaleTimeString()}</small></div>
                <div>${itemCount} items</div>
                <div><strong>${formatCurrency(sale.total)}</strong></div>
                <div>
                    <span class="badge badge-info">${sale.paymentMethod}</span>
                </div>
                <div class="action-buttons">
                    <button class="action-btn btn-sm" onclick="viewSaleDetails('${sale.id}')" style="background: var(--primary); color: white;">
                        View
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    // ‚úÖ ADD PAGINATION CONTROLS
    if (totalPages > 1) {
        const paginationHTML = `
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px 0; padding: 15px; background: var(--light); border-radius: 10px;">
                <button class="btn btn-sm" onclick="previousSalesPage()" ${currentSalesPage === 1 ? 'disabled' : ''}>
                    ‚óÄ Previous
                </button>
                
                <div style="font-size: 0.9rem; color: var(--text-color);">
                    Page <strong>${currentSalesPage}</strong> of <strong>${totalPages}</strong>
                    <br>
                    <small>Showing ${startIndex + 1}-${Math.min(endIndex, filteredSales.length)} of ${filteredSales.length} sales</small>
                </div>
                
                <button class="btn btn-sm" onclick="nextSalesPage()" ${currentSalesPage === totalPages ? 'disabled' : ''}>
                    Next ‚ñ∂
                </button>
            </div>
        `;
        
        table.innerHTML += paginationHTML;
    }
    
    // ‚úÖ ADD TOTAL SUMMARY AT BOTTOM
    const totalSalesAmount = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
    const totalItemsSold = filteredSales.reduce((sum, sale) => {
        return sum + (sale.items?.reduce((itemSum, item) => itemSum + item.quantity, 0) || 0);
    }, 0);
    
    const summaryRow = `
        <div style="background: var(--light); padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid var(--primary);">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                <div>
                    <div style="font-size: 0.9rem; color: #666;">Total Sales</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">${filteredSales.length}</div>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: #666;">Items Sold</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">${totalItemsSold}</div>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: #666;">Total Revenue</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);">${formatCurrency(totalSalesAmount)}</div>
                </div>
            </div>
            ${dateFrom && dateTo ? 
                `<div style="text-align: center; margin-top: 10px; font-size: 0.9rem; color: #666;">
                    Period: ${formatDate(new Date(dateFrom))} to ${formatDate(new Date(dateTo))}
                </div>` 
                : ''
            }
        </div>
    `;
    
    table.innerHTML += summaryRow;
}
        
        function viewSaleDetails(saleId) {
            const sales = getSales();
            const sale = sales.find(s => s.id === saleId);
            
            if (!sale) {
                showNotification('Sale not found', 'warning');
                return;
            }
            
            let details = `=== Sale Details ===\n`;
            details += `Date: ${formatDate(new Date(sale.date))}\n`;
            details += `Time: ${new Date(sale.date).toLocaleTimeString()}\n`;
            details += `Payment: ${sale.paymentMethod}\n`;
            details += `Subtotal: ${formatCurrency(sale.subtotal)}\n`;
            details += `Discount: ${formatCurrency(sale.discount)}\n`;
            details += `Total: ${formatCurrency(sale.total)}\n\n`;
            details += `=== Items ===\n`;
            
            sale.items?.forEach(item => {
                details += `${item.quantity} √ó ${item.productName} = ${formatCurrency(item.total)}\n`;
            });
            
            alert(details);
        }

        // ==================== EXPENSE MANAGEMENT ====================
        function loadExpensesTable() {
            const expenses = getExpenses().sort((a, b) => new Date(b.date) - new Date(a.date));
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            const monthlyExpenses = expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });
            
            const weeklyExpenses = expenses.filter(e => new Date(e.date) >= oneWeekAgo);
            const todayExpenses = expenses.filter(e => 
                new Date(e.date).toDateString() === now.toDateString()
            );
            
            const monthTotal = monthlyExpenses.reduce((sum, e) => sum + e.amount, 0);
            const weekTotal = weeklyExpenses.reduce((sum, e) => sum + e.amount, 0);
            const todayTotal = todayExpenses.reduce((sum, e) => sum + e.amount, 0);
            const avgDaily = monthlyExpenses.length > 0 ? monthTotal / 30 : 0;
            
            document.getElementById('monthExpenses').textContent = formatCurrency(monthTotal);
            document.getElementById('weekExpenses').textContent = formatCurrency(weekTotal);
            document.getElementById('todayExpenses').textContent = formatCurrency(todayTotal);
            document.getElementById('avgDailyExpenses').textContent = formatCurrency(avgDaily);
            
            if (expenses.length === 0) {
                document.getElementById('expensesTable').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∏</div>
                        <h3>No Expenses Yet</h3>
                        <p>Track your shop expenses here</p>
                        <button class="btn btn-warning" onclick="showAddExpenseModal()" style="margin-top: 15px;">
                            ‚ûï Add First Expense
                        </button>
                    </div>
                `;
                return;
            }
            
            const table = document.getElementById('expensesTable');
            table.innerHTML = expenses.slice(0, 20).map(expense => {
                return `
                    <div class="table-row">
                        <div>${formatDate(new Date(expense.date))}</div>
                        <div>
                            <span class="badge" style="background: ${getCategoryColor(expense.category)}; color: white;">
                                ${expense.category}
                            </span>
                        </div>
                        <div>
                            ${expense.description || 'No description'}
                        </div>
                        <div><strong>${formatCurrency(expense.amount)}</strong></div>
                        <div>${expense.paymentMethod || 'Cash'}</div>
                        <div class="action-buttons">
                            <button class="action-btn btn-sm" onclick="editExpense('${expense.id}')" style="background: var(--warning); color: white;">
                                Edit
                            </button>
                            <button class="action-btn btn-sm" onclick="deleteExpense('${expense.id}')" style="background: var(--danger); color: white;">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getCategoryColor(category) {
            const colors = {
                'rent': '#e53e3e',
                'utilities': '#3182ce',
                'salaries': '#38a169',
                'stock': '#d69e2e',
                'maintenance': '#805ad5',
                'transport': '#319795',
                'other': '#718096'
            };
            return colors[category] || '#718096';
        }
        
        function showAddExpenseModal() {
            document.getElementById('expenseModal').style.display = 'flex';
            document.getElementById('expenseForm').reset();
            document.getElementById('modalExpenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expenseForm').onsubmit = handleAddExpense;
        }
        
        function handleAddExpense(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('modalExpenseAmount').value);
            const category = document.getElementById('modalExpenseCategory').value;
            const description = document.getElementById('modalExpenseDescription').value.trim();
            const paymentMethod = document.getElementById('modalExpensePayment').value;
            const date = document.getElementById('modalExpenseDate').value || new Date().toISOString().split('T')[0];
            
            if (amount <= 0 || isNaN(amount)) {
                showNotification('Amount must be greater than 0!', 'danger');
                return;
            }
            
            if (!category || !description || !paymentMethod) {
                showNotification('Please fill all required fields!', 'danger');
                return;
            }
            
            const expense = {
                id: 'exp_' + Date.now(),
                amount: amount,
                category: category,
                description: description,
                paymentMethod: paymentMethod,
                date: date
            };
            
            const expenses = getExpenses();
            expenses.push(expense);
            saveExpenses(expenses);
            
            closeExpenseModal();
            showNotification(`Expense of ${formatCurrency(amount)} recorded!`, 'success');
            loadExpensesTable();
            loadDashboard();
        }
        
        function editExpense(expenseId) {
            const expenses = getExpenses();
            const expense = expenses.find(e => e.id === expenseId);
            
            if (!expense) return;
            
            showAddExpenseModal();
            
            document.getElementById('modalExpenseAmount').value = expense.amount;
            document.getElementById('modalExpenseCategory').value = expense.category;
            document.getElementById('modalExpenseDescription').value = expense.description;
            document.getElementById('modalExpensePayment').value = expense.paymentMethod;
            document.getElementById('modalExpenseDate').value = expense.date;
            
            const form = document.getElementById('expenseForm');
            form.onsubmit = function(e) {
                e.preventDefault();
                
                const updatedExpense = {
                    ...expense,
                    amount: parseFloat(document.getElementById('modalExpenseAmount').value),
                    category: document.getElementById('modalExpenseCategory').value,
                    description: document.getElementById('modalExpenseDescription').value.trim(),
                    paymentMethod: document.getElementById('modalExpensePayment').value,
                    date: document.getElementById('modalExpenseDate').value
                };
                
                const updatedExpenses = expenses.map(e => 
                    e.id === expenseId ? updatedExpense : e
                );
                
                saveExpenses(updatedExpenses);
                closeExpenseModal();
                showNotification('Expense updated!', 'success');
                loadExpensesTable();
                loadDashboard();
            };
        }
        
        function deleteExpense(expenseId) {
            if (!confirm('Delete this expense?')) return;
            
            const expenses = getExpenses();
            const expense = expenses.find(e => e.id === expenseId);
            const updatedExpenses = expenses.filter(e => e.id !== expenseId);
            
            saveExpenses(updatedExpenses);
            showNotification(`Expense of ${formatCurrency(expense?.amount || 0)} deleted!`, 'danger');
            loadExpensesTable();
            loadDashboard();
        }
        
        function closeExpenseModal() {
            document.getElementById('expenseModal').style.display = 'none';
        }

        // ==================== DASHBOARD ====================
        function loadDashboard() {
    const products = getProducts();
    const sales = getSales();
    const expenses = getExpenses();
    const today = new Date().toISOString().split('T')[0];
    
    console.log("=== üîç DASHBOARD DEBUG ===");
    console.log("Total sales in database:", sales.length);
    
    // ‚úÖ TODAY'S SALES
    const todaySales = sales.filter(s => s.date.startsWith(today));
    const todayTotal = todaySales.reduce((sum, s) => sum + s.total, 0);
    console.log("Today's sales:", todaySales.length, "Total:", todayTotal);
    
    // ‚úÖ CURRENT MONTH (WITH BETTER DATE HANDLING)
    const now = new Date();
    const currentMonth = now.getMonth(); // 0 = January, 1 = February, etc.
    const currentYear = now.getFullYear();
    
    console.log("Current month/year:", (currentMonth + 1) + "/" + currentYear, 
                "(Month " + currentMonth + " = " + ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][currentMonth] + ")");
    
    // ‚úÖ FIXED: BETTER DATE FILTERING (CORRECTED)
const monthlySales = sales.filter(s => {
    try {
        // Extract just the date part (YYYY-MM-DD)
        const datePart = s.date.split('T')[0];
        const [year, month] = datePart.split('-').map(Number);
        
        // MONTH FIX: JavaScript months are 0-based (Jan=0), our dates are 1-based
        const saleMonth = month - 1; // Convert to 0-based
        
        // Compare year and month
        const matches = year === currentYear && saleMonth === currentMonth;
        
        // Debug logging - commented out for production
// if (matches && s.total > 0) {
//     console.log(`‚úÖ ${datePart}: MK ${s.total.toLocaleString()}`);
// }
        
        return matches;
    } catch (error) {
        console.error("Error parsing date:", s.date, error);
        return false;
    }
});
    
    // Get ONLY current month expenses (with same fix)
    const monthlyExpenses = expenses.filter(e => {
        try {
            const datePart = e.date.split('T')[0];
            const [year, month] = datePart.split('-').map(Number);
            return year === currentYear && (month - 1) === currentMonth;
        } catch (error) {
            return false;
        }
    });
    
    console.log("‚úÖ Monthly sales count:", monthlySales.length);
    console.log("‚úÖ Monthly expenses count:", monthlyExpenses.length);
    
    // Calculate current month sales total
    const monthSalesTotal = monthlySales.reduce((sum, sale) => sum + sale.total, 0);
    
    // Calculate current month profit
    let monthlyProfit = 0;
    monthlySales.forEach(sale => {
        sale.items?.forEach(item => {
            const product = products.find(p => p.id == item.productId);
            if (product && product.cost) {
                monthlyProfit += (item.price - product.cost) * item.quantity;
            }
        });
    });
    
    // Calculate current month expenses
    const totalExpenses = monthlyExpenses.reduce((sum, e) => sum + e.amount, 0);
    
    // Calculate net profit (sales profit - expenses)
    const netProfit = monthlyProfit - totalExpenses;
    
    console.log("‚úÖ Month Sales Total:", monthSalesTotal);
    console.log("‚úÖ Monthly Profit:", monthlyProfit);
    console.log("‚úÖ Monthly Expenses:", totalExpenses);
    console.log("‚úÖ Net Profit:", netProfit);
    console.log("=== END DEBUG ===");
    
    // ‚úÖ UPDATE DASHBOARD STATS
    document.getElementById('statProducts').textContent = products.length;
    document.getElementById('statLowStock').textContent = 
        products.filter(p => p.quantity <= (getShopSettings().lowStockThreshold || 5)).length + ' low stock';
    
    document.getElementById('statTodaySales').textContent = formatCurrency(todayTotal);
    document.getElementById('statTodayCount').textContent = todaySales.length + ' transactions';
    
    // ‚úÖ THESE NOW SHOW ONLY CURRENT MONTH!
    document.getElementById('statMonthSales').textContent = formatCurrency(monthSalesTotal);
    document.getElementById('statMonthlyProfit').textContent = formatCurrency(monthlyProfit);
    document.getElementById('statExpenses').textContent = formatCurrency(totalExpenses);
    document.getElementById('statNetProfit').textContent = formatCurrency(netProfit);
    
    loadAlerts();
    loadRecentActivity();
}
        
        function loadAlerts() {
            const products = getProducts();
            const settings = getShopSettings();
            const now = new Date();
            
            let alerts = [];
            
            products.forEach(product => {
                if (product.quantity <= (settings.lowStockThreshold || 5)) {
                    alerts.push({
                        type: 'warning',
                        message: `Low stock: ${product.name} (${product.quantity} left)`,
                        icon: '‚ö†Ô∏è'
                    });
                }
                
                if (product.expiryDate) {
                    const expiryDate = new Date(product.expiryDate);
                    const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntilExpiry <= (settings.expiryWarningDays || 7) && daysUntilExpiry >= 0) {
                        alerts.push({
                            type: 'danger',
                            message: `${product.name} expires in ${daysUntilExpiry} days`,
                            icon: '‚è∞'
                        });
                    } else if (daysUntilExpiry < 0) {
                        alerts.push({
                            type: 'danger',
                            message: `${product.name} has expired!`,
                            icon: '‚ùå'
                        });
                    }
                }
            });
            
            const container = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">‚úÖ</div>
                        <p>No active alerts</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = alerts.slice(0, 5).map(alert => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border-color);">
                    <span style="font-size: 1.2rem;">${alert.icon}</span>
                    <div style="flex: 1;">
                        <p style="margin: 0; color: var(--text-color);">${alert.message}</p>
                    </div>
                    <span class="badge badge-${alert.type}" style="font-size: 0.7rem;">
                        ${alert.type.toUpperCase()}
                    </span>
                </div>
            `).join('');
        }
        
        function loadRecentActivity() {
            const sales = getSales().slice(-5).reverse();
            const expenses = getExpenses().slice(-3).reverse();
            
            let activities = [];
            
            sales.forEach(sale => {
                const itemCount = sale.items?.reduce((sum, item) => sum + item.quantity, 0) || 0;
                activities.push({
                    type: 'sale',
                    message: `Sold ${itemCount} items`,
                    amount: sale.total,
                    date: new Date(sale.date),
                    icon: 'üí∞'
                });
            });
            
            expenses.forEach(expense => {
                activities.push({
                    type: 'expense',
                    message: expense.description || 'Expense',
                    amount: -expense.amount,
                    date: new Date(expense.date),
                    icon: 'üí∏'
                });
            });
            
            activities.sort((a, b) => b.date - a.date);
            
            const container = document.getElementById('recentActivity');
            
            if (activities.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>No recent activity</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = activities.slice(0, 5).map(activity => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid var(--border-color);">
                    <span style="font-size: 1.2rem;">${activity.icon}</span>
                    <div style="flex: 1;">
                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-color);">${activity.message}</p>
                        <small style="color: #666;">${formatTimeAgo(activity.date)}</small>
                    </div>
                    <span style="font-weight: bold; color: ${activity.amount >= 0 ? 'var(--success)' : 'var(--danger)'};">
                        ${activity.amount >= 0 ? '+' : ''}${formatCurrency(activity.amount)}
                    </span>
                </div>
            `).join('');
        }

        // ==================== ANALYTICS & REPORTS ====================
        function loadAnalytics() {
            loadRevenueExpensesChart();
            loadTopProductsChart();
            loadCategorySalesChart();
            loadDailyTrendChart();
            loadProfitAnalysis();
        }
        
        function setReportPeriod(period) {
            currentReportPeriod = period;
            loadAnalytics();
            
            document.querySelectorAll('#reports .btn-sm').forEach(btn => {
                btn.style.background = '';
                btn.style.color = '';
            });
            
            const activeBtn = Array.from(document.querySelectorAll('#reports .btn-sm'))
                .find(btn => btn.textContent.toLowerCase().includes(period));
            
            if (activeBtn) {
                activeBtn.style.background = 'var(--primary)';
                activeBtn.style.color = 'white';
            }
        }
        
        function loadCustomReport() {
            const fromDate = document.getElementById('customDateFrom').value;
            const toDate = document.getElementById('customDateTo').value;
            
            if (!fromDate || !toDate) {
                showNotification('Please select both dates!', 'warning');
                return;
            }
            
            currentReportPeriod = 'custom';
            loadAnalytics();
        }
        
        function loadRevenueExpensesChart() {
            const sales = getFilteredSales();
            const expenses = getFilteredExpenses();
            
            const salesTotal = sales.reduce((sum, s) => sum + s.total, 0);
            const expensesTotal = expenses.reduce((sum, e) => sum + e.amount, 0);
            const netProfit = salesTotal - expensesTotal;
            
            const max = Math.max(salesTotal, expensesTotal, Math.abs(netProfit));
            const salesPercent = max > 0 ? (salesTotal / max * 100) : 0;
            const expensesPercent = max > 0 ? (expensesTotal / max * 100) : 0;
            const profitPercent = max > 0 ? (Math.abs(netProfit) / max * 100) : 0;
            
            const container = document.getElementById('revenueExpensesChart');
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Revenue</span>
                        <span>${formatCurrency(salesTotal)}</span>
                    </div>
                    <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden;">
                        <div style="background: var(--success); height: 100%; width: ${salesPercent}%;"></div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Expenses</span>
                        <span>${formatCurrency(expensesTotal)}</span>
                    </div>
                    <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden;">
                        <div style="background: var(--danger); height: 100%; width: ${expensesPercent}%;"></div>
                    </div>
                </div>
                
                <div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Net Profit</span>
                        <span style="color: ${netProfit >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(netProfit)}</span>
                    </div>
                    <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden;">
                        <div style="background: ${netProfit >= 0 ? 'var(--success)' : 'var(--danger)'}; height: 100%; width: ${profitPercent}%;"></div>
                    </div>
                </div>
            `;
        }
        
        function loadTopProductsChart() {
            const sales = getFilteredSales();
            const productSales = {};
            
            sales.forEach(sale => {
                sale.items?.forEach(item => {
                    if (!productSales[item.productName]) {
                        productSales[item.productName] = { quantity: 0, revenue: 0 };
                    }
                    productSales[item.productName].quantity += item.quantity;
                    productSales[item.productName].revenue += item.total;
                });
            });
            
            const topProducts = Object.entries(productSales)
                 .sort((a, b) => b[1].revenue - a[1].revenue)
                 .slice(0, 8); // CHANGED FROM 5 TO 8
            
            const container = document.getElementById('topProductsChart');
            
            if (topProducts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No sales data</p>';
                return;
            }
            
            const maxRevenue = Math.max(...topProducts.map(([, data]) => data.revenue));
            
            container.innerHTML = topProducts.map(([name, data]) => {
                const percent = maxRevenue > 0 ? (data.revenue / maxRevenue * 100) : 0;
                
                return `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${name.substring(0, 20)}${name.length > 20 ? '...' : ''}</span>
                            <span>${formatCurrency(data.revenue)}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="background: #e2e8f0; height: 12px; border-radius: 6px; flex: 1; overflow: hidden;">
                                <div style="background: var(--primary); height: 100%; width: ${percent}%;"></div>
                            </div>
                            <small style="color: #666; min-width: 40px; text-align: right;">${data.quantity} sold</small>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function loadCategorySalesChart() {
            const sales = getFilteredSales();
            const categorySales = {};
            
            sales.forEach(sale => {
                sale.items?.forEach(item => {
                    const products = getProducts();
                    const product = products.find(p => p.id == item.productId);
                    const category = product?.category || 'uncategorized';
                    
                    if (!categorySales[category]) {
                        categorySales[category] = 0;
                    }
                    categorySales[category] += item.total;
                });
            });
            
            const categories = Object.entries(categorySales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);
            
            const container = document.getElementById('categorySalesChart');
            
            if (categories.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No category data</p>';
                return;
            }
            
            const total = categories.reduce((sum, [, amount]) => sum + amount, 0);
            
            container.innerHTML = categories.map(([category, amount]) => {
                const percentage = total > 0 ? (amount / total * 100).toFixed(1) : 0;
                
                return `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 8px; background: var(--light); border-radius: 8px;">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: ${getCategoryColor(category)};"></div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${category}</div>
                            <div style="font-size: 0.85rem; color: #666;">${percentage}% ‚Ä¢ ${formatCurrency(amount)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function loadDailyTrendChart() {
            const sales = getFilteredSales();
            const dailyTotals = {};
            
            sales.forEach(sale => {
                const date = sale.date.split('T')[0];
                if (!dailyTotals[date]) {
                    dailyTotals[date] = 0;
                }
                dailyTotals[date] += sale.total;
            });
            
            const days = Object.entries(dailyTotals)
                .map(([date, total]) => ({ date, total }))
                .sort((a, b) => a.date.localeCompare(b.date))
                .slice(-7);
            
            const container = document.getElementById('dailyTrendChart');
            
            if (days.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No daily data</p>';
                return;
            }
            
            const maxTotal = Math.max(...days.map(d => d.total));
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            container.innerHTML = `
                <div style="display: flex; align-items: flex-end; gap: 10px; height: 180px; padding: 20px 0;">
                    ${days.map(day => {
                        const date = new Date(day.date);
                        const dayName = dayNames[date.getDay()];
                        const percent = maxTotal > 0 ? (day.total / maxTotal * 100) : 0;
                        
                        return `
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%;">
                                <div style="margin-top: auto; background: var(--primary); width: 30px; border-radius: 6px 6px 0 0; height: ${percent}%; opacity: 0.7;"></div>
                                <div style="margin-top: 10px; font-size: 0.8rem; color: #666; text-align: center;">
                                    ${dayName}<br>
                                    <small>${formatCurrency(day.total)}</small>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function loadProfitAnalysis() {
            const sales = getFilteredSales();
            const expenses = getFilteredExpenses();
            const products = getProducts();
            
            let grossProfit = 0;
            sales.forEach(sale => {
                sale.items?.forEach(item => {
                    const product = products.find(p => p.id == item.productId);
                    if (product && product.cost) {
                        grossProfit += (item.price - product.cost) * item.quantity;
                    }
                });
            });
            
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            const netProfit = grossProfit - totalExpenses;
            const salesTotal = sales.reduce((sum, s) => sum + s.total, 0);
            const profitMargin = salesTotal > 0 ? (netProfit / salesTotal * 100) : 0;
            
            document.getElementById('grossProfit').textContent = formatCurrency(grossProfit);
            document.getElementById('totalExpensesReport').textContent = formatCurrency(totalExpenses);
            document.getElementById('netProfitReport').textContent = formatCurrency(netProfit);
            document.getElementById('profitMargin').textContent = profitMargin.toFixed(1) + '%';
        }
        
        function getFilteredSales() {
            const allSales = getSales();
            const now = new Date();
            
            switch(currentReportPeriod) {
                case 'today':
                    const today = now.toISOString().split('T')[0];
                    return allSales.filter(s => s.date.startsWith(today));
                    
                case 'week':
                    const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return allSales.filter(s => new Date(s.date) >= oneWeekAgo);
                    
                case 'month':
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    return allSales.filter(s => {
                        const saleDate = new Date(s.date);
                        return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                    });
                    
                case 'year':
                    const currentYearOnly = now.getFullYear();
                    return allSales.filter(s => new Date(s.date).getFullYear() === currentYearOnly);
                    
                case 'custom':
                    const fromDate = document.getElementById('customDateFrom').value;
                    const toDate = document.getElementById('customDateTo').value;
                    
                    if (fromDate && toDate) {
                        return allSales.filter(s => {
                            const saleDate = s.date.split('T')[0];
                            return saleDate >= fromDate && saleDate <= toDate;
                        });
                    }
                    return allSales;
                    
                default:
                    return allSales;
            }
        }
        
        function getFilteredExpenses() {
            const allExpenses = getExpenses();
            const now = new Date();
            
            switch(currentReportPeriod) {
                case 'today':
                    const today = now.toISOString().split('T')[0];
                    return allExpenses.filter(e => e.date.startsWith(today));
                    
                case 'week':
                    const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return allExpenses.filter(e => new Date(e.date) >= oneWeekAgo);
                    
                case 'month':
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    return allExpenses.filter(e => {
                        const expenseDate = new Date(e.date);
                        return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
                    });
                    
                case 'year':
                    const currentYearOnly = now.getFullYear();
                    return allExpenses.filter(e => new Date(e.date).getFullYear() === currentYearOnly);
                    
                case 'custom':
                    const fromDate = document.getElementById('customDateFrom').value;
                    const toDate = document.getElementById('customDateTo').value;
                    
                    if (fromDate && toDate) {
                        return allExpenses.filter(e => {
                            const expenseDate = e.date.split('T')[0];
                            return expenseDate >= fromDate && expenseDate <= toDate;
                        });
                    }
                    return allExpenses;
                    
                default:
                    return allExpenses;
            }
        }

        // ==================== SETTINGS ====================
       function loadSettings() {
    console.log("üîß Loading settings page...");
    
    try {
        const settings = getShopSettings();
        
        // Basic settings
        const shopNameInput = document.getElementById('shopName');
        if (shopNameInput) {
            shopNameInput.value = settings.shopName || 'ShopYanga';
        }
        
        // Load categories dropdowns
        updateCategoryDropdowns();
        
        // Update days counter
        const daysCounter = document.getElementById('daysCounterDisplay');
        if (daysCounter) {
            daysCounter.textContent = daysSinceReset || 0;
        }
        
        // ‚úÖ CRITICAL: Load customer activation UI
        console.log("Now loading customer activation UI...");
        setTimeout(() => {
            try {
                loadCustomerActivationUI();
                console.log("‚úÖ Customer activation UI loaded!");
            } catch (error) {
                console.error("‚ùå Failed to load activation UI:", error);
            }
        }, 100);
        
        console.log("‚úÖ Settings page loaded successfully");
        
    } catch (error) {
        console.error("‚ùå Error loading settings:", error);
    }
}
        
        function saveShopSettings() {
            const settings = {
                shopName: document.getElementById('shopName').value.trim() || 'ShopYanga',
                lowStockThreshold: parseInt(document.getElementById('lowStockThreshold').value) || 5,
                expiryWarningDays: parseInt(document.getElementById('expiryWarningDays').value) || 7
            };
            
            localStorage.setItem('shopYangaSettings', JSON.stringify(settings));
            showNotification('Settings saved successfully!', 'success');
        }
        
        function updateStorageUsage() {
    try {
        // Check if we're using 1GB storage system
        if (typeof updateStorageDisplay === 'function') {
            updateStorageDisplay();
        } else {
            // Fallback to localStorage calculation
            let totalSize = 0;
            const keys = [
                'shopYangaProducts',
                'shopYangaSales',
                'shopYangaExpenses',
                'shopYangaSettings',
                'shopYangaOwnerPassword',
                'shopYangaCurrentRole',
                'shopYangaTheme',
                'shopYangaCategories',
                'shopYangaSystemStartDate',
                'shopYangaDaysSinceReset',
                'shopYangaLastResetCode'
            ];
            
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    totalSize += new Blob([data]).size;
                }
            });
            
            const usedKB = (totalSize / 1024).toFixed(1);
            const usedPercent = (usedKB / (5 * 1024)) * 100;
            
            const storageBar = document.getElementById('storageBar');
            const storageUsed = document.getElementById('storageUsed');
            const storageTotal = document.getElementById('storageTotal');
            
            if (storageBar) storageBar.style.width = Math.min(usedPercent, 100) + '%';
            if (storageUsed) storageUsed.textContent = `${usedKB} KB used`;
            if (storageTotal) storageTotal.textContent = '5 MB available';
        }
        
    } catch (error) {
        console.log("Storage update error:", error);
    }
}
        
        function backupData() {
            const backup = {
                timestamp: new Date().toISOString(),
                products: getProducts(),
                sales: getSales(),
                expenses: getExpenses(),
                settings: getShopSettings(),
                categories: getCategories()
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shopyanga-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Backup created and downloaded!', 'success');
        }
        
        function exportAllData() {
            const allData = {
                exported: new Date().toISOString(),
                products: getProducts(),
                sales: getSales(),
                expenses: getExpenses(),
                settings: getShopSettings(),
                categories: getCategories()
            };
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shopyanga-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('All data exported!', 'success');
        }
        
        function showResetConfirmation() {
            if (confirm('‚ö†Ô∏è DANGER: This will delete ALL data!\n\nProducts, sales, expenses, everything!\n\nThis cannot be undone. Are you absolutely sure?')) {
                if (prompt('FINAL WARNING: Type "RESET SHOPYANGA" to confirm') === 'RESET SHOPYANGA') {
                    localStorage.clear();
                    ownerPassword = 'admin123';
                    currentUserRole = 'seller';
                    systemStartDate = null;
                    daysSinceReset = 0;
                    lastResetCode = '';
                    
                    initializeApp();
                    showNotification('All data has been reset!', 'danger');
                }
            }
        }

        // ==================== STORAGE DISPLAY FUNCTION ====================
function updateStorageDisplay() {
    // Do nothing - storage is always working
    // Or show simple static message
    document.getElementById('storageStatus').textContent = "1GB ‚úì";
    document.getElementById('storageBar').style.width = "10%";
    document.getElementById('storageUsed').textContent = "Active";
    document.getElementById('storageTotal').textContent = "1GB";
}

// Helper function for simple display
function showSimpleStorageDisplay() {
    document.getElementById('storageStatus').textContent = "1GB Storage Active";
    document.getElementById('storageBar').style.width = "15%";
    document.getElementById('storageUsed').textContent = "Unlimited storage available";
    document.getElementById('storageTotal').textContent = "1GB capacity";
    window.storageCheckCount = 0; // Reset counter
}

        async function loadAllDataFromIndexedDB() {
            if (!shopDB) return;
            
            const stores = ['products', 'sales', 'expenses', 'settings', 'categories'];
            
            for (const storeName of stores) {
                try {
                    const data = await loadFromIndexedDB(storeName);
                    if (data && data.length > 0) {
                        const localStorageKey = 'shopYanga' + storeName.charAt(0).toUpperCase() + storeName.slice(1);
                        
                        if (storeName === 'categories') {
                            // For categories, we need to extract the names
                            const categoryNames = data.map(item => item.name || item);
                            localStorage.setItem(localStorageKey, JSON.stringify(categoryNames));
                        } else {
                            localStorage.setItem(localStorageKey, JSON.stringify(data));
                        }
                        
                        console.log(`Loaded ${data.length} ${storeName} from IndexedDB`);
                    }
                } catch (error) {
                    console.log(`No ${storeName} in IndexedDB yet`);
                }
            }
        }

        function saveToIndexedDB(storeName, data) {
            if (!shopDB) return;
            
            return new Promise((resolve, reject) => {
                const transaction = shopDB.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                const clearRequest = store.clear();
                
                clearRequest.onsuccess = () => {
                    if (Array.isArray(data)) {
                        if (storeName === 'categories') {
                            // For categories, store as objects with id
                            data.forEach((category, index) => {
                                if (category) {
                                    store.add({
                                        id: index,
                                        name: category,
                                        timestamp: new Date().toISOString()
                                    });
                                }
                            });
                        } else {
                            data.forEach(item => {
                                if (item && item.id) {
                                    store.add(item);
                                }
                            });
                        }
                    }
                    resolve();
                };
                
                clearRequest.onerror = () => reject(clearRequest.error);
            });
        }

        function loadFromIndexedDB(storeName) {
            if (!shopDB) return Promise.resolve([]);
            
            return new Promise((resolve, reject) => {
                const transaction = shopDB.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        // Products
        function saveProducts(products) {
            localStorage.setItem('shopYangaProducts', JSON.stringify(products));
            saveToIndexedDB('products', products);
            if (isOnline && syncEnabled && document.getElementById('syncOnDataChange')?.checked) {
        setTimeout(syncAllDataToFirebase, 1000);
    }
        }

        function getProducts() {
            return JSON.parse(localStorage.getItem('shopYangaProducts') || '[]');
        }

        // Sales
        function saveSales(sales) {
            localStorage.setItem('shopYangaSales', JSON.stringify(sales));
            saveToIndexedDB('sales', sales);
             if (isOnline && syncEnabled && document.getElementById('syncOnDataChange')?.checked) {
        setTimeout(syncAllDataToFirebase, 1000);
    }
        }

        function getSales() {
            return JSON.parse(localStorage.getItem('shopYangaSales') || '[]');
        }

        // Expenses
        function saveExpenses(expenses) {
            localStorage.setItem('shopYangaExpenses', JSON.stringify(expenses));
            saveToIndexedDB('expenses', expenses);
        if (isOnline && syncEnabled && document.getElementById('syncOnDataChange')?.checked) {
        setTimeout(syncAllDataToFirebase, 1000);
    }
        }

        function getExpenses() {
            return JSON.parse(localStorage.getItem('shopYangaExpenses') || '[]');
        }

        // Settings
        function saveShopSettings(settings) {
            localStorage.setItem('shopYangaSettings', JSON.stringify(settings));
            saveToIndexedDB('settings', [settings]);
        }

        function getShopSettings() {
            const settings = JSON.parse(localStorage.getItem('shopYangaSettings') || '{}');
            
            if (!settings.shopName) {
                settings.shopName = 'ShopYanga';
                settings.lowStockThreshold = 5;
                settings.expiryWarningDays = 7;
            }
            
            return settings;
        }

        // ==================== PERSISTENT LICENSE STORAGE ====================
        function getPersistentLicense() {
            const keys = [
                'sy_pro_license',
                'sy_anchor_code',
                'sy_system_init'
            ];
            
            for (const key of keys) {
                try {
                    const value = localStorage.getItem(key);
                    if (value) return JSON.parse(value);
                } catch (e) {}
            }
            
            const existingStart = localStorage.getItem('shopYangaSystemStartDate');
            if (existingStart) {
                return {
                    initialized: true,
                    firstLaunch: false,
                    startDate: existingStart,
                    licenseType: 'legacy'
                };
            }
            
            return null;
        }
        
        function savePersistentLicense(licenseData) {
            const licenseKeys = ['sy_pro_license', 'sy_anchor_code', 'sy_system_init'];
            licenseKeys.forEach(key => {
                try {
                    localStorage.setItem(key, JSON.stringify({
                        ...licenseData,
                        timestamp: Date.now(),
                        deviceId: generateDeviceId()
                    }));
                } catch (e) {}
            });
            
            if (shopDB) {
                saveToIndexedDB('license', [licenseData]);
            }
        }
        
        function generateDeviceId() {
            let deviceId = localStorage.getItem('sy_device_id');
            if (!deviceId) {
                deviceId = 'DEV_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('sy_device_id', deviceId);
            }
            return deviceId;
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatCurrency(amount) {
            if (isNaN(amount)) amount = 0;
            return `MK ${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        
        function formatDate(date) {
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 60) {
                return `${diffMins} min ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hr ago`;
            } else if (diffDays < 7) {
                return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            } else {
                return formatDate(date);
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span style="font-size: 1.5rem;">${getNotificationIcon(type)}</span>
                <div style="flex: 1;">
                    <p style="margin: 0; font-weight: 500;">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #666; padding: 0 5px;">
                    √ó
                </button>
            `;
            
            const container = document.getElementById('notificationArea');
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        function getNotificationIcon(type) {
            const icons = {
                'success': '‚úÖ',
                'warning': '‚ö†Ô∏è',
                'danger': '‚ùå',
                'info': '‚ÑπÔ∏è'
            };
            return icons[type] || 'üì¢';
        }
        
        function setupEventListeners() {
            document.getElementById('productModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            document.getElementById('expenseModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeExpenseModal();
                }
            });
            
            document.getElementById('productSearchModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeProductSearchModal();
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    closeExpenseModal();
                    closeProductSearchModal();
                    document.getElementById('securityModal').style.display = 'none';
                    document.getElementById('changePasswordModal').style.display = 'none';
                    document.getElementById('excelBackupModal').style.display = 'none';
                    document.getElementById('categoriesModal').style.display = 'none';
                    document.getElementById('confirmModal').style.display = 'none';
                }
            });
            
            document.getElementById('productSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchProducts();
                }
            });
        }

        // ==================== TAB NAVIGATION ====================
        function showTab(tabId) {
    console.log(`üì± Switching to tab: ${tabId}`);
    
    try {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Remove active from all tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected section
        const targetSection = document.getElementById(tabId);
        if (targetSection) {
            targetSection.classList.add('active');
        } else {
            console.error(`Tab section not found: ${tabId}`);
            return;
        }
        
        // Activate selected tab button
        const tabs = {
            'dashboard': 'üìä Dashboard',
            'inventory': 'üì¶ Inventory',
            'sales': 'üí∞ Sales',
            'expenses': 'üí∏ Expenses',
            'reports': 'üìà Analytics',
            'settings': '‚öôÔ∏è Settings'
        };
        
        document.querySelectorAll('.tab').forEach(tab => {
            if (tab.textContent === tabs[tabId]) {
                tab.classList.add('active');
            }
        });
        
        // Load content for the tab
        switch(tabId) {
            case 'dashboard':
                console.log("Loading dashboard...");
                try {
                    loadDashboard();
                } catch (error) {
                    console.error("Error loading dashboard:", error);
                }
                break;
                
            case 'inventory':
                try {
                    loadInventoryTable();
                } catch (error) {
                    console.error("Error loading inventory:", error);
                }
                break;
                
            case 'sales':
                try {
                    loadSalesHistory();
                } catch (error) {
                    console.error("Error loading sales:", error);
                }
                break;
                
            case 'expenses':
                try {
                    loadExpensesTable();
                } catch (error) {
                    console.error("Error loading expenses:", error);
                }
                break;
                
            case 'reports':
                try {
                    loadAnalytics();
                } catch (error) {
                    console.error("Error loading reports:", error);
                }
                break;
                
            case 'settings':
                console.log("Loading settings with activation portal...");
                try {
                    loadSettings();
                } catch (error) {
                    console.error("Error loading settings:", error);
                }
                
                // Small delay to ensure DOM is ready for activation portal
                setTimeout(() => {
                    console.log("Calling loadCustomerActivationUI()...");
                    try {
                        loadCustomerActivationUI();
                    } catch (error) {
                        console.error("Error loading activation UI:", error);
                    }
                }, 100);
                break;
                
            default:
                console.error(`Unknown tab: ${tabId}`);
        }
        
    } catch (error) {
        console.error("Error switching tabs:", error);
    }
}

function showTab(tabId) {
    console.log(`üì± Switching to tab: ${tabId}`);
    
    try {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Remove active from all tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected section
        const targetSection = document.getElementById(tabId);
        if (targetSection) {
            targetSection.classList.add('active');
        } else {
            console.error(`Tab section not found: ${tabId}`);
            return;
        }
        
        // Activate selected tab button
        const tabs = {
            'dashboard': 'üìä Dashboard',
            'inventory': 'üì¶ Inventory',
            'sales': 'üí∞ Sales',
            'expenses': 'üí∏ Expenses',
            'reports': 'üìà Analytics',
            'settings': '‚öôÔ∏è Settings'
        };
        
        document.querySelectorAll('.tab').forEach(tab => {
            if (tab.textContent === tabs[tabId]) {
                tab.classList.add('active');
            }
        });
        
        // Load content for the tab
        switch(tabId) {
            case 'dashboard':
                console.log("Loading dashboard...");
                try {
                    loadDashboard();
                } catch (error) {
                    console.error("Error loading dashboard:", error);
                }
                break;
                
            case 'inventory':
                try {
                    loadInventoryTable();
                } catch (error) {
                    console.error("Error loading inventory:", error);
                }
                break;
                
            case 'sales':
                try {
                    loadSalesHistory();
                } catch (error) {
                    console.error("Error loading sales:", error);
                }
                break;
                
            case 'expenses':
                try {
                    loadExpensesTable();
                } catch (error) {
                    console.error("Error loading expenses:", error);
                }
                break;
                
            case 'reports':
                try {
                    loadAnalytics();
                } catch (error) {
                    console.error("Error loading reports:", error);
                }
                break;
                
            case 'settings':
                console.log("Loading settings with activation portal...");
                try {
                    loadSettings();
                } catch (error) {
                    console.error("Error loading settings:", error);
                }
                
                // Small delay to ensure DOM is ready for activation portal
                setTimeout(() => {
                    console.log("Calling loadCustomerActivationUI()...");
                    try {
                        loadCustomerActivationUI();
                    } catch (error) {
                        console.error("Error loading activation UI:", error);
                    }
                }, 100);
                break;
                
            default:
                console.error(`Unknown tab: ${tabId}`);
        }
        
    } catch (error) {
        console.error("Error switching tabs:", error);
    }
}



        // ==================== INITIALIZATION ====================
        function initializeStorage() {
            if (!localStorage.getItem('shopYangaSettings')) {
                localStorage.setItem('shopYangaSettings', JSON.stringify({
                    shopName: 'ShopYanga',
                    lowStockThreshold: 5,
                    expiryWarningDays: 7
                }));
            }
            
            const defaults = {
                shopYangaProducts: [],
                shopYangaSales: [],
                shopYangaExpenses: [],
                shopYangaCategories: []
            };
            
            for (const [key, value] of Object.entries(defaults)) {
                if (!localStorage.getItem(key)) {
                    localStorage.setItem(key, JSON.stringify(value));
                }
            }
            
            // Initialize default categories if none exist
            loadDefaultCategories();
        }
        
        function initializeAppAfterLicenseCheck() {
            loadSecuritySettings();
            addDeveloperSecretPanel();
            
            loadDashboard();
            loadInventoryTable();
            loadExpensesTable();
            loadSalesHistory();
            loadAnalytics();
            setupEventListeners();
            
            updateFooterWarning(daysSinceReset);
            
            const daysLeft = 34 - daysSinceReset;
            if (daysLeft <= 7) {
                showNotification(`‚ö†Ô∏è Time ends in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}! Contact ${developerCompany} to renew.`, 'warning');
            } else {
                showNotification(`‚úÖ Shop Yanga PRO Active! ${daysLeft} Days remaining.`, 'success');
            }
        }
        
        async function initializeApp() {
    console.log("üöÄ Shop Yanga Manager PRO with 1GB Storage");
    
    // Load theme (day/night mode)
    loadTheme();
    
    // Initialize storage system (1GB or fallback)
    await initializeStorage();
    
    // Check 34-day rental system
    const isLocked = initialize34DaySystem();
    
    if (isLocked) {
        console.log('System locked - waiting for activation/renewal');
        return;
    }
    
    console.log('System active - continuing initialization');
    
    // Load security settings
    loadSecuritySettings();
    
    // Add developer secret panel
    addDeveloperSecretPanel();
    
    // Initialize PWA (will handle local file detection)
    initializePWA();
    
    // Initialize Firebase sync system
    setupAutoSync();
    
    // Initialize remote monitoring
    initRemoteMonitoring();
    
    // Generate owner code
    if (!localStorage.getItem('shopYangaOwnerCode')) {
        const code = 'OWNER-' + Date.now().toString(36).toUpperCase().slice(-6);
        localStorage.setItem('shopYangaOwnerCode', code);
        console.log('Generated owner code:', code);
    }
    
    // Load all data views
    loadDashboard();
    loadInventoryTable();
    loadExpensesTable();
    loadSalesHistory();
    loadAnalytics();
    
    // Setup event listeners
    setupEventListeners();
    
    // Load customer activation UI
    loadCustomerActivationUI();
    
    // Update footer warning
    updateFooterWarning(daysSinceReset);
    
    // Show notification based on days left
    const daysLeft = 34 - daysSinceReset;
    if (daysLeft <= 7) {
        showNotification(`‚ö†Ô∏è Time ends in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}! Contact ${developerCompany} to renew.`, 'warning');
    } else {
        showNotification(`‚úÖ Shop Yanga PRO Active! ${daysLeft} Days remaining. 1GB Storage Enabled.`, 'success');
    }
    
    // Initial storage check
    setTimeout(() => updateStorageDisplay(), 1000);
    
    console.log('‚úÖ App initialization complete!');
}

        // ==================== PWA SERVICE WORKER ====================
        function initializePWA() {
            console.log('üì± Initializing PWA features...');
            
            const isPwaSupported = 'serviceWorker' in navigator && ('PushManager' in window || 'beforeinstallprompt' in window);
            
            if (isPwaSupported) {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('‚úÖ Service Worker registered:', registration.scope);
                            
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                console.log('üîÑ Service Worker update found!');
                                
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        showNotification('üì± New version available! Refresh to update.', 'info');
                                    }
                                });
                            });
                        })
                        .catch(error => {
                            console.log('‚ÑπÔ∏è Service Worker registration failed:', error.message);
                        });
                }
                
                let deferredPrompt;
                const installButton = document.getElementById('installButton');
                
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    
                    setTimeout(() => {
                        if (installButton) {
                            installButton.style.display = 'flex';
                        }
                    }, 3000);
                    
                    if (installButton) {
                        installButton.onclick = function() {
                            if (deferredPrompt) {
                                deferredPrompt.prompt();
                                deferredPrompt.userChoice.then(choiceResult => {
                                    if (choiceResult.outcome === 'accepted') {
                                        console.log('‚úÖ User installed the PWA');
                                        showNotification('üéâ ShopYanga installed!', 'success');
                                    }
                                    deferredPrompt = null;
                                    installButton.style.display = 'none';
                                });
                            }
                        };
                    }
                });
                
                window.matchMedia('(display-mode: standalone)').addListener(e => {
                    if (e.matches) {
                        console.log('üì± App running in standalone mode');
                        if (installButton) installButton.style.display = 'none';
                    }
                });
            }
        }

        // ==================== AUTOMATIC REMINDERS ====================
        function checkAndSendReminders() {
            const daysLeft = 34 - daysSinceReset;
            
            if (daysLeft === 7 || daysLeft === 3 || daysLeft === 1) {
                const shopName = getShopSettings().shopName || 'ShopYanga';
                const message = `‚ö†Ô∏è SHOPYANGA RENTAL REMINDER ‚ö†Ô∏è

Shop: ${shopName}
Days left: ${daysLeft}
Expiry date: ${new Date(new Date(systemStartDate).getTime() + (34 * 24 * 60 * 60 * 1000)).toLocaleDateString()}

Contact ${developerCompany} to renew before system locks!`;

                if (daysLeft === 1 && navigator.share) {
                    try {
                        navigator.share({
                            title: 'ShopYanga Rental Expiring Soon!',
                            text: message
                        });
                    } catch (e) {
                        console.log('Share API not supported');
                    }
                }
                
                showNotification(`Rental ends in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}! Contact ${developerCompany}.`, 'warning');
            }
        }

        // Set up daily reminder check
        setInterval(checkAndSendReminders, 24 * 60 * 60 * 1000);

          // ==================== START EVERYTHING ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üöÄ Shop Yanga Manager PRO with 1GB Storage Initializing...");
            
            initializePWA();
            initializeApp();
        });

        function applyDateFilterInstantly() {
            console.log("üî• Applying date filter INSTANTLY!");
            
            // Reset to page 1
            currentSalesPage = 1;
            
            // Show loading animation
            const table = document.getElementById('salesTable');
            if (table) {
                table.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div class="spinner"></div>
                        <p>Filtering sales...</p>
                    </div>
                `;
            }
            
            // Load sales with new filter (with small delay)
            setTimeout(() => {
                loadSalesHistory();
            }, 100);
        }
        
        function clearDateFilters() {
            console.log("üóëÔ∏è Clearing date filters!");
            
            document.getElementById('salesDateFrom').value = '';
            document.getElementById('salesDateTo').value = '';
            document.getElementById('salesFilter').value = 'all';
            currentSalesPage = 1;
            
            // Show loading animation
            const table = document.getElementById('salesTable');
            if (table) {
                table.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div class="spinner"></div>
                        <p>Loading all sales...</p>
                    </div>
                `;
            }
            
            // Load after small delay
            setTimeout(() => {
                loadSalesHistory();
            }, 100);
            
            showNotification('Date filters cleared!', 'info');
        }

        // ==================== QUICK FIX: REMOTE FUNCTIONS ====================
function showQRCode() {
    const shopId = getShopId ? getShopId() : 'NO-SHOP-ID';
    const ownerCode = localStorage.getItem('shopYangaOwnerCode') || 'NOCODE';
    const url = `https://shopyanga-dashboard.web.app/?shop=${shopId}&code=${ownerCode}`;
    
    // Create modal if it doesn't exist
    if (!document.getElementById('qrModal')) {
        const modal = document.createElement('div');
        modal.id = 'qrModal';
        modal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;';
        modal.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3>Scan to View Remotely</h3>
                <div id="qrCodeContainer" style="margin: 20px; padding: 20px; background: white;"></div>
                <button class="btn btn-danger" onclick="document.getElementById('qrModal').style.display='none'">Close</button>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Generate QR code
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
    document.getElementById('qrCodeContainer').innerHTML = `<img src="${qrUrl}" alt="QR Code" style="width: 200px; height: 200px;">`;
    
    // Show modal
    document.getElementById('qrModal').style.display = 'flex';
    showNotification('QR Code Generated!', 'success');
}

function copyDashboardURL() {
    const shopId = getShopId ? getShopId() : 'NO-SHOP-ID';
    const ownerCode = localStorage.getItem('shopYangaOwnerCode') || 'NOCODE';
    const url = `https://shopyanga-dashboard.web.app/?shop=${shopId}&code=${ownerCode}`;
    
    navigator.clipboard.writeText(url).then(() => {
        showNotification('Dashboard URL copied!', 'success');
    }).catch(() => {
        // Fallback
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('URL copied to clipboard!', 'success');
    });
}

// Initialize remote monitoring
function initRemoteMonitoring() {
    // Generate shop ID if not exists
    if (!localStorage.getItem('shopYangaShopId')) {
        const deviceId = getCustomerDeviceId();
        const shopId = 'SHOP-' + deviceId.replace('DEV-', '').substring(0, 12).toUpperCase();
        localStorage.setItem('shopYangaShopId', shopId);
    }
    
    // Generate owner code if not exists
    if (!localStorage.getItem('shopYangaOwnerCode')) {
        const code = 'OWNER-' + Date.now().toString(36).toUpperCase().slice(-6);
        localStorage.setItem('shopYangaOwnerCode', code);
    }
    
    // Update URL display
    const urlElement = document.getElementById('ownerDashboardURL');
    if (urlElement) {
        const shopId = localStorage.getItem('shopYangaShopId');
        const ownerCode = localStorage.getItem('shopYangaOwnerCode');
        urlElement.textContent = `https://shopyanga-dashboard.web.app/?shop=${shopId}&code=${ownerCode}`;
    }
    
    console.log('‚úÖ Remote monitoring initialized!');
}
// ==================== END QUICK FIX ====================

    </script>
</body>
</html>